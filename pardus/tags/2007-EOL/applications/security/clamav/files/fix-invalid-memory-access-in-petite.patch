--- libclamav/petite.c.orig	2008-06-16 19:27:08.000000000 +0300
+++ libclamav/petite.c	2008-06-16 19:35:31.000000000 +0300
@@ -265,6 +265,7 @@
       uint32_t check1, check2;
       uint8_t mydl = 0;
       uint8_t goback;
+      unsigned int q;
       
       /* Unpak each original section in turn */
 
@@ -312,16 +313,19 @@
        * (eg the icon): let's fix the rva
        */
 
-      if (!check4resources) {
-	unsigned int q;
 	for ( q = 0 ; q < sectcount ; q++ ) {
-	  if ( thisrva <= sections[q].rva || thisrva >= sections[q].rva + sections[q].vsz)
+      if(!CLI_ISCONTAINED(sections[q].rva, sections[q].vsz, usects[j].rva, usects[j].vsz))
 	    continue;
+      if (!check4resources) {
 	  usects[j].rva = sections[q].rva;
 	  usects[j].rsz = thisrva - sections[q].rva + size;
+      }
 	  break;
 	}
-      }
+     if(q == sectcount) {
+         free(usects);
+         return 1;
+     }
 
       /* Increase count of unpacked sections */
       j++;
