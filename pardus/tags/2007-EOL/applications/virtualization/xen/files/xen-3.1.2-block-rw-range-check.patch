diff -rup xen-3.1.2-src.orig/tools/ioemu/block.c xen-3.1.2-src.new/tools/ioemu/block.c
--- xen-3.1.2-src.orig/tools/ioemu/block.c	2007-11-14 18:35:27.000000000 -0500
+++ xen-3.1.2-src.new/tools/ioemu/block.c	2008-02-23 11:44:00.000000000 -0500
@@ -109,6 +109,15 @@ kern_return_t GetBSDPath( io_iterator_t 
 
 #endif
 
+static int bdrv_rw_badreq_sectors(BlockDriverState *bs,
+				int64_t sector_num, int nb_sectors)
+{
+    return
+	nb_sectors < 0 ||
+	nb_sectors > bs->total_sectors ||
+	sector_num > bs->total_sectors - nb_sectors;
+}
+
 void bdrv_register(BlockDriver *bdrv)
 {
     bdrv->next = first_drv;
@@ -307,6 +316,7 @@ int bdrv_open2(BlockDriverState *bs, con
     }
     bs->drv = drv;
     bs->opaque = qemu_mallocz(drv->instance_size);
+    bs->total_sectors = 0; /* driver will set if it does not do getlength */
     if (bs->opaque == NULL && drv->instance_size > 0)
         return -1;
     
@@ -356,6 +366,7 @@ void bdrv_close(BlockDriverState *bs)
         bs->opaque = NULL;
         bs->drv = NULL;
         bs->inserted = 0;
+	bs->total_sectors = 0;
 
         /* call the change callback */
         if (bs->change_cb)
@@ -420,8 +431,8 @@ int bdrv_read(BlockDriverState *bs, int6
 
     if (!bs->inserted)
         return -1;
-    if (sector_num < 0)
-	return -1;
+    if (bdrv_rw_badreq_sectors(bs, sector_num, nb_sectors))
+	return -EDOM;
 
     while (nb_sectors > 0) {
         if (sector_num == 0 && bs->boot_sector_enabled) {
@@ -460,8 +471,8 @@ int bdrv_write(BlockDriverState *bs, int
         return -1;
     if (bs->read_only)
         return -1;
-    if (sector_num < 0)
-	return -1;
+    if (bdrv_rw_badreq_sectors(bs, sector_num, nb_sectors))
+	return -EDOM;
     if (sector_num == 0 && bs->boot_sector_enabled && nb_sectors > 0) {
         memcpy(bs->boot_sector_data, buf, 512);   
     }
