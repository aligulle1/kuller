--- lfo.c	2005-04-17 23:16:58.000000000 +0200
+++ lfo.c	2006-10-20 03:48:47.000000000 +0200
@@ -32,6 +32,16 @@
 followed by its corresponding LVL structure (if LFOLVL.fFormatting is set).
 */
 
+static int
+multiplication_will_overflow(U32 a, U32 b)
+{
+  if((a > 0) && (b > 0) && (G_MAXUINT / a) >= b) {
+    return 0;
+  }
+
+  return 1;
+}
+
 int
 wvGetLFO_records (LFO ** lfo, LFOLVL ** lfolvl, LVL ** lvl, U32 * nolfo,
 		  U32 * nooflvl, U32 offset, U32 len, wvStream * fd)
@@ -49,7 +59,9 @@
     wvTrace (("pos %x %d\n", wvStream_tell (fd), *nooflvl));
     wvTrace (("nolfo is %d nooflvl is %d\n", *nolfo, *nooflvl));
 
-    if (*nooflvl == 0)
+    if ((*nooflvl == 0) ||
+	multiplication_will_overflow(sizeof (LFOLVL), *nooflvl) ||
+	multiplication_will_overflow(sizeof (LVL), *nooflvl))
       {
 	  *lfolvl = NULL;
 	  *lvl = NULL;
@@ -101,17 +113,23 @@
 	  *nolfo = read_32ubit (fd);
 	  wvTrace (("%d\n", *nolfo));
 
-	  *lfo = (LFO *) wvMalloc (*nolfo * sizeof (LFO));
+	  /* check for integer overflow */
+	  if (multiplication_will_overflow(*nolfo, sizeof(LFO))) {
+	    wvError (("Malicious document!\n"));			
+	    *nolfo = 0;
+	    return (1);
+	  } else {
+	    *lfo = (LFO *) wvMalloc (*nolfo * sizeof(LFO));
 	  if (*lfo == NULL)
 	    {
-		wvError (
-			 ("NO MEM 1, failed to alloc %d bytes\n",
+		wvError (("NO MEM 1, failed to alloc %d bytes\n",
 			  *nolfo * sizeof (LFO)));
 		return (1);
 	    }
 	  for (i = 0; i < *nolfo; i++)
 	      wvGetLFO (&((*lfo)[i]), fd);
       }
+      }
     return (0);
 }
 
--- wvConfig.c  18 Apr 2005 21:14:48 -0000      1.70
+++ wvConfig.c  25 Oct 2006 11:55:04 -0000      1.71
@@ -3682,7 +3682,8 @@
 void
 wvBeginDocument (expand_data * data)
 {
-    if ((data->sd != NULL) && (data->sd->elements[TT_DOCUMENT].str[0] != NULL))
+    if ((data->sd) && (data->sd->elements[TT_DOCUMENT].str)
+       && (data->sd->elements[TT_DOCUMENT].str[0] != NULL))
       {
          wvTrace (("doc begin is %s", data->sd->elements[TT_DOCUMENT].str[0]));
          wvExpand (data, data->sd->elements[TT_DOCUMENT].str[0],
@@ -3708,7 +3709,8 @@
     data->props = (void *) &apap;
     wvEndPara (data);
 
-    if ((data->sd != NULL) && (data->sd->elements[TT_DOCUMENT].str[1] != NULL))
+    if ((data->sd) && (data->sd->elements[TT_DOCUMENT].str)
+       && (data->sd->elements[TT_DOCUMENT].str[1] != NULL))
       {
          wvExpand (data, data->sd->elements[TT_DOCUMENT].str[1],
                    strlen (data->sd->elements[TT_DOCUMENT].str[1]));

