--- trunk/plug-ins/common/xwd.c	2007/07/04 17:48:25	22864
+++ trunk/plug-ins/common/xwd.c	2007/07/04 23:32:15	22865
@@ -470,6 +470,39 @@
         }
     }
 
+  if (xwdhdr.l_pixmap_width <= 0)
+    {
+      g_message (_("'%s':\nNo image width specified"),
+                 gimp_filename_to_utf8 (filename));
+      fclose (ifp);
+      return (-1);
+    }
+
+  if (xwdhdr.l_pixmap_width > GIMP_MAX_IMAGE_SIZE
+      || xwdhdr.l_bytes_per_line > GIMP_MAX_IMAGE_SIZE * 3)
+    {
+      g_message (_("'%s':\nImage width is larger than GIMP can handle"),
+                 gimp_filename_to_utf8 (filename));
+      fclose (ifp);
+      return (-1);
+    }
+
+  if (xwdhdr.l_pixmap_height <= 0)
+    {
+      g_message (_("'%s':\nNo image height specified"),
+                 gimp_filename_to_utf8 (filename));
+      fclose (ifp);
+      return (-1);
+    }
+
+  if (xwdhdr.l_pixmap_height > GIMP_MAX_IMAGE_SIZE)
+    {
+      g_message (_("'%s':\nImage height is larger than GIMP can handle"),
+                 gimp_filename_to_utf8 (filename));
+      fclose (ifp);
+      return (-1);
+    }
+
   gimp_progress_init_printf (_("Opening '%s'"),
                              gimp_filename_to_utf8 (filename));
 
