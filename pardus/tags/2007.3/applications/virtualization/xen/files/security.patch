diff -ur xen-3.0.4_1-src.orig/tools/ioemu/hw/cirrus_vga.c xen-3.0.4_1-src/tools/ioemu/hw/cirrus_vga.c
--- xen-3.0.4_1-src.orig/tools/ioemu/hw/cirrus_vga.c	2007-01-08 17:00:48.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/hw/cirrus_vga.c	2007-05-01 15:58:51.480666729 +0300
@@ -220,6 +220,20 @@
 #define CIRRUS_HOOK_NOT_HANDLED 0
 #define CIRRUS_HOOK_HANDLED 1
 
+#define BLTUNSAFE(s) \
+    ( \
+        ( /* check dst is within bounds */ \
+            (s)->cirrus_blt_height * (s)->cirrus_blt_dstpitch \
+                + ((s)->cirrus_blt_dstaddr & (s)->cirrus_addr_mask) > \
+                    (s)->vram_size \
+        ) || \
+        ( /* check src is within bounds */ \
+            (s)->cirrus_blt_height * (s)->cirrus_blt_srcpitch \
+                + ((s)->cirrus_blt_srcaddr & (s)->cirrus_addr_mask) > \
+                    (s)->vram_size \
+        ) \
+    )
+
 struct CirrusVGAState;
 typedef void (*cirrus_bitblt_rop_t) (struct CirrusVGAState *s,
                                      uint8_t * dst, const uint8_t * src,
@@ -598,7 +612,7 @@
 
     for (y = 0; y < lines; y++) {
 	off_cur = off_begin;
-	off_cur_end = off_cur + bytesperline;
+	off_cur_end = (off_cur + bytesperline) & s->cirrus_addr_mask;
 	off_cur &= TARGET_PAGE_MASK;
 	while (off_cur < off_cur_end) {
 	    cpu_physical_memory_set_dirty(s->vram_offset + off_cur);
@@ -613,7 +627,11 @@
 {
     uint8_t *dst;
 
-    dst = s->vram_ptr + s->cirrus_blt_dstaddr;
+    dst = s->vram_ptr + (s->cirrus_blt_dstaddr & s->cirrus_addr_mask);
+    
+    if (BLTUNSAFE(s))
+        return 0;
+
     (*s->cirrus_rop) (s, dst, src,
                       s->cirrus_blt_dstpitch, 0, 
                       s->cirrus_blt_width, s->cirrus_blt_height);
@@ -629,8 +647,11 @@
 {
     cirrus_fill_t rop_func;
 
+    if (BLTUNSAFE(s))
+        return 0;
+
     rop_func = cirrus_fill[rop_to_index[blt_rop]][s->cirrus_blt_pixelwidth - 1];
-    rop_func(s, s->vram_ptr + s->cirrus_blt_dstaddr, 
+    rop_func(s, s->vram_ptr + (s->cirrus_blt_dstaddr & s->cirrus_addr_mask), 
              s->cirrus_blt_dstpitch,
              s->cirrus_blt_width, s->cirrus_blt_height);
     cirrus_invalidate_region(s, s->cirrus_blt_dstaddr,
@@ -649,8 +670,8 @@
 static int cirrus_bitblt_videotovideo_patterncopy(CirrusVGAState * s)
 {
     return cirrus_bitblt_common_patterncopy(s,
-					    s->vram_ptr + 
-                                            (s->cirrus_blt_srcaddr & ~7));
+					    s->vram_ptr + ((s->cirrus_blt_srcaddr & ~7) & 
+                        s->cirrus_addr_mask));
 }
 
 static void cirrus_do_copy(CirrusVGAState *s, int dst, int src, int w, int h)
@@ -700,8 +721,10 @@
     if (notify)
 	vga_hw_update();
 
-    (*s->cirrus_rop) (s, s->vram_ptr + s->cirrus_blt_dstaddr,
-		      s->vram_ptr + s->cirrus_blt_srcaddr,
+    (*s->cirrus_rop) (s, s->vram_ptr + 
+                (s->cirrus_blt_dstaddr & s->cirrus_addr_mask),
+		      s->vram_ptr + 
+                (s->cirrus_blt_srcaddr & s->cirrus_addr_mask),
 		      s->cirrus_blt_dstpitch, s->cirrus_blt_srcpitch,
 		      s->cirrus_blt_width, s->cirrus_blt_height);
 
@@ -727,8 +750,14 @@
 		       s->cirrus_blt_srcaddr - s->start_addr,
 		       s->cirrus_blt_width, s->cirrus_blt_height);
     } else {
-	(*s->cirrus_rop) (s, s->vram_ptr + s->cirrus_blt_dstaddr,
-			  s->vram_ptr + s->cirrus_blt_srcaddr,
+
+    if (BLTUNSAFE(s))
+        return 0;
+
+	(*s->cirrus_rop) (s, s->vram_ptr + 
+                (s->cirrus_blt_dstaddr & s->cirrus_addr_mask),
+			  s->vram_ptr + 
+                (s->cirrus_blt_srcaddr & s->cirrus_addr_mask),
 			  s->cirrus_blt_dstpitch, s->cirrus_blt_srcpitch,
 			  s->cirrus_blt_width, s->cirrus_blt_height);
 
@@ -760,8 +789,9 @@
         } else {
             /* at least one scan line */
             do {
-                (*s->cirrus_rop)(s, s->vram_ptr + s->cirrus_blt_dstaddr,
-                                 s->cirrus_bltbuf, 0, 0, s->cirrus_blt_width, 1);
+                (*s->cirrus_rop)(s, s->vram_ptr + 
+                    (s->cirrus_blt_dstaddr & s->cirrus_addr_mask),
+                        s->cirrus_bltbuf, 0, 0, s->cirrus_blt_width, 1);
                 cirrus_invalidate_region(s, s->cirrus_blt_dstaddr, 0,
                                          s->cirrus_blt_width, 1);
                 s->cirrus_blt_dstaddr += s->cirrus_blt_dstpitch;
@@ -1861,7 +1891,7 @@
     unsigned val = mem_value;
     uint8_t *dst;
 
-    dst = s->vram_ptr + offset;
+    dst = s->vram_ptr + (offset &= s->cirrus_addr_mask);
     for (x = 0; x < 8; x++) {
 	if (val & 0x80) {
 	    *dst = s->cirrus_shadow_gr1;
@@ -1884,7 +1914,7 @@
     unsigned val = mem_value;
     uint8_t *dst;
 
-    dst = s->vram_ptr + offset;
+    dst = s->vram_ptr + (offset &= s->cirrus_addr_mask);
     for (x = 0; x < 8; x++) {
 	if (val & 0x80) {
 	    *dst = s->cirrus_shadow_gr1;
Yaln覺zca xen-3.0.4_1-src/tools/ioemu/hw'da: cirrus_vga.c.orig
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/hw/cirrus_vga_rop.h xen-3.0.4_1-src/tools/ioemu/hw/cirrus_vga_rop.h
--- xen-3.0.4_1-src.orig/tools/ioemu/hw/cirrus_vga_rop.h	2007-01-08 17:00:48.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/hw/cirrus_vga_rop.h	2007-05-01 15:58:51.480666729 +0300
@@ -31,6 +31,12 @@
     int x,y;
     dstpitch -= bltwidth;
     srcpitch -= bltwidth;
+
+    if (dstpitch < 0 || srcpitch < 0) {
+        /* is 0 valid? srcpitch == 0 could be useful */
+        return;
+    }
+
     for (y = 0; y < bltheight; y++) {
         for (x = 0; x < bltwidth; x++) {
             ROP_OP(*dst, *src);
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/hw/fdc.c xen-3.0.4_1-src/tools/ioemu/hw/fdc.c
--- xen-3.0.4_1-src.orig/tools/ioemu/hw/fdc.c	2007-01-08 17:00:48.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/hw/fdc.c	2007-05-01 15:58:51.480666729 +0300
@@ -1110,8 +1110,13 @@
             len = fdctrl->data_len - fdctrl->data_pos;
             if (len > FD_SECTOR_LEN)
                 len = FD_SECTOR_LEN;
-            bdrv_read(cur_drv->bs, fd_sector(cur_drv),
-                      fdctrl->fifo, len);
+            if (cur_drv->bs) {
+                bdrv_read(cur_drv->bs, fd_sector(cur_drv),
+                          fdctrl->fifo, len);
+            } else {
+                FLOPPY_ERROR("can't read data from drive\n");
+                return 0;
+            }
         }
     }
     retval = fdctrl->fifo[pos];
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/hw/i8259.c xen-3.0.4_1-src/tools/ioemu/hw/i8259.c
--- xen-3.0.4_1-src.orig/tools/ioemu/hw/i8259.c	2007-01-08 17:00:48.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/hw/i8259.c	2007-05-01 15:58:51.480666729 +0300
@@ -292,9 +292,11 @@
             s->init_state = 1;
             s->init4 = val & 1;
             if (val & 0x02)
-                hw_error("single mode not supported");
+                /* hw_error("single mode not supported"); */
+                return;
             if (val & 0x08)
-                hw_error("level sensitive irq not supported");
+                /* hw_error("level sensitive irq not supported"); */
+                return;
         } else if (val & 0x08) {
             if (val & 0x04)
                 s->poll = 1;
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/hw/ne2000.c xen-3.0.4_1-src/tools/ioemu/hw/ne2000.c
--- xen-3.0.4_1-src.orig/tools/ioemu/hw/ne2000.c	2007-01-08 17:00:48.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/hw/ne2000.c	2007-05-01 15:58:51.480666729 +0300
@@ -252,7 +252,7 @@
 {
     NE2000State *s = opaque;
     uint8_t *p;
-    int total_len, next, avail, len, index, mcast_idx;
+    unsigned int total_len, next, avail, len, index, mcast_idx;
     uint8_t buf1[60];
     static const uint8_t broadcast_macaddr[6] = 
         { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff };
@@ -327,7 +327,11 @@
 
     /* write packet data */
     while (size > 0) {
-        avail = s->stop - index;
+        /* taviso: this can wrap, so check its okay. */
+        if (index <= s->stop)
+            avail = s->stop - index;
+        else
+            avail = 0;
         len = size;
         if (len > avail)
             len = avail;
Yaln覺zca xen-3.0.4_1-src/tools/ioemu/hw'da: ne2000.c.orig
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/hw/pc.c xen-3.0.4_1-src/tools/ioemu/hw/pc.c
--- xen-3.0.4_1-src.orig/tools/ioemu/hw/pc.c	2007-01-08 17:00:48.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/hw/pc.c	2007-05-01 15:58:51.480666729 +0300
@@ -327,7 +327,8 @@
     case 0x400:
     case 0x401:
         fprintf(stderr, "BIOS panic at rombios.c, line %d\n", val);
-        exit(1);
+        /* according to documentation, these can be safely ignored */
+        break;
     case 0x402:
     case 0x403:
 #ifdef DEBUG_BIOS
@@ -350,8 +351,9 @@
         /* LGPL'ed VGA BIOS messages */
     case 0x501:
     case 0x502:
+        /* according to documentation, these can be safely ignored */
         fprintf(stderr, "VGA BIOS panic, line %d\n", val);
-        exit(1);
+        break;
     case 0x500:
     case 0x503:
 #ifdef DEBUG_BIOS
Yaln覺zca xen-3.0.4_1-src/tools/ioemu/hw'da: pc.c.orig
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/hw/sb16.c xen-3.0.4_1-src/tools/ioemu/hw/sb16.c
--- xen-3.0.4_1-src.orig/tools/ioemu/hw/sb16.c	2007-01-08 17:00:48.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/hw/sb16.c	2007-05-01 15:58:51.480666729 +0300
@@ -1235,8 +1235,10 @@
             s->block_size);
 #endif
 
-    while (s->left_till_irq <= 0) {
-        s->left_till_irq = s->block_size + s->left_till_irq;
+    if (s->block_size) {
+        while (s->left_till_irq <= 0) {
+            s->left_till_irq = s->block_size + s->left_till_irq;
+        }
     }
 
     return dma_pos;
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/target-i386/translate.c xen-3.0.4_1-src/tools/ioemu/target-i386/translate.c
--- xen-3.0.4_1-src.orig/tools/ioemu/target-i386/translate.c	2007-01-08 17:00:49.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/target-i386/translate.c	2007-05-01 15:58:51.480666729 +0300
@@ -5244,7 +5244,12 @@
         if (CODE64(s))
             goto illegal_op;
         val = ldub_code(s->pc++);
-        gen_op_aam(val);
+        /* taviso: operand can be zero */
+        if (val) {
+            gen_op_aam(val);
+        } else {
+            gen_exception(s, EXCP00_DIVZ, s->pc - s->cs_base);
+        }
         s->cc_op = CC_OP_LOGICB;
         break;
     case 0xd5: /* aad */
@@ -5292,6 +5297,7 @@
         gen_jmp_im(pc_start - s->cs_base);
         gen_op_into(s->pc - pc_start);
         break;
+#ifdef WANT_ICEBP
     case 0xf1: /* icebp (undocumented, exits to external debugger) */
 #if 1
         gen_debug(s, pc_start - s->cs_base);
@@ -5301,6 +5307,7 @@
         cpu_set_log(CPU_LOG_INT | CPU_LOG_TB_IN_ASM);
 #endif
         break;
+#endif /* icebp */
     case 0xfa: /* cli */
         if (!s->vm86) {
             if (s->cpl <= s->iopl) {
diff -ur xen-3.0.4_1-src.orig/tools/ioemu/vl.c xen-3.0.4_1-src/tools/ioemu/vl.c
--- xen-3.0.4_1-src.orig/tools/ioemu/vl.c	2007-01-08 17:00:49.000000000 +0200
+++ xen-3.0.4_1-src/tools/ioemu/vl.c	2007-05-01 15:58:51.480666729 +0300
@@ -3239,8 +3239,8 @@
     VLANClientState *vc;
     int fd;
     int state; /* 0 = getting length, 1 = getting data */
-    int index;
-    int packet_len;
+    unsigned int index;
+    unsigned int packet_len;
     uint8_t buf[4096];
     struct sockaddr_in dgram_dst; /* contains inet host and port destination iff connectionless (SOCK_DGRAM) */
 } NetSocketState;
@@ -3271,7 +3271,8 @@
 static void net_socket_send(void *opaque)
 {
     NetSocketState *s = opaque;
-    int l, size, err;
+    int size, err;
+    unsigned l;
     uint8_t buf1[4096];
     const uint8_t *buf;
 
@@ -3310,7 +3311,15 @@
             l = s->packet_len - s->index;
             if (l > size)
                 l = size;
-            memcpy(s->buf + s->index, buf, l);
+            if (s->index + l <= sizeof(s->buf)) {
+                memcpy(s->buf + s->index, buf, l);
+            } else {
+                fprintf(stderr, "serious error: oversized packet received,"
+                    "connection terminated.\n");
+                s->state = 0;
+                goto eoc;
+            }
+
             s->index += l;
             buf += l;
             size -= l;
Yaln覺zca xen-3.0.4_1-src/tools/ioemu'da: vl.c.orig
