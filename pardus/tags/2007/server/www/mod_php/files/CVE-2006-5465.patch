diff -Nurp orig/ext/standard/html.c new/ext/standard/html.c
--- ext/standard/html.c	2006-11-02 09:57:49.000000000 +0000
+++ ext/standard/html.c	2006-11-02 10:00:40.000000000 +0000
@@ -1096,7 +1096,7 @@ PHPAPI char *php_escape_html_entities(un
 
 		matches_map = 0;
 
-		if (len + 9 > maxlen)
+		if (len + 16 > maxlen)
 			replaced = erealloc (replaced, maxlen += 128);
 
 		if (all) {
@@ -1121,9 +1121,15 @@ PHPAPI char *php_escape_html_entities(un
 			}
 
 			if (matches_map) {
+				int l = strlen(rep);
+				/* increase the buffer size */
+				if (len + 2 + l >= maxlen) {
+					replaced = erealloc(replaced, maxlen += 128);
+				}
+
 				replaced[len++] = '&';
 				strcpy(replaced + len, rep);
-				len += strlen(rep);
+				len += l;
 				replaced[len++] = ';';
 			}
 		}
