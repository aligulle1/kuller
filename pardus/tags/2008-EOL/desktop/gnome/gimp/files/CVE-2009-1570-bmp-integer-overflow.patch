--- plug-ins/file-bmp/bmp-read.c.orig	2009-08-03 23:17:25.000000000 +0300
+++ plug-ins/file-bmp/bmp-read.c	2009-11-13 09:31:14.000000000 +0200
@@ -424,7 +424,8 @@
       return -1;
     }
 
-  if (Bitmap_Head.biWidth < 0)
+  if (Bitmap_Head.biWidth < 0 ||
+      ABS (Bitmap_Head.biHeight) < 0)
     {
       g_set_error (error, G_FILE_ERROR, G_FILE_ERROR_FAILED,
                    _("'%s' is not a valid BMP file"),
@@ -448,6 +449,18 @@
       return -1;
     }
 
+  /* protect against integer overflows caused by malicious BMPs */
+
+  if (((guint64) Bitmap_Head.biWidth) * Bitmap_Head.biBitCnt > G_MAXINT32 ||
+      ((guint64) Bitmap_Head.biWidth) * ABS (Bitmap_Head.biHeight) > G_MAXINT32 ||
+      ((guint64) Bitmap_Head.biWidth) * ABS (Bitmap_Head.biHeight) * 4 > G_MAXINT32)
+    {
+      g_set_error (error, G_FILE_ERROR, G_FILE_ERROR_FAILED,
+                   _("'%s' is not a valid BMP file"),
+                   gimp_filename_to_utf8 (filename));
+      return -1;
+    }
+
   /* Windows and OS/2 declare filler so that rows are a multiple of
    * word length (32 bits == 4 bytes)
    */
