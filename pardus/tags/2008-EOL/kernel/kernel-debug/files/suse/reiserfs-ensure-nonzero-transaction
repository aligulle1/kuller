From: Jeff Mahoney <jeffm@suse.com>
Subject: reiserfs: ensure nonzero transaction
References: bnc#447406 bnc#399966

 If a transaction is closed and only contains preallocated blocks, it
 will pass the initial journal->j_len checks and then cause an assertion
 failure in flush_commit_list() when all the blocks are removed from
 the transaction.

Signed-off-by: Jeff Mahoney <jeffm@suse.com>
---
 fs/reiserfs/journal.c |    9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

--- a/fs/reiserfs/journal.c
+++ b/fs/reiserfs/journal.c
@@ -4020,8 +4020,13 @@ static int do_journal_end(struct reiserf
 						 * the transaction */
 	th->t_refcount--;
 	current->journal_info = th->t_handle_save;
-#endif
 
+	if (journal->j_len == 0) {
+		reiserfs_prepare_for_journal(p_s_sb, SB_BUFFER_WITH_SB(p_s_sb),
+					     1);
+		journal_mark_dirty(th, p_s_sb, SB_BUFFER_WITH_SB(p_s_sb));
+	}
+#endif
 	/* setup description block */
 	d_bh =
 	    journal_getblk(sb,
