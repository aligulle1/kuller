X-Git-Url: http://git.postgresql.org/gitweb?p=postgresql.git;a=blobdiff_plain;f=src%2Fbackend%2Futils%2Fadt%2Fvarbit.c;h=5138fc403c7ee89a4e0c261faeeb87fd0557e6b9;hp=b6e1a33739b90bd4db2b9bbc5eaf4010e2ac4dd3;hb=560e209fb28814b17d48d7b94df054a267c8e6d5;hpb=1fa39d7969e3ace753a6b15cd2453ac76c85e6ea

diff --git a/src/backend/utils/adt/varbit.c b/src/backend/utils/adt/varbit.c
index b6e1a33..5138fc4 100644
--- a/src/backend/utils/adt/varbit.c
+++ b/src/backend/utils/adt/varbit.c
@@ -864,13 +864,23 @@ bitsubstr(PG_FUNCTION_ARGS)
 			   *ps;
 
 	bitlen = VARBITLEN(arg);
-	/* If we do not have an upper bound, set bitlen */
-	if (l == -1)
-		l = bitlen;
-	e = s + l;
 	s1 = Max(s, 1);
-	e1 = Min(e, bitlen + 1);
-	if (s1 > bitlen || e1 < 1)
+	/* If we do not have an upper bound, use end of string */
+	if (l < 0)
+	{
+		e1 = bitlen + 1;
+	}
+	else
+	{
+		e = s + l;
+		/* guard against overflow, even though we don't allow L<0 here */
+		if (e < s)
+			ereport(ERROR,
+					(errcode(ERRCODE_SUBSTRING_ERROR),
+					 errmsg("negative substring length not allowed")));
+		e1 = Min(e, bitlen + 1);
+	}
+	if (s1 > bitlen || e1 <= s1)
 	{
 		/* Need to return a zero-length bitstring */
 		len = VARBITTOTALLEN(0);
