diff -Nur acx-20080210.orig/ioctl.c acx-20080210/ioctl.c
--- acx-20080210.orig/ioctl.c	2008-08-04 11:48:19.000000000 +0300
+++ acx-20080210/ioctl.c	2008-08-04 12:03:26.000000000 +0300
@@ -495,6 +495,7 @@
 {
 	struct iw_event iwe;
 	char *ptr_rate;
+	struct iw_request_info *info;
 
 	FN_ENTER;
 
@@ -503,14 +504,14 @@
 	iwe.u.ap_addr.sa_family = ARPHRD_ETHER;
 	MAC_COPY(iwe.u.ap_addr.sa_data, bss->bssid);
 	acxlog_mac(L_IOCTL, "scan, station address: ", bss->bssid, "\n");
-	ptr = iwe_stream_add_event(ptr, end_buf, &iwe, IW_EV_ADDR_LEN);
+	ptr = iwe_stream_add_event(info, ptr, end_buf, &iwe, IW_EV_ADDR_LEN);
 
 	/* Add ESSID */
 	iwe.cmd = SIOCGIWESSID;
 	iwe.u.data.length = bss->essid_len;
 	iwe.u.data.flags = 1;
 	log(L_IOCTL, "scan, essid: %s\n", bss->essid);
-	ptr = iwe_stream_add_point(ptr, end_buf, &iwe, bss->essid);
+	ptr = iwe_stream_add_point(info, ptr, end_buf, &iwe, bss->essid);
 
 	/* Add mode */
 	iwe.cmd = SIOCGIWMODE;
@@ -520,7 +521,7 @@
 		else
 			iwe.u.mode = IW_MODE_ADHOC;
 		log(L_IOCTL, "scan, mode: %d\n", iwe.u.mode);
-		ptr = iwe_stream_add_event(ptr, end_buf, &iwe, IW_EV_UINT_LEN);
+		ptr = iwe_stream_add_event(info, ptr, end_buf, &iwe, IW_EV_UINT_LEN);
 	}
 
 	/* Add frequency */
@@ -528,7 +529,7 @@
 	iwe.u.freq.m = acx_channel_freq[bss->channel - 1] * 100000;
 	iwe.u.freq.e = 1;
 	log(L_IOCTL, "scan, frequency: %d\n", iwe.u.freq.m);
-	ptr = iwe_stream_add_event(ptr, end_buf, &iwe, IW_EV_FREQ_LEN);
+	ptr = iwe_stream_add_event(info, ptr, end_buf, &iwe, IW_EV_FREQ_LEN);
 
 	/* Add link quality */
 	iwe.cmd = IWEVQUAL;
@@ -546,7 +547,7 @@
 	iwe.u.qual.updated = 7;
 	log(L_IOCTL, "scan, link quality: %d/%d/%d\n",
 			iwe.u.qual.level, iwe.u.qual.noise, iwe.u.qual.qual);
-	ptr = iwe_stream_add_event(ptr, end_buf, &iwe, IW_EV_QUAL_LEN);
+	ptr = iwe_stream_add_event(info, ptr, end_buf, &iwe, IW_EV_QUAL_LEN);
 
 	/* Add encryption */
 	iwe.cmd = SIOCGIWENCODE;
@@ -556,12 +557,12 @@
 		iwe.u.data.flags = IW_ENCODE_DISABLED;
 	iwe.u.data.length = 0;
 	log(L_IOCTL, "scan, encryption flags: %X\n", iwe.u.data.flags);
-	ptr = iwe_stream_add_point(ptr, end_buf, &iwe, bss->essid);
+	ptr = iwe_stream_add_point(info, ptr, end_buf, &iwe, bss->essid);
 
 	/* add rates */
 	iwe.cmd = SIOCGIWRATE;
 	iwe.u.bitrate.fixed = iwe.u.bitrate.disabled = 0;
-	ptr_rate = ptr + IW_EV_LCP_LEN;
+	ptr_rate = ptr + iwe_stream_lcp_len(info);
 
 	{
 	u16 rate = bss->rate_cap;
@@ -570,14 +571,14 @@
 		if (rate & 1) {
 			iwe.u.bitrate.value = *p * 500000; /* units of 500kb/s */
 			log(L_IOCTL, "scan, rate: %d\n", iwe.u.bitrate.value);
-			ptr_rate = iwe_stream_add_value(ptr, ptr_rate, end_buf,
+			ptr_rate = iwe_stream_add_value(info, ptr, ptr_rate, end_buf,
 						&iwe, IW_EV_PARAM_LEN);
 		}
 		rate >>= 1;
 		p++;
 	}}
 
-	if ((ptr_rate - ptr) > (ptrdiff_t)IW_EV_LCP_LEN)
+	if ((ptr_rate - ptr) > (ptrdiff_t)iwe_stream_lcp_len(info))
 		ptr = ptr_rate;
 
 	/* drop remaining station data items for now */
