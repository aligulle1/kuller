diff -Nur clamav-0.93.3/libclamav/mbox.c clamav-0.93.3-new/libclamav/mbox.c
--- clamav-0.93.3/libclamav/mbox.c	2008-06-04 15:13:34.000000000 +0300
+++ clamav-0.93.3-new/libclamav/mbox.c	2008-09-05 11:30:19.000000000 +0300
@@ -1462,7 +1462,8 @@
 					break;
 			}
 		}
-
+        if(body->isTruncated && retcode == CL_SUCCESS)
+                retcode = CL_EMEM;
 		/*
 		 * Tidy up and quit
 		 */
@@ -1639,6 +1640,11 @@
 					}
 					fullline = cli_strdup(line);
 					fulllinelength = strlen(line) + 1;
+                    if(!fullline) {
+                            if(ret)
+                                    ret->isTruncated = TRUE;
+                            break;
+                    }
 				} else if(line != NULL) {
 					fulllinelength += strlen(line);
 					ptr = cli_realloc(fullline, fulllinelength);
diff -Nur clamav-0.93.3/libclamav/message.c clamav-0.93.3-new/libclamav/message.c
--- clamav-0.93.3/libclamav/message.c	2008-04-14 22:03:06.000000000 +0300
+++ clamav-0.93.3-new/libclamav/message.c	2008-09-05 11:39:13.000000000 +0300
@@ -1779,7 +1779,7 @@
 		for(t_line = messageGetBody(m); t_line; t_line = t_line->t_next) {
 			if(first == NULL)
 				first = last = cli_malloc(sizeof(text));
-			else {
+			else if (last) {
 				last->t_next = cli_malloc(sizeof(text));
 				last = last->t_next;
 			}
@@ -1840,6 +1840,7 @@
 			case UUENCODE:
 				cli_errmsg("messageToText: Unexpected attempt to handle uuencoded file - report to http://bugs.clamav.net\n");
 				if(first) {
+					if(last)
 					last->t_next = NULL;
 					textDestroy(first);
 				}
@@ -1850,6 +1851,7 @@
 				if(t_line == NULL) {
 					/*cli_warnmsg("YENCODED attachment is missing begin statement\n");*/
 					if(first) {
+						if(last)
 						last->t_next = NULL;
 						textDestroy(first);
 					}
@@ -1924,7 +1926,7 @@
 			if(decode(m, NULL, data, base64, FALSE) && data[0]) {
 				if(first == NULL)
 					first = last = cli_malloc(sizeof(text));
-				else {
+				else if (last) {
 					last->t_next = cli_malloc(sizeof(text));
 					last = last->t_next;
 				}
diff -Nur clamav-0.93.3/libclamav/message.h clamav-0.93.3-new/libclamav/message.h
--- clamav-0.93.3/libclamav/message.h	2008-04-02 23:17:27.000000000 +0300
+++ clamav-0.93.3-new/libclamav/message.h	2008-09-05 11:42:06.000000000 +0300
@@ -46,6 +46,7 @@
 
 	char	base64_1, base64_2, base64_3;
 	unsigned	int	isInfected : 1;
+	unsigned	int	isTruncated : 1;
 
 } message;
 
