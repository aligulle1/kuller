
# HG changeset patch
# User Darren Salt <linux@youmustbejoking.demon.co.uk>
# Date 1232129777 0
# Node ID 5df277a7eec373d9c9dffbf586f6a6a8e69b7d4c
# Parent c1d5466bb972b83932189ca180705a537ffe84bc
Fix a broken size check in the pvr input plugin (ref. CVE-2008-5239).

--- a/src/input/input_pvr.c	Fri Jan 16 16:52:16 2009 +0000
+++ b/src/input/input_pvr.c	Fri Jan 16 18:16:17 2009 +0000
@@ -1202,12 +1202,15 @@ static buf_element_t *pvr_plugin_read_bl
   buf_element_t        *buf;
   int                   speed = _x_get_speed(this->stream);
 
-  if (todo < 0 || todo > buf->size)
-    return NULL;
-
   if( !this->pvr_running ) {
     xprintf(this->stream->xine, XINE_VERBOSITY_DEBUG, "input_pvr: thread died, aborting\n");
     return NULL;  
+  }
+
+  buf = fifo->buffer_pool_alloc (fifo);
+  if (todo < 0 || todo > buf->size) {
+    buf->free_buffer(buf);
+    return NULL;
   }
 
   if( this->scr_tunning == -2 )
@@ -1233,7 +1236,6 @@ static buf_element_t *pvr_plugin_read_bl
 
   pvr_event_handler(this);
   
-  buf = fifo->buffer_pool_alloc (fifo);
   buf->content = buf->mem;
     
   pthread_mutex_lock(&this->lock);

