
    * Input sanitization for chfn and chsh
      Fixes CVE-2011-0721

diff -Nur shadow-4.1.2.2-old/src/chfn.c shadow-4.1.2.2/src/chfn.c
--- shadow-4.1.2.2-old/src/chfn.c	2011-02-16 09:06:09.539961018 +0200
+++ shadow-4.1.2.2/src/chfn.c	2011-02-16 09:07:12.170108019 +0200
@@ -540,7 +540,7 @@
 static void check_fields (void)
 {
 	int err;
-	err = valid_field (fullnm, ":,=");
+	err = valid_field (fullnm, ":,=\n");
 	if (err > 0) {
 		fprintf (stderr, _("%s: name with non-ASCII characters: '%s'\n"), Prog, fullnm);
 	} else if (err < 0) {
@@ -548,7 +548,7 @@
 		closelog ();
 		exit (E_NOPERM);
 	}
-	err = valid_field (roomno, ":,=");
+	err = valid_field (roomno, ":,=\n");
 	if (err > 0) {
 		fprintf (stderr, _("%s: room number with non-ASCII characters: '%s'\n"), Prog, roomno);
 	} else if (err < 0) {
@@ -557,19 +557,19 @@
 		closelog ();
 		exit (E_NOPERM);
 	}
-	if (valid_field (workph, ":,=")) {
+	if (valid_field (workph, ":,=\n")) {
 		fprintf (stderr, _("%s: invalid work phone: '%s'\n"),
 		         Prog, workph);
 		closelog ();
 		exit (E_NOPERM);
 	}
-	if (valid_field (homeph, ":,=")) {
+	if (valid_field (homeph, ":,=\n")) {
 		fprintf (stderr, _("%s: invalid home phone: '%s'\n"),
 		         Prog, homeph);
 		closelog ();
 		exit (E_NOPERM);
 	}
-	err = valid_field (slop, ":");
+	err = valid_field (slop, ":\n");
 	if (err > 0) {
 		fprintf (stderr, _("%s: '%s' contains non-ASCII characters\n"), Prog, slop);
 	} else if (err < 0) {
diff -Nur shadow-4.1.2.2-old/src/chsh.c shadow-4.1.2.2/src/chsh.c
--- shadow-4.1.2.2-old/src/chsh.c	2011-02-16 09:06:09.538960424 +0200
+++ shadow-4.1.2.2/src/chsh.c	2011-02-16 09:08:47.321961946 +0200
@@ -525,7 +525,7 @@
 	 * users are restricted to using the shells in /etc/shells.
 	 * The shell must be executable by the user.
 	 */
-	if (valid_field (loginsh, ":,=")) {
+	if (valid_field (loginsh, ":,=\n")) {
 		fprintf (stderr, _("%s: Invalid entry: %s\n"), Prog, loginsh);
 		closelog ();
 		exit (1);
