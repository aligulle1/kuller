diff -Naur akregator-orig/CMakeLists.txt akregator/CMakeLists.txt
--- akregator-orig/CMakeLists.txt	2008-02-21 11:28:22.000000000 +0200
+++ akregator/CMakeLists.txt	2009-06-18 11:58:51.897621112 +0300
@@ -2,6 +2,7 @@
 check_type_size("long" SIZEOF_LONG)
 configure_file(config-akregator.h.cmake ${CMAKE_CURRENT_BINARY_DIR}/config-akregator.h)
 
+add_subdirectory( export ) 
 add_subdirectory( interfaces ) 
 add_subdirectory( plugins ) 
 add_subdirectory( configuration ) 
diff -Naur akregator-orig/configuration/akregator_config_advanced.desktop akregator/configuration/akregator_config_advanced.desktop
--- akregator-orig/configuration/akregator_config_advanced.desktop	2009-05-28 22:22:07.000000000 +0300
+++ akregator/configuration/akregator_config_advanced.desktop	2009-06-18 11:58:51.914746049 +0300
@@ -21,15 +21,12 @@
 Name[fr]=Avancé
 Name[ga]=Ardsocruithe
 Name[gl]=Avanzado
-Name[hu]=Speciális
-Name[is]=Nánari stillingar
 Name[it]=Avanzate
 Name[ja]=詳細
 Name[km]=កម្រិត​ខ្ពស់
 Name[ko]=고급
 Name[lt]=Sudėtingesni
 Name[lv]=Paplašināti
-Name[mai]=उन्नत
 Name[nb]=Avansert
 Name[nds]=Verwiedert
 Name[nl]=Geavanceerd
@@ -51,14 +48,13 @@
 Name[zh_TW]=進階
 Comment=Advanced Feed Reader Settings
 Comment[ca]=Arranjaments avançats del lector de fonts
-Comment[da]=Avanceret opsætning af feed-læser
+Comment[da]=Avanceret indstilling af feed-læser
 Comment[de]=Erweiterte Einstellungen für den Nachrichtenbetrachter
 Comment[el]=Προχωρημένες ρυθμίσεις αναγνώστη ροών ειδήσεων
 Comment[es]=Configuración avanzada del lector de fuentes
 Comment[et]=Uudistevoogude lugeja muud seadistused
 Comment[fr]=Configuration avancé du lecteur de flux
-Comment[gl]=Configuración Avanzada do Lector de Novas
-Comment[hu]=Hírolvasó-beállítások
+Comment[gl]=Configuración avanzada do lector de novas
 Comment[it]=Impostazioni avanzate per il lettore di fonti
 Comment[ja]=フィードリーダーの詳細設定
 Comment[km]=ការ​កំណត់​កម្មវិធី​អាន​មតិព័ត៌មានកម្រិត​ខ្ពស់
diff -Naur akregator-orig/configuration/akregator_config_appearance.desktop akregator/configuration/akregator_config_appearance.desktop
--- akregator-orig/configuration/akregator_config_appearance.desktop	2009-05-28 22:22:07.000000000 +0300
+++ akregator/configuration/akregator_config_appearance.desktop	2009-06-18 11:58:51.913745961 +0300
@@ -42,7 +42,6 @@
 Name[ko]=모양
 Name[lt]=Išvaizda
 Name[lv]=Izskats
-Name[mai]=प्रकटन
 Name[mk]=Изглед
 Name[ms]=Rupa
 Name[nb]=Utseende
@@ -79,8 +78,7 @@
 Comment[es]=Configurar la apariencia del lector de fuentes
 Comment[et]=Uudistevoogude lugeja välimuse seadistamine
 Comment[fr]=Configurer l'apparence du lecteur de flux
-Comment[gl]=Configurar a Aparencia do Lector de Novas
-Comment[hu]=Beállítások a hírolvasó megjelenéséhez
+Comment[gl]=Configurar a aparencia do lector de novas
 Comment[it]=Configura l'aspetto del lettore di fonti
 Comment[ja]=フィードリーダーの外観設定
 Comment[km]=កំណត់​រចនាសម្ព័ន្ធ​រូបរាង​របស់​កម្មវិធី​អាន​​មតិព័ត៌មាន
diff -Naur akregator-orig/configuration/akregator_config_appearance.h akregator/configuration/akregator_config_appearance.h
--- akregator-orig/configuration/akregator_config_appearance.h	2008-02-13 17:45:34.000000000 +0200
+++ akregator/configuration/akregator_config_appearance.h	2009-06-18 11:58:51.914746049 +0300
@@ -21,8 +21,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef KCMAKRAPPEARANCECONFIG_H
-#define KCMAKRAPPEARANCECONFIG_H
+#ifndef AKREGATOR_CONFIG_APPEARANCE_H
+#define AKREGATOR_CONFIG_APPEARANCE_H
 
 #include "ui_settings_appearance.h"
 
@@ -46,4 +46,4 @@
 
 };
 
-#endif
+#endif // AKREGATOR_CONFIG_APPEARANCE_H
diff -Naur akregator-orig/configuration/akregator_config_archive.desktop akregator/configuration/akregator_config_archive.desktop
--- akregator-orig/configuration/akregator_config_archive.desktop	2009-05-28 22:22:07.000000000 +0300
+++ akregator/configuration/akregator_config_archive.desktop	2009-06-18 11:58:51.914746049 +0300
@@ -20,14 +20,12 @@
 Name[et]=Arhiveerimine
 Name[ga]=Cartlann
 Name[gl]=Arquivo
-Name[hu]=Archívum
 Name[it]=Archivia
 Name[ja]=アーカイブ
 Name[km]=ប័ណ្ណសារ
 Name[ko]=저장소
 Name[lt]=Archyvas
 Name[lv]=Arhīvs
-Name[mai]=अभिलेख
 Name[nb]=Arkiv
 Name[nds]=Archiev
 Name[nl]=Archief
@@ -55,8 +53,7 @@
 Comment[et]=Uudistevoogude arhiveerimise seadistamine
 Comment[fr]=Configurer les archives des flux
 Comment[ga]=Cumraigh Cartlann na bhFothaí
-Comment[gl]=Configurar o Arquivo de Fontes de Novas
-Comment[hu]=A hírolvasó-archívum beállításai
+Comment[gl]=Configurar o arquivo de fontes de novas
 Comment[it]=Configura l'archiviazione delle fonti
 Comment[ja]=フィードのアーカイブ設定
 Comment[km]=កំណត់​រចនាសម្ព័ន្ធ​ប័ណ្ណសារ​មតិព័ត៌មាន
diff -Naur akregator-orig/configuration/akregator_config_archive.h akregator/configuration/akregator_config_archive.h
--- akregator-orig/configuration/akregator_config_archive.h	2008-09-29 08:55:47.000000000 +0300
+++ akregator/configuration/akregator_config_archive.h	2009-06-18 11:58:51.913745961 +0300
@@ -21,8 +21,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef KCMAKRARCHIVECONFIG_H
-#define KCMAKRARCHIVECONFIG_H
+#ifndef AKREGATOR_CONFIG_ARCHIVE_H
+#define AKREGATOR_CONFIG_ARCHIVE_H
 
 #include <KCModule>
 
@@ -50,4 +50,4 @@
       QButtonGroup* m_archiveModeGroup;
 };
 
-#endif
+#endif // AKREGATOR_CONFIG_ARCHIVE_H
diff -Naur akregator-orig/configuration/akregator_config_browser.desktop akregator/configuration/akregator_config_browser.desktop
--- akregator-orig/configuration/akregator_config_browser.desktop	2009-05-28 22:22:07.000000000 +0300
+++ akregator/configuration/akregator_config_browser.desktop	2009-06-18 11:58:51.913745961 +0300
@@ -19,14 +19,12 @@
 Name[fr]=Navigateur
 Name[ga]=Brabhsálaí
 Name[gl]=Navegador
-Name[hu]=Böngésző
 Name[it]=Navigatore
 Name[ja]=ブラウザ
 Name[km]=កម្មវិធី​រុករក
 Name[ko]=탐색기
 Name[lt]=Naršyklė
 Name[lv]=Pārlūks
-Name[mai]=ब्राउज़र
 Name[nb]=Nettleser
 Name[nds]=Kieker
 Name[nn]=Nettlesar
@@ -54,8 +52,7 @@
 Comment[es]=Configurar el componente navegador interno
 Comment[et]=Sisemise sirvimiskomponendi seadistamine
 Comment[fr]=Configurer le navigateur web interne
-Comment[gl]=Configurar o Componente Navegador Interno
-Comment[hu]=A belső böngészőkomponens beállítása
+Comment[gl]=Configurar o componente navegador interno
 Comment[it]=Configura il componente interno di navigazione internet
 Comment[ja]=内部ブラウザコンポーネントの設定
 Comment[km]=កំណត់​រចនាសម្ព័ន្ធ​សមាសភាគ​កម្មវិធី​រុករក​ខាង​ក្នុង
diff -Naur akregator-orig/configuration/akregator_config_browser.h akregator/configuration/akregator_config_browser.h
--- akregator-orig/configuration/akregator_config_browser.h	2008-02-07 15:20:20.000000000 +0200
+++ akregator/configuration/akregator_config_browser.h	2009-06-18 11:58:51.913745961 +0300
@@ -21,8 +21,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef KCMAKRBROWSERCONFIG_H
-#define KCMAKRBROWSERCONFIG_H
+#ifndef AKREGATOR_CONFIG_BROWSER_H
+#define AKREGATOR_CONFIG_BROWSER_H
 
 #include <KCModule>
 
@@ -41,4 +41,4 @@
       QWidget* m_widget;
 };
 
-#endif
+#endif // AKREGATOR_CONFIG_BROWSER_H
diff -Naur akregator-orig/configuration/akregator_config_general.desktop akregator/configuration/akregator_config_general.desktop
--- akregator-orig/configuration/akregator_config_general.desktop	2009-05-28 22:22:07.000000000 +0300
+++ akregator/configuration/akregator_config_general.desktop	2009-06-18 11:58:51.914746049 +0300
@@ -40,7 +40,6 @@
 Name[ko]=일반
 Name[lt]=Bendras
 Name[lv]=Pamata
-Name[mai]=सामान्य
 Name[mk]=Општо
 Name[ms]=Umum
 Name[nb]=SGenerelt
@@ -75,8 +74,7 @@
 Comment[et]=Uudistevoogude seadistamine
 Comment[fr]=Configurer les flux
 Comment[ga]=Cumraigh Fothaí
-Comment[gl]=Configurar Fontes de Novas
-Comment[hu]=A hírcsatornák beállítása
+Comment[gl]=Configurar as fontes de novas
 Comment[it]=Configura fonti
 Comment[ja]=フィードの全般設定
 Comment[km]=កំណត់​រចនាសម្ព័ន្ធ​មតិព័ត៌មាន
diff -Naur akregator-orig/configuration/akregator_config_general.h akregator/configuration/akregator_config_general.h
--- akregator-orig/configuration/akregator_config_general.h	2008-02-07 15:20:20.000000000 +0200
+++ akregator/configuration/akregator_config_general.h	2009-06-18 11:58:51.914746049 +0300
@@ -21,8 +21,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef KCMAKRGENERALCONFIG_H
-#define KCMAKRGENERALCONFIG_H
+#ifndef AKREGATOR_CONFIG_GENERAL_H
+#define AKREGATOR_CONFIG_GENERAL_H
 
 #include <KCModule>
 
@@ -43,4 +43,4 @@
       QWidget* m_widget;
 };
 
-#endif
+#endif // AKREGATOR_CONFIG_GENERAL_H 
diff -Naur akregator-orig/configuration/settings_advancedbase.ui akregator/configuration/settings_advancedbase.ui
--- akregator-orig/configuration/settings_advancedbase.ui	2008-10-09 12:47:43.000000000 +0300
+++ akregator/configuration/settings_advancedbase.ui	2009-06-18 11:58:51.914746049 +0300
@@ -124,8 +124,6 @@
    </item>
   </layout>
  </widget>
- <layoutdefault spacing="6" margin="11" />
- <pixmapfunction>qPixmapFromMimeSource</pixmapfunction>
  <customwidgets>
   <customwidget>
    <class>KComboBox</class>
diff -Naur akregator-orig/configuration/settings_appearance.ui akregator/configuration/settings_appearance.ui
--- akregator-orig/configuration/settings_appearance.ui	2008-06-03 12:34:38.000000000 +0300
+++ akregator/configuration/settings_appearance.ui	2009-06-18 11:58:51.913745961 +0300
@@ -396,8 +396,6 @@
    </item>
   </layout>
  </widget>
- <layoutdefault spacing="6" margin="11" />
- <pixmapfunction>qPixmapFromMimeSource</pixmapfunction>
  <customwidgets>
   <customwidget>
    <class>KColorButton</class>
diff -Naur akregator-orig/configuration/settings_archive.ui akregator/configuration/settings_archive.ui
--- akregator-orig/configuration/settings_archive.ui	2008-08-20 22:53:49.000000000 +0300
+++ akregator/configuration/settings_archive.ui	2009-06-18 11:58:51.914746049 +0300
@@ -146,8 +146,6 @@
    </item>
   </layout>
  </widget>
- <layoutdefault spacing="6" margin="11" />
- <pixmapfunction>qPixmapFromMimeSource</pixmapfunction>
  <customwidgets>
   <customwidget>
    <class>KIntSpinBox</class>
diff -Naur akregator-orig/configuration/settings_browser.ui akregator/configuration/settings_browser.ui
--- akregator-orig/configuration/settings_browser.ui	2008-08-28 19:13:16.000000000 +0300
+++ akregator/configuration/settings_browser.ui	2009-06-18 11:58:51.914746049 +0300
@@ -1,137 +1,99 @@
-<ui version="4.0" >
+<?xml version="1.0" encoding="UTF-8"?>
+<ui version="4.0">
  <author>Gary Cramblitt</author>
- <comment></comment>
- <exportmacro></exportmacro>
  <class>Akregator::SettingsBrowser</class>
- <widget class="QWidget" name="Akregator::SettingsBrowser" >
-  <property name="geometry" >
+ <widget class="QWidget" name="Akregator::SettingsBrowser">
+  <property name="geometry">
    <rect>
     <x>0</x>
     <y>0</y>
-    <width>326</width>
-    <height>401</height>
+    <width>349</width>
+    <height>446</height>
    </rect>
   </property>
-  <property name="windowTitle" >
+  <property name="windowTitle">
    <string>ExternalBrowser</string>
   </property>
-  <layout class="QGridLayout" >
-   <property name="margin" >
-    <number>8</number>
-   </property>
-   <property name="spacing" >
-    <number>6</number>
-   </property>
-   <item row="2" column="0" >
-    <widget class="QCheckBox" name="kcfg_CloseButtonOnTabs" >
-     <property name="text" >
-      <string>Show tab close button on hover</string>
-     </property>
-    </widget>
-   </item>
-   <item row="3" column="0" >
-    <spacer>
-     <property name="orientation" >
-      <enum>Qt::Vertical</enum>
-     </property>
-     <property name="sizeType" >
-      <enum>QSizePolicy::Expanding</enum>
-     </property>
-     <property name="sizeHint" >
-      <size>
-       <width>31</width>
-       <height>16</height>
-      </size>
-     </property>
-    </spacer>
-   </item>
-   <item row="0" column="0" >
-    <layout class="QGridLayout" >
-     <property name="margin" >
+  <layout class="QVBoxLayout" name="verticalLayout">
+   <item>
+    <layout class="QGridLayout" name="mouseButtonsLayout">
+     <property name="margin">
       <number>0</number>
      </property>
-     <property name="spacing" >
+     <property name="spacing">
       <number>6</number>
      </property>
-     <item row="0" column="1" >
-      <widget class="QComboBox" name="kcfg_LMBBehaviour" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>7</hsizetype>
-         <vsizetype>0</vsizetype>
+     <item row="0" column="1">
+      <widget class="QComboBox" name="kcfg_LMBBehaviour">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Expanding" vsizetype="Fixed">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
        <item>
-        <property name="text" >
+        <property name="text">
          <string>Open in Tab</string>
         </property>
        </item>
        <item>
-        <property name="text" >
+        <property name="text">
          <string>Open in Background Tab</string>
         </property>
        </item>
        <item>
-        <property name="text" >
+        <property name="text">
          <string>Open in External Browser</string>
         </property>
        </item>
       </widget>
      </item>
-     <item row="1" column="0" >
-      <widget class="QLabel" name="textLabel1" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>1</hsizetype>
-         <vsizetype>0</vsizetype>
+     <item row="1" column="0">
+      <widget class="QLabel" name="MMBlabel">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Minimum" vsizetype="Fixed">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
-       <property name="text" >
+       <property name="text">
         <string>Middle mouse click:</string>
        </property>
       </widget>
      </item>
-     <item row="0" column="0" >
-      <widget class="QLabel" name="textLabel1_3" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>1</hsizetype>
-         <vsizetype>0</vsizetype>
+     <item row="0" column="0">
+      <widget class="QLabel" name="LMBlabel">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Minimum" vsizetype="Fixed">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
-       <property name="text" >
+       <property name="text">
         <string>Left mouse click:</string>
        </property>
       </widget>
      </item>
-     <item row="1" column="1" >
-      <widget class="QComboBox" name="kcfg_MMBBehaviour" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>7</hsizetype>
-         <vsizetype>0</vsizetype>
+     <item row="1" column="1">
+      <widget class="QComboBox" name="kcfg_MMBBehaviour">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Expanding" vsizetype="Fixed">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
        <item>
-        <property name="text" >
+        <property name="text">
          <string>Open in Tab</string>
         </property>
        </item>
        <item>
-        <property name="text" >
+        <property name="text">
          <string>Open in Background Tab</string>
         </property>
        </item>
        <item>
-        <property name="text" >
+        <property name="text">
          <string>Open in External Browser</string>
         </property>
        </item>
@@ -139,41 +101,41 @@
      </item>
     </layout>
    </item>
-   <item row="1" column="0" >
-    <widget class="QGroupBox" name="groupBox" >
-     <property name="title" >
-      <string>For External Browsing</string>
+   <item>
+    <widget class="QGroupBox" name="externalBrowserGroupBox">
+     <property name="title">
+      <string>External Browsing</string>
      </property>
-     <layout class="QGridLayout" >
-      <property name="margin" >
+     <layout class="QGridLayout">
+      <property name="margin">
        <number>8</number>
       </property>
-      <property name="spacing" >
+      <property name="spacing">
        <number>6</number>
       </property>
-      <item row="1" column="1" >
-       <widget class="QLineEdit" name="kcfg_ExternalBrowserCustomCommand" >
-        <property name="enabled" >
+      <item row="1" column="1">
+       <widget class="QLineEdit" name="kcfg_ExternalBrowserCustomCommand">
+        <property name="enabled">
          <bool>false</bool>
         </property>
-        <property name="text" >
+        <property name="text">
          <string>firefox %u</string>
         </property>
        </widget>
       </item>
-      <item row="1" column="0" >
-       <widget class="QRadioButton" name="kcfg_ExternalBrowserUseCustomCommand" >
-        <property name="text" >
+      <item row="1" column="0">
+       <widget class="QRadioButton" name="kcfg_ExternalBrowserUseCustomCommand">
+        <property name="text">
          <string>Use this command:</string>
         </property>
        </widget>
       </item>
-      <item row="0" column="0" colspan="2" >
-       <widget class="QRadioButton" name="kcfg_ExternalBrowserUseKdeDefault" >
-        <property name="text" >
+      <item row="0" column="0" colspan="2">
+       <widget class="QRadioButton" name="kcfg_ExternalBrowserUseKdeDefault">
+        <property name="text">
          <string>Use default web browser</string>
         </property>
-        <property name="checked" >
+        <property name="checked">
          <bool>true</bool>
         </property>
        </widget>
@@ -181,10 +143,53 @@
      </layout>
     </widget>
    </item>
+   <item>
+    <widget class="QGroupBox" name="tabsGroupBox">
+     <property name="title">
+      <string>Tabs</string>
+     </property>
+     <layout class="QGridLayout" name="_2">
+      <property name="margin">
+       <number>8</number>
+      </property>
+      <property name="spacing">
+       <number>6</number>
+      </property>
+      <item row="1" column="0">
+       <widget class="QCheckBox" name="kcfg_CloseButtonOnTabs">
+        <property name="text">
+         <string>Show close button on each tab</string>
+        </property>
+       </widget>
+      </item>
+      <item row="0" column="0">
+       <widget class="QCheckBox" name="kcfg_AlwaysShowTabBar">
+        <property name="text">
+         <string>Always show the tab bar</string>
+        </property>
+       </widget>
+      </item>
+     </layout>
+    </widget>
+   </item>
+   <item>
+    <spacer>
+     <property name="orientation">
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType">
+      <enum>QSizePolicy::Expanding</enum>
+     </property>
+     <property name="sizeHint" stdset="0">
+      <size>
+       <width>31</width>
+       <height>16</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
   </layout>
  </widget>
- <layoutdefault spacing="6" margin="11" />
- <pixmapfunction>qPixmapFromMimeSource</pixmapfunction>
  <resources/>
  <connections/>
 </ui>
diff -Naur akregator-orig/configuration/settings_general.ui akregator/configuration/settings_general.ui
--- akregator-orig/configuration/settings_general.ui	2008-02-07 15:20:20.000000000 +0200
+++ akregator/configuration/settings_general.ui	2009-06-18 11:58:51.914746049 +0300
@@ -224,8 +224,6 @@
    </item>
   </layout>
  </widget>
- <layoutdefault spacing="6" margin="11" />
- <pixmapfunction>qPixmapFromMimeSource</pixmapfunction>
  <resources/>
  <connections/>
 </ui>
diff -Naur akregator-orig/export/akregatorstorageexporter.cpp akregator/export/akregatorstorageexporter.cpp
--- akregator-orig/export/akregatorstorageexporter.cpp	1970-01-01 02:00:00.000000000 +0200
+++ akregator/export/akregatorstorageexporter.cpp	2009-06-18 11:58:51.895996149 +0300
@@ -0,0 +1,379 @@
+/*
+ * This file is part of akregatorstorageexporter
+ *
+ * Copyright (C) 2009 Frank Osterfeld <osterfeld@kde.org>
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public License
+ * along with this library; see the file COPYING.LIB.  If not, write to
+ * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+ * Boston, MA 02110-1301, USA.
+ *
+ */
+#include "feedstorage.h"
+#include "storage.h"
+#include "storagefactory.h"
+#include "storagefactoryregistry.h"
+#include "plugin.h"
+
+#include <syndication/atom/constants.h>
+#include <syndication/constants.h>
+
+#include <QCoreApplication>
+#include <QDateTime>
+#include <QDebug>
+#include <QFile>
+#include <QIODevice>
+#include <QStringList>
+#include <QUrl>
+#include <QXmlStreamWriter>
+#include <QVariant>
+
+#include <KComponentData>
+#include <KGlobal>
+#include <KPluginLoader>
+#include <KService>
+#include <KServiceTypeTrader>
+
+#include <iostream>
+
+#include <cassert>
+
+using namespace Akregator;
+using namespace Akregator::Backend;
+
+namespace {
+    static QString akregatorNamespace() {
+        return QString::fromLatin1("http://akregator.kde.org/StorageExporter#");
+    }
+
+    enum TextMode {
+        PlainText,
+        Html
+    };
+
+    enum Status
+    {
+        Deleted=0x01,
+        Trash=0x02,
+        New=0x04,
+        Read=0x08,
+        Keep=0x10
+    };
+
+    class Element
+    {
+    public:
+        Element( const QString& ns_, const QString& name_ ) : ns( ns_ ), name( name_ ), qualifiedName( ns + ':' + name )
+        {
+        }
+
+        const QString ns;
+        const QString name;
+        const QString qualifiedName;
+
+        void writeStartElement( QXmlStreamWriter& writer ) const
+        {
+            if ( !ns.isNull() )
+                writer.writeStartElement( ns, name );
+            else
+                writer.writeStartElement( name );
+        }
+
+        void write( const QVariant& value , QXmlStreamWriter& writer, TextMode mode = PlainText ) const
+        {
+            const QVariant qv( value );
+            Q_ASSERT( qv.canConvert( QVariant::String ) );
+            const QString str = qv.toString();
+            if ( str.isEmpty() )
+                return;
+
+            if ( ns.isEmpty() )
+                writer.writeStartElement( name );
+            else
+                writer.writeStartElement( ns, name );
+            if ( mode == Html )
+            {
+                writer.writeAttribute( "type", "html" );
+            }
+            writer.writeCharacters( str );
+            writer.writeEndElement();
+        }
+    };
+
+    struct Elements
+    {
+        Elements() : atomNS( Syndication::Atom::atom1Namespace() ),
+                     akregatorNS(akregatorNamespace() ),
+                     commentNS( Syndication::commentApiNamespace() ),
+                     title( atomNS, "title" ),
+                     summary( atomNS, "summary" ),
+                     content( atomNS, "content" ),
+                     link( atomNS, "link" ),
+                     language( atomNS, "language" ),
+                     feed( atomNS, "feed" ),
+                     guid( atomNS, "id" ),
+                     published( atomNS, "published" ),
+                     updated( atomNS, "updated" ),
+                     commentsCount( Syndication::slashNamespace(), "comments" ),
+                     commentsFeed( commentNS, "commentRss" ),
+                     commentPostUri( commentNS, "comment" ),
+                     commentsLink( akregatorNS, "commentsLink" ),
+                     hash( akregatorNS, "hash" ),
+                     guidIsHash( akregatorNS, "idIsHash" ),
+                     name( atomNS, "name" ),
+                     uri( atomNS, "uri" ),
+                     email( atomNS, "email" ),
+                     author( atomNS, "author" ),
+                     category( atomNS, "category" ),
+                     entry( atomNS, "entry" ),
+                     itemProperties( akregatorNS, "itemProperties" ),
+                     readStatus( akregatorNS, "readStatus" ),
+                     deleted( akregatorNS, "deleted" ),
+                     important( akregatorNS, "important" )
+
+    {}
+        const QString atomNS;
+        const QString akregatorNS;
+        const QString commentNS;
+        const Element title;
+        const Element summary;
+        const Element content;
+        const Element link;
+        const Element language;
+        const Element feed;
+        const Element guid;
+        const Element published;
+        const Element updated;
+        const Element commentsCount;
+        const Element commentsFeed;
+        const Element commentPostUri;
+        const Element commentsLink;
+        const Element hash;
+        const Element guidIsHash;
+        const Element name;
+        const Element uri;
+        const Element email;
+        const Element author;
+        const Element category;
+        const Element entry;
+        const Element itemProperties;
+        const Element readStatus;
+        const Element deleted;
+        const Element important;
+        static const Elements instance;
+    };
+
+    const Elements Elements::instance;
+
+    void writeAttributeIfNotEmpty( const QString& ns, const QString& element, const QVariant& value, QXmlStreamWriter& writer )
+    {
+        const QString text = value.toString();
+        if ( text.isEmpty() )
+            return;
+        writer.writeAttribute( ns, element, text );
+    }
+
+    void writeAttributeIfNotEmpty( const QString& element, const QVariant& value, QXmlStreamWriter& writer )
+    {
+        const QString text = value.toString();
+        if ( text.isEmpty() )
+            return;
+        writer.writeAttribute( element, text );
+    }
+
+    void writeEnclosure( const QString& url, const QString& type, int length, QXmlStreamWriter& writer )
+    {
+        Elements::instance.link.writeStartElement( writer );
+        writer.writeAttribute( "rel", "enclosure" );
+        writeAttributeIfNotEmpty( "href", url, writer );
+        writeAttributeIfNotEmpty( "type", type, writer );
+        if ( length > 0 )
+            writer.writeAttribute( "length", QString::number( length ) );
+        writer.writeEndElement();
+    }
+
+    void writeLink( const QString& url, QXmlStreamWriter& writer )
+    {
+        if ( url.isEmpty() )
+            return;
+        Elements::instance.link.writeStartElement( writer );
+        writer.writeAttribute( "rel", "alternate" );
+        writeAttributeIfNotEmpty( "href", url, writer );
+        writer.writeEndElement();
+    }
+
+    void writeAuthor( const QString& name, const QString& uri, const QString& email, QXmlStreamWriter& writer )
+    {
+        if ( name.isEmpty() && uri.isEmpty() && email.isEmpty() )
+            return;
+
+        const QString atomNS = Syndication::Atom::atom1Namespace();
+        Elements::instance.author.writeStartElement( writer );
+        Elements::instance.name.write( name, writer );
+        Elements::instance.uri.write( uri, writer );
+        Elements::instance.email.write( email, writer );
+        writer.writeEndElement(); // </author>
+    }
+
+    static void writeItem( FeedStorage* storage, const QString& guid, QXmlStreamWriter& writer ) {
+        Elements::instance.entry.writeStartElement( writer );
+        Elements::instance.guid.write( guid, writer );
+
+        const uint published = storage->pubDate( guid );
+        if ( published > 0 ) {
+            const QString pdStr = QDateTime::fromTime_t( published ).toString( Qt::ISODate );
+            Elements::instance.published.write( pdStr, writer );
+        }
+
+        const int status = storage->status( guid );
+
+        Elements::instance.itemProperties.writeStartElement( writer );
+
+        if ( status & Deleted ) {
+            Elements::instance.deleted.write( QString::fromLatin1("true"), writer );
+            writer.writeEndElement(); // </itemProperties>
+            writer.writeEndElement(); // </item>
+            return;
+        }
+
+        Elements::instance.hash.write( QString::number( storage->hash( guid ) ), writer );
+        if ( storage->guidIsHash( guid ) )
+            Elements::instance.guidIsHash.write( QString::fromLatin1("true"), writer );
+        if ( status & New )
+            Elements::instance.readStatus.write( QString::fromLatin1("new"), writer );
+        else if ( ( status & Read ) == 0 )
+            Elements::instance.readStatus.write( QString::fromLatin1("unread"), writer );
+        if ( status & Keep )
+            Elements::instance.important.write( QString::fromLatin1("true"), writer );
+        writer.writeEndElement(); // </itemProperties>
+
+        Elements::instance.title.write( storage->title( guid ), writer, Html );
+        writeLink( storage->guidIsPermaLink( guid ) ? guid :  storage->link( guid ), writer );
+
+        Elements::instance.summary.write( storage->description( guid ), writer, Html );
+        Elements::instance.content.write( storage->content( guid ), writer, Html );
+        writeAuthor( storage->authorName( guid ),
+                     storage->authorUri( guid ),
+                     storage->authorEMail( guid ),
+                     writer );
+
+        if ( const int commentsCount = storage->comments( guid ) )
+            Elements::instance.commentsCount.write( QString::number( commentsCount ), writer );
+
+        Elements::instance.commentsLink.write( storage->commentsLink( guid ), writer );
+
+        bool hasEnc = false;
+        QString encUrl, encType;
+        int encLength = 0;
+        storage->enclosure( guid, hasEnc, encUrl, encType, encLength );
+        if ( hasEnc )
+            writeEnclosure( encUrl, encType, encLength, writer );
+        writer.writeEndElement(); // </item>
+    }
+
+    static void serialize( FeedStorage* storage, const QString& url, QIODevice* device ) {
+        assert( storage );
+        assert( device );
+        QXmlStreamWriter writer( device );
+        writer.setAutoFormatting( true );
+        writer.setAutoFormattingIndent( 2 );
+        writer.writeStartDocument();
+
+        Elements::instance.feed.writeStartElement( writer );
+
+        writer.writeDefaultNamespace( Syndication::Atom::atom1Namespace() );
+        writer.writeNamespace( Syndication::commentApiNamespace(), "comment" );
+        writer.writeNamespace( akregatorNamespace(), "akregator" );
+        writer.writeNamespace( Syndication::itunesNamespace(), "itunes" );
+
+        Elements::instance.title.write( QString::fromLatin1("Akregator Export for %1").arg( url ), writer, Html );
+
+
+        Q_FOREACH( const QString& i, storage->articles() )
+            writeItem( storage, i, writer );
+        writer.writeEndElement(); // </feed>
+        writer.writeEndDocument();
+    }
+
+    static void serialize( Storage* storage, const QString& url, QIODevice* device ) {
+        serialize( storage->archiveFor( url ), url, device );
+    }
+
+    static KService::List queryStoragePlugins() {
+        return KServiceTypeTrader::self()->query( "Akregator/Plugin",
+            QString::fromLatin1( "[X-KDE-akregator-framework-version] == %1 and [X-KDE-akregator-plugintype] == 'storage' and [X-KDE-akregator-rank] > 0" ).arg( QString::number( AKREGATOR_PLUGIN_INTERFACE_VERSION ) ) );
+    }
+
+    static Plugin* createFromService( const KService::Ptr& service )
+    {
+        KPluginLoader loader( *service );
+        KPluginFactory* factory = loader.factory();
+        if ( !factory ) {
+            qCritical() << QString( " Could not create plugin factory for: %1\n"
+                                    " Error message: %2" ).arg( service->library(), loader.errorString() );
+            return 0;
+        }
+        return factory->create<Akregator::Plugin>();
+    }
+
+    static void printUsage() {
+        std::cout << "akregatorstorageexporter [--base64] url" << std::endl;
+    }
+}
+
+
+int main( int argc, char** argv ) {
+    KGlobal::setActiveComponent( KComponentData( "akregatorstorageexporter" ) );
+    const QString backend = QString::fromLatin1( "metakit" );
+
+    if ( argc < 2 ) {
+        printUsage();
+        return 1;
+    }
+
+    const bool base64 = qstrcmp( argv[1], "--base64" ) == 0;
+
+    if ( base64 && argc < 3 ) {
+        printUsage();
+        return 1;
+    }
+
+    const int pos = base64 ? 2 : 1;
+    const QString url = QUrl::fromEncoded( base64 ? QByteArray::fromBase64( argv[pos] ) : QByteArray( argv[pos] ) ).toString();
+
+    Q_FOREACH( const KService::Ptr& i, queryStoragePlugins() )
+        if ( Plugin* const plugin = createFromService( i ) )
+            plugin->initialize();
+
+    const StorageFactory* const storageFactory = StorageFactoryRegistry::self()->getFactory( backend );
+    if ( !storageFactory ) {
+        qCritical( "Could not create storage factory for %s.", qPrintable( backend ) );
+        return 1;
+    }
+
+    Storage* const storage = storageFactory->createStorage( QStringList() );
+    if ( !storage ) {
+        qCritical( "Could not create storage object for %s.", qPrintable( backend ) );
+        return 1;
+    }
+
+    QFile out;
+    if ( !out.open( stdout, QIODevice::WriteOnly ) ) {
+        qCritical( "Could not open stdout for writing: %s", qPrintable( out.errorString() ) );
+        return 1;
+    }
+
+    serialize( storage, url, &out );
+
+    return 0;
+}
diff -Naur akregator-orig/export/CMakeLists.txt akregator/export/CMakeLists.txt
--- akregator-orig/export/CMakeLists.txt	1970-01-01 02:00:00.000000000 +0200
+++ akregator/export/CMakeLists.txt	2009-06-18 11:58:51.896995856 +0300
@@ -0,0 +1,15 @@
+include_directories( ${CMAKE_SOURCE_DIR}/akregator/interfaces ${CMAKE_SOURCE_DIR} ${KDE4_INCLUDE_DIR} ${QT_INCLUDES} ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_CURRENT_BINARY_DIR} )
+
+set(akregatorstorageexporter_SRCS 
+    akregatorstorageexporter.cpp
+)
+
+kde4_add_executable(akregatorstorageexporter NOGUI ${akregatorstorageexporter_SRCS})
+
+target_link_libraries(akregatorstorageexporter
+                      ${KDE4_KDECORE_LIBS}
+                      ${KDEPIMLIBS_SYNDICATION_LIBS}
+                      akregatorinterfaces)
+
+install(TARGETS akregatorstorageexporter ${INSTALL_TARGETS_DEFAULT_ARGS})
+
diff -Naur akregator-orig/interfaces/akregator.kcfg akregator/interfaces/akregator.kcfg
--- akregator-orig/interfaces/akregator.kcfg	2009-01-21 12:28:23.000000000 +0200
+++ akregator/interfaces/akregator.kcfg	2009-06-18 11:58:51.897621112 +0300
@@ -147,12 +147,16 @@
   </entry>
  </group>
  <group name="Browser" >
-   <entry key="Close Button On Tabs" type="Bool">
-     <label>Show close buttons on tabs</label>
-     <whatsthis>Show close buttons on tabs instead of icons</whatsthis>
-     <default>false</default>   
-   </entry>
-
+  <entry key="Always Show Tab Bar" type="Bool">
+    <label>Always show the tab bar</label>
+    <whatsthis>Always show the tab bar, even when only one tab is open</whatsthis>
+    <default>false</default>   
+  </entry>
+  <entry key="Close Button On Tabs" type="Bool">
+    <label>Show close buttons on tabs</label>
+    <whatsthis>Show close buttons on tabs instead of icons</whatsthis>
+    <default>false</default>   
+  </entry>
   <entry key="External Browser Use Kde Default" type="Bool" >
    <label>Use default KDE web browser</label>
    <whatsthis>Use KDE web browser when opening in external browser.</whatsthis>
diff -Naur akregator-orig/interfaces/CMakeLists.txt akregator/interfaces/CMakeLists.txt
--- akregator-orig/interfaces/CMakeLists.txt	2008-11-04 19:12:55.000000000 +0200
+++ akregator/interfaces/CMakeLists.txt	2009-06-18 11:58:51.896995856 +0300
@@ -13,7 +13,7 @@
 
 kde4_add_library(akregatorinterfaces SHARED ${akregatorinterfaces_LIB_SRCS})
 
-target_link_libraries(akregatorinterfaces kdepim ${KDE4_KHTML_LIBS} ${KDE4_SYNDICATION_LIBS} ${KDE4_KDE3SUPPORT_LIBRARY})
+target_link_libraries(akregatorinterfaces kdepim ${KDE4_KHTML_LIBS} ${KDEPIMLIBS_SYNDICATION_LIBS} ${KDE4_KDE3SUPPORT_LIBRARY})
 
 set_target_properties(akregatorinterfaces PROPERTIES VERSION ${GENERIC_LIB_VERSION} SOVERSION ${GENERIC_LIB_SOVERSION} )
 
diff -Naur akregator-orig/interfaces/plugin.cpp akregator/interfaces/plugin.cpp
--- akregator-orig/interfaces/plugin.cpp	2008-01-15 03:57:27.000000000 +0200
+++ akregator/interfaces/plugin.cpp	2009-06-18 11:58:51.897621112 +0300
@@ -1,5 +1,26 @@
-// Author: Mark Kretschmann (C) Copyright 2004
-// Copyright: See COPYING file that comes with this distribution
+/*
+    This file is part of Akregator.
+
+    Copyright (C) 2004 Mark Kretschmann <kretschmann@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
 
 #include "plugin.h"
 
@@ -7,7 +28,7 @@
 namespace Akregator {
 
 
-Plugin::Plugin()
+Plugin::Plugin( QObject* parent, const QVariantList& ) : QObject( parent )
 {}
 
 
@@ -43,4 +64,8 @@
     return m_properties.find( key.toLower() ) != m_properties.end();
 }
 
+
+void Plugin::insertGuiClients( KXMLGUIClient* ) {}
+void Plugin::removeGuiClients( KXMLGUIClient* ) {}
+
 }
diff -Naur akregator-orig/interfaces/plugin.h akregator/interfaces/plugin.h
--- akregator-orig/interfaces/plugin.h	2008-05-21 11:33:37.000000000 +0300
+++ akregator/interfaces/plugin.h	2009-06-18 11:58:51.896995856 +0300
@@ -1,29 +1,49 @@
-// Author: Mark Kretschmann (C) Copyright 2004
-// Copyright: See COPYING file that comes with this distribution
+/*
+    This file is part of Akregator.
+
+    Copyright (C) 2004 Mark Kretschmann <kretschmann@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
 
 #ifndef AKREGATOR_PLUGIN_H
 #define AKREGATOR_PLUGIN_H
 
 #include "akregator_export.h"
 
-#define AKREGATOR_PLUGIN_INTERFACE_VERSION 2
-
-#define AKREGATOR_EXPORT_PLUGIN( classname ) \
-    extern "C" { \
-         KDE_EXPORT Akregator::Plugin* create_plugin() { return new classname; } \
-    }
-
+#include <QtCore/QObject>
 #include <QtCore/QHash>
 #include <QtCore/QString>
+#include <QtCore/QVariant>
 
+class KXMLGUIClient;
 
-namespace Akregator {
+#define AKREGATOR_PLUGIN_INTERFACE_VERSION 4
 
-//    class PluginConfig;
+namespace Akregator {
 
-class AKREGATORINTERFACES_EXPORT Plugin
+class AKREGATORINTERFACES_EXPORT Plugin : public QObject
 {
+    Q_OBJECT
     public:
+        explicit Plugin( QObject* parent=0, const QVariantList& opts=QVariantList() );
+
         virtual ~Plugin();
 
         void initialize();
@@ -38,8 +58,10 @@
         QString pluginProperty( const QString& key ) const;
         bool hasPluginProperty( const QString& key ) const;
 
+        virtual void insertGuiClients( KXMLGUIClient* parent );
+        virtual void removeGuiClients( KXMLGUIClient* parent );
+
     protected:
-        Plugin();
         virtual void doInitialize() = 0;
 
     private:
diff -Naur akregator-orig/interfaces/storagefactoryregistry.cpp akregator/interfaces/storagefactoryregistry.cpp
--- akregator-orig/interfaces/storagefactoryregistry.cpp	2008-02-13 17:45:34.000000000 +0200
+++ akregator/interfaces/storagefactoryregistry.cpp	2009-06-18 11:58:51.897621112 +0300
@@ -22,8 +22,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "storagefactory.h"
 #include "storagefactoryregistry.h"
+#include "storagefactory.h"
 
 #include <k3staticdeleter.h>
 
diff -Naur akregator-orig/Mainpage.dox akregator/Mainpage.dox
--- akregator-orig/Mainpage.dox	2008-01-15 03:57:29.000000000 +0200
+++ akregator/Mainpage.dox	2009-06-18 11:58:51.897621112 +0300
@@ -1,3 +1,3 @@
 // DOXYGEN_REFERENCES = kdecore kdeui kio kparts kjs khtml kde3support syndication
-// DOXYGEN_EXCLUDE = plugins/mk4plugin/metakit
+// DOXYGEN_EXCLUDE = plugins
 
diff -Naur akregator-orig/plugins/CMakeLists.txt akregator/plugins/CMakeLists.txt
--- akregator-orig/plugins/CMakeLists.txt	2009-05-28 22:22:07.000000000 +0300
+++ akregator/plugins/CMakeLists.txt	2009-06-18 11:58:51.911735809 +0300
@@ -4,5 +4,5 @@
 # minimal TODO before reactivating this:
 # * make it work 
 # * make it use KWallet instead of plaintext KConfig to store the password
-add_subdirectory( onlinesync )
+#add_subdirectory( onlinesync )
 
diff -Naur akregator-orig/plugins/mk4storage/akregator_mk4storage_plugin.desktop akregator/plugins/mk4storage/akregator_mk4storage_plugin.desktop
--- akregator-orig/plugins/mk4storage/akregator_mk4storage_plugin.desktop	2009-03-26 16:43:23.000000000 +0200
+++ akregator/plugins/mk4storage/akregator_mk4storage_plugin.desktop	2009-06-18 11:58:51.907746085 +0300
@@ -37,7 +37,7 @@
 Name[pa]=ਮੇਟਾਕਿੱਤ ਸਟੋਰੇਜ਼ ਬੈਕਐਂਡ
 Name[pl]=System przechowywania Metakit
 Name[pt]=Infra-estrutura de armazenamento Metakit
-Name[pt_BR]=Infra-estrutura de armazenamento Metakit
+Name[pt_BR]=Infraestrutura de armazenamento Metakit
 Name[ro]=Suport de stocare Metakit
 Name[ru]=Хранилище Metakit
 Name[sl]=Shranjevanje Metakit
@@ -109,5 +109,5 @@
 X-KDE-akregator-email=osterfeld@kde.org
 X-KDE-akregator-rank=255
 X-KDE-akregator-version=1
-X-KDE-akregator-framework-version=2
+X-KDE-akregator-framework-version=4
 
diff -Naur akregator-orig/plugins/mk4storage/CMakeLists.txt akregator/plugins/mk4storage/CMakeLists.txt
--- akregator-orig/plugins/mk4storage/CMakeLists.txt	2008-02-21 11:28:22.000000000 +0200
+++ akregator/plugins/mk4storage/CMakeLists.txt	2009-06-18 11:58:51.908746014 +0300
@@ -30,7 +30,7 @@
 
 kde4_add_plugin(akregator_mk4storage_plugin ${akregator_mk4storage_plugin_PART_SRCS})
 
-target_link_libraries(akregator_mk4storage_plugin  ${KDE4_KDECORE_LIBS} ${KDE4_SYNDICATION_LIBS} akregatorinterfaces )
+target_link_libraries(akregator_mk4storage_plugin  ${KDE4_KDECORE_LIBS} ${KDEPIMLIBS_SYNDICATION_LIBS} akregatorinterfaces )
 
 install(TARGETS akregator_mk4storage_plugin  DESTINATION ${PLUGIN_INSTALL_DIR})
 
diff -Naur akregator-orig/plugins/mk4storage/feedstoragemk4impl.cpp akregator/plugins/mk4storage/feedstoragemk4impl.cpp
--- akregator-orig/plugins/mk4storage/feedstoragemk4impl.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/plugins/mk4storage/feedstoragemk4impl.cpp	2009-06-18 11:58:51.907746085 +0300
@@ -904,3 +904,4 @@
 
 } // namespace Backend
 } // namespace Akregator
+
diff -Naur akregator-orig/plugins/mk4storage/mk4plugin.cpp akregator/plugins/mk4storage/mk4plugin.cpp
--- akregator-orig/plugins/mk4storage/mk4plugin.cpp	2008-02-13 17:45:34.000000000 +0200
+++ akregator/plugins/mk4storage/mk4plugin.cpp	2009-06-18 11:58:51.907746085 +0300
@@ -27,17 +27,24 @@
 #include "storagefactorymk4impl.h"
 #include "storagefactoryregistry.h"
 
-AKREGATOR_EXPORT_PLUGIN( Akregator::Backend::MK4Plugin )
-
 namespace Akregator {
 namespace Backend {
 
+K_PLUGIN_FACTORY(MK4PluginFactory,
+                 registerPlugin<MK4Plugin>();
+)
+
+K_EXPORT_PLUGIN(MK4PluginFactory("akregator_mk4storage"))
+
 void MK4Plugin::doInitialize()
 {
    m_factory = new StorageFactoryMK4Impl();
    StorageFactoryRegistry::self()->registerFactory(m_factory, "metakit");
 }
 
+MK4Plugin::MK4Plugin( QObject* parent, const QVariantList& params ) : Plugin( parent, params ), m_factory( 0 ) {
+}
+
 MK4Plugin::~MK4Plugin()
 {
     StorageFactoryRegistry::self()->unregisterFactory("metakit");
diff -Naur akregator-orig/plugins/mk4storage/mk4plugin.h akregator/plugins/mk4storage/mk4plugin.h
--- akregator-orig/plugins/mk4storage/mk4plugin.h	2008-02-13 17:45:34.000000000 +0200
+++ akregator/plugins/mk4storage/mk4plugin.h	2009-06-18 11:58:51.911735809 +0300
@@ -27,16 +27,19 @@
 
 #include "plugin.h"
 
+#include <KPluginFactory>
 
 namespace Akregator {
 namespace Backend {
 
 class StorageFactory;
 
-class MK4Plugin : public Akregator::Plugin 
+class MK4Plugin : public Akregator::Plugin
 {
-   public: 
-      ~MK4Plugin();	
+      Q_OBJECT
+   public:
+      MK4Plugin( QObject* parent, const QVariantList& params );
+      ~MK4Plugin();
 
    private:
       void doInitialize();
diff -Naur akregator-orig/plugins/onlinesync/akregator_config_onlinesync.desktop akregator/plugins/onlinesync/akregator_config_onlinesync.desktop
--- akregator-orig/plugins/onlinesync/akregator_config_onlinesync.desktop	2009-04-30 12:12:20.000000000 +0300
+++ akregator/plugins/onlinesync/akregator_config_onlinesync.desktop	2009-06-18 11:58:51.912746122 +0300
@@ -6,9 +6,10 @@
 
 X-KDE-Library=akregator_config_onlinesync
 X-KDE-ParentApp=akregator
-X-KDE-ParentComponents=akregator,kontact_akregator
+X-KDE-ParentComponents=akregator,kontact_akregatorplugin
 X-KDE-CfgDlgHierarchy=Akregator
 X-KDE-Keywords=akregator, configure, settings, online readers
+X-KDE-Weight=150
 
 Name=Online Readers
 Name[ca]=Lectors en línia
@@ -20,8 +21,7 @@
 Name[et]=Võrgulugejad
 Name[fr]=Lecteurs en ligne
 Name[ga]=Léitheoirí Ar Líne
-Name[gl]=Lector de Novas en Liña
-Name[hu]=Online hírolvasók
+Name[gl]=Lector de novas en liña
 Name[it]=Lettore di fonti in linea
 Name[ja]=オンラインリーダー
 Name[km]=កម្មវិធី​អាន​លើ​បណ្ដាញ
@@ -55,8 +55,7 @@
 Comment[et]=Võrgulugejate seadistamine
 Comment[fr]=Configurer les lecteurs en ligne
 Comment[ga]=Cumraigh Léitheoirí Ar Líne
-Comment[gl]=Configurar Lectores en Liña
-Comment[hu]=Az online hírolvasók beállítása
+Comment[gl]=Configurar os lectores en liña
 Comment[it]=Configura lettori di fonti in linea
 Comment[ja]=オンラインリーダーの設定
 Comment[km]=កំណត់​រចនាសម្ព័ន្ធ​កម្មវិធី​អាន​លើ​បណ្ដាញ
diff -Naur akregator-orig/plugins/onlinesync/akregator_config_onlinesync.h akregator/plugins/onlinesync/akregator_config_onlinesync.h
--- akregator-orig/plugins/onlinesync/akregator_config_onlinesync.h	2008-05-21 11:33:37.000000000 +0300
+++ akregator/plugins/onlinesync/akregator_config_onlinesync.h	2009-06-18 11:58:51.913745961 +0300
@@ -21,8 +21,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef KCMAKRONLINESYNCCONFIG_H
-#define KCMAKRONLINESYNCCONFIG_H
+#ifndef AKREGATOR_CONFIG_ONLINESYNC_H
+#define AKREGATOR_CONFIG_ONLINESYNC_H
 
 #include <KCModule>
 #include <QVariant>
@@ -46,4 +46,4 @@
 
 };
 
-#endif
+#endif // AKREGATOR_CONFIG_ONLINESYNC_H
diff -Naur akregator-orig/plugins/onlinesync/akregator_onlinesync_plugin.desktop akregator/plugins/onlinesync/akregator_onlinesync_plugin.desktop
--- akregator-orig/plugins/onlinesync/akregator_onlinesync_plugin.desktop	2009-04-30 12:12:20.000000000 +0300
+++ akregator/plugins/onlinesync/akregator_onlinesync_plugin.desktop	2009-06-18 11:58:51.913745961 +0300
@@ -10,8 +10,7 @@
 Name[et]=Akregatori uudistevoogude võrgulugejate toetus
 Name[fr]=Prise en charge des lecteurs en ligne pour Akregator
 Name[ga]=Tacaíocht Akregator do Léitheoirí Fothaí Ar Líne
-Name[gl]=Funcionalidade de Lector de Fontes en Liña do Akregator
-Name[hu]=Akregator-támogatás online hírolvasókhoz
+Name[gl]=Funcionalidade de lector de fontes en liña do Akregator
 Name[it]=Supporto di Akregator per i lettori di fonti in linea
 Name[ja]=Akregator のオンラインフィードリーダーのサポート
 Name[km]=គាំទ្រ​កម្មវិធី​អាន​មតិព័ត៌មាន​លើ​បណ្ដាញ​របស់ Akregator
@@ -90,13 +89,10 @@
 
 X-KDE-Library=akregator_onlinesync_plugin
 X-KDE-ServiceTypes=Akregator/Plugin
-X-KDE-InterfaceVersion=2
+X-KDE-InterfaceVersion=4
 X-KDE-PluginInfo-EnabledByDefault=true
-
-X-KDE-akregator-plugintype=sync
-X-KDE-akregator-name=sync
-X-KDE-akregator-authors=Frank Osterfeld
-X-KDE-akregator-email=osterfeld@kde.org
+X-KDE-akregator-plugintype=extension
+X-KDE-akregator-name=onlinesync
 X-KDE-akregator-rank=255
 X-KDE-akregator-version=1
-X-KDE-akregator-framework-version=2
+X-KDE-akregator-framework-version=4
diff -Naur akregator-orig/plugins/onlinesync/CMakeLists.txt akregator/plugins/onlinesync/CMakeLists.txt
--- akregator-orig/plugins/onlinesync/CMakeLists.txt	2008-09-03 14:24:45.000000000 +0300
+++ akregator/plugins/onlinesync/CMakeLists.txt	2009-06-18 11:58:51.912746122 +0300
@@ -5,6 +5,7 @@
 include_directories( ${QT_INCLUDES} )
 include_directories( ${CMAKE_CURRENT_SOURCE_DIR} )
 include_directories( ${CMAKE_CURRENT_BINARY_DIR} )
+include_directories( ${Boost_INCLUDE_DIRS} )
 
 
 ########### next target ###############
diff -Naur akregator-orig/plugins/onlinesync/onlinesyncplugin.cpp akregator/plugins/onlinesync/onlinesyncplugin.cpp
--- akregator-orig/plugins/onlinesync/onlinesyncplugin.cpp	2008-09-13 11:16:08.000000000 +0300
+++ akregator/plugins/onlinesync/onlinesyncplugin.cpp	2009-06-18 11:58:51.913745961 +0300
@@ -26,37 +26,42 @@
 #include "ui/configurationdialog.h"
 #include "sync/feedsync.h"
 
+#include <KAction>
+#include <KActionMenu>
 #include <KActionCollection>
 #include <KGenericFactory>
 #include <KLocalizedString>
 #include <KConfigGroup>
-#include <QAction>
-#include <kactionmenu.h>
 
 using namespace Akregator;
+using namespace feedsync;
 
-K_PLUGIN_FACTORY(OnlineSyncPluginFactory, registerPlugin<Akregator::OnlineSyncPlugin>();)
+K_PLUGIN_FACTORY(OnlineSyncPluginFactory,
+                 registerPlugin<Akregator::OnlineSyncPluginIface>();
+)
 K_EXPORT_PLUGIN(OnlineSyncPluginFactory( "akregator_onlinesync_plugin" ) )
 
-OnlineSyncPlugin::OnlineSyncPlugin( )
+
+OnlineSyncPluginIface::OnlineSyncPluginIface( QObject* parent, const QList<QVariant>& args ) : Plugin( parent ), m_impl( new OnlineSyncPlugin( parent, args ) )
 {
-    setComponentData( OnlineSyncPluginFactory::componentData() );
 }
 
-OnlineSyncPlugin::OnlineSyncPlugin( QObject* parent, const QVariantList& list ) : KParts::Plugin( parent )
+OnlineSyncPluginIface::~OnlineSyncPluginIface() {
+    delete m_impl;
+}
+
+OnlineSyncPlugin::OnlineSyncPlugin( QObject* parent, const QList<QVariant>& args ) : KParts::Plugin( parent ), m_syncTool( new FeedSync( this ) )
 { 
+    Q_UNUSED( args )
     setComponentData( OnlineSyncPluginFactory::componentData() );
 
-    kDebug();
-
-    // Init
     setXMLFile( "akregator_onlinesync_plugin.rc" , /*merge=*/true );
     KActionCollection* coll = actionCollection();
-    feedSyncMenu = coll->add<KActionMenu>("file_onlinesync_sync");
-    feedSyncMenu->setText(i18n("Synchronize Feeds"));
+    m_feedSyncMenu = coll->add<KActionMenu>("file_onlinesync_sync");
+    m_feedSyncMenu->setText(i18n("Synchronize Feeds"));
 
     // Fill
-    doInitialize();
+    updateActions();
 }
 
 OnlineSyncPlugin::~OnlineSyncPlugin()
@@ -64,54 +69,51 @@
     kDebug();
 }
 
-void OnlineSyncPlugin::doInitialize()
+void OnlineSyncPlugin::updateActions()
 {
     kDebug();
 
-    // The object that will do the Sync
-    feedsync::FeedSync * syncTool = new feedsync::FeedSync();
-
     // Clear the menubar
-    for (int i=0;i<feedSyncAction.count();i++) {
-        feedSyncMenu->removeAction(feedSyncAction.at(i));
-    }
-    feedSyncAction.clear();
+    Q_FOREACH( KAction* const i, m_feedSyncActions )
+        m_feedSyncMenu->removeAction( i );
+    qDeleteAll( m_feedSyncActions );
+    m_feedSyncActions.clear();
 
     // Fill the menubar
     KActionCollection* coll = actionCollection();
-    QAction* action;
+    KAction* action;
     // Read configuration
-    KConfig config("akregator_feedsyncrc");
-    foreach ( const QString& groupname, config.groupList() ) {
-        if (groupname.left(15)=="FeedSyncSource_") {
+    const KConfig config("akregator_feedsyncrc");
+    Q_FOREACH ( const QString& groupname, config.groupList() ) {
+        if ( groupname.startsWith( QLatin1String("FeedSyncSource_") ) ) {
             kDebug() << groupname;
             KConfigGroup generalGroup( &config, groupname );
 
             action = coll->addAction(groupname);
             action->setProperty("ConfigGroup",groupname);
-            action->setProperty("SyncType",syncTool->Get);
+            action->setProperty("SyncType", m_syncTool->Get);
             action->setIcon(KIcon("mail-receive"));
-            action->setText(i18n("Get from %1",generalGroup.readEntry( "Identifier", QString() )).toUtf8());
-            feedSyncMenu->addAction(action);
-            feedSyncAction.append(action);
-            connect( action, SIGNAL(triggered(bool)), syncTool, SLOT(sync()) );
+            action->setText(i18n("Get from %1",generalGroup.readEntry( "Identifier", QString() )));
+            m_feedSyncMenu->addAction(action);
+            m_feedSyncActions.append(action);
+            connect( action, SIGNAL(triggered(bool)), m_syncTool, SLOT(sync()) );
 
             action = coll->addAction(groupname);
             action->setProperty("ConfigGroup",groupname);
-            action->setProperty("SyncType",syncTool->Send);
+            action->setProperty("SyncType", m_syncTool->Send);
             action->setIcon(KIcon("mail-send"));
-            action->setText(i18n("Send to %1",generalGroup.readEntry( "Identifier", QString() )).toUtf8());
-            feedSyncMenu->addAction(action);
-            feedSyncAction.append(action);
-            connect( action, SIGNAL(triggered(bool)), syncTool, SLOT(sync()) );
+            action->setText(i18n("Send to %1",generalGroup.readEntry( "Identifier", QString() )));
+            m_feedSyncMenu->addAction(action);
+            m_feedSyncActions.append(action);
+            connect( action, SIGNAL(triggered(bool)), m_syncTool, SLOT(sync()) );
         }
     }
 
     action = coll->addAction("feedsync_manage");
     action->setIcon(KIcon("application-rss+xml"));
     action->setText(i18n("Manage..."));
-    feedSyncMenu->addAction(action);
-    feedSyncAction.append(action);
+    m_feedSyncMenu->addAction(action);
+    m_feedSyncActions.append(action);
     connect(action, SIGNAL(triggered(bool)), this, SLOT(slotFeedSyncManage()));
 }
 
@@ -132,7 +134,15 @@
 void OnlineSyncPlugin::slotFeedSyncManageDone()
 {
     kDebug();
-    doInitialize();
+    updateActions();
+}
+
+void OnlineSyncPluginIface::insertGuiClients( KXMLGUIClient* parent ) {
+    parent->insertChildClient( m_impl );
+}
+
+void OnlineSyncPluginIface::removeGuiClients( KXMLGUIClient* parent ) {
+    parent->removeChildClient( m_impl );
 }
 
 #include "onlinesyncplugin.moc"
diff -Naur akregator-orig/plugins/onlinesync/onlinesyncplugin.h akregator/plugins/onlinesync/onlinesyncplugin.h
--- akregator-orig/plugins/onlinesync/onlinesyncplugin.h	2008-09-13 11:16:08.000000000 +0300
+++ akregator/plugins/onlinesync/onlinesyncplugin.h	2009-06-18 11:58:51.913745961 +0300
@@ -26,34 +26,56 @@
 #define AKREGATOR_ONLINESYNC_PLUGIN_H
 
 #include "plugin.h"
+
 #include <kparts/plugin.h>
 
+#include <QPointer>
+
 class KActionMenu;
 
+namespace feedsync {
+    class FeedSync;
+}
+
 namespace Akregator {
 
+class OnlineSyncPlugin;
+
+class OnlineSyncPluginIface : public Plugin {
+    Q_OBJECT
+public:
+    explicit OnlineSyncPluginIface( QObject* parent=0, const QList<QVariant>& args=QList<QVariant>() );    
+    ~OnlineSyncPluginIface();
+
+    /* reimp */ void insertGuiClients( KXMLGUIClient* parent );
+    /* reimp */ void removeGuiClients( KXMLGUIClient* parent );
+
+    /* reimp */ void doInitialize() {}
+private:
+    QPointer<OnlineSyncPlugin> m_impl;
+};
+        
 class OnlineSyncPlugin : public KParts::Plugin
 {
     Q_OBJECT
 
   public:
-    OnlineSyncPlugin( );
-    OnlineSyncPlugin( QObject* parent, const QVariantList& list );
+    explicit OnlineSyncPlugin( QObject* parent=0, const QList<QVariant>& args=QList<QVariant>() );
     ~OnlineSyncPlugin(); 
 
   private:
-    void doInitialize();
-
-    KActionMenu* feedSyncMenu;
-    QList<QAction*> feedSyncAction;
+    void updateActions();
 
   private Q_SLOTS:
     void doSynchronize();
-
-  public slots:
     /** open the feed synchronization management */
     void slotFeedSyncManage();
     void slotFeedSyncManageDone();
+
+private:
+    feedsync::FeedSync* m_syncTool;
+    KActionMenu* m_feedSyncMenu;
+    QList<KAction*> m_feedSyncActions;
 };
 
 } // namespace Akregator
diff -Naur akregator-orig/plugins/onlinesync/sync/akregator.cpp akregator/plugins/onlinesync/sync/akregator.cpp
--- akregator-orig/plugins/onlinesync/sync/akregator.cpp	2008-10-30 16:16:09.000000000 +0200
+++ akregator/plugins/onlinesync/sync/akregator.cpp	2009-06-18 11:58:51.911735809 +0300
@@ -126,6 +126,7 @@
 
 void Akregator::update(const SubscriptionList & list) 
 {
+    Q_UNUSED(list)
     kDebug();
 
     // Emit signal
diff -Naur akregator-orig/plugins/onlinesync/sync/feedsync.cpp akregator/plugins/onlinesync/sync/feedsync.cpp
--- akregator-orig/plugins/onlinesync/sync/feedsync.cpp	2008-09-13 11:16:08.000000000 +0300
+++ akregator/plugins/onlinesync/sync/feedsync.cpp	2009-06-18 11:58:51.911735809 +0300
@@ -22,6 +22,15 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include "feedsync.h"
+#include "treenode.h"
+#include "feedlist.h"
+#include "kernel.h"
+#include "aggregator.h"
+#include "googlereader.h"
+#include "akregator.h"
+#include "opml.h"
+
 #include <KAboutData>
 #include <KCmdLineArgs>
 #include <QTimer>
@@ -36,15 +45,6 @@
 #include <kstandarddirs.h>
 #include <QDate>
 
-#include "treenode.h"
-#include "feedlist.h"
-#include "kernel.h"
-#include "aggregator.h"
-#include "feedsync.h"
-#include "googlereader.h"
-#include "akregator.h"
-#include "opml.h"
-
 namespace feedsync {
 
 FeedSync::FeedSync( QObject* p ) : QObject( p ) {
@@ -160,7 +160,7 @@
                 QMessageBox msgBox;
                 msgBox.setText(i18n("Some categories and feeds have been marked for removal. Do you want to delete them?"));
                 msgBox.setIcon(QMessageBox::Information);
-                QPushButton *noRemove  = msgBox.addButton(i18n("Remove nothing"), QMessageBox::ActionRole);
+                /*QPushButton *noRemove  =*/ msgBox.addButton(i18n("Remove nothing"), QMessageBox::ActionRole);
                 QPushButton *catRemove = msgBox.addButton(i18n("Remove only categories"), QMessageBox::ActionRole);
                 QPushButton *feedRemove  = msgBox.addButton(i18n("Remove feeds"), QMessageBox::ActionRole);
                 msgBox.exec();
diff -Naur akregator-orig/plugins/onlinesync/sync/googlereader.cpp akregator/plugins/onlinesync/sync/googlereader.cpp
--- akregator-orig/plugins/onlinesync/sync/googlereader.cpp	2008-10-30 16:16:09.000000000 +0200
+++ akregator/plugins/onlinesync/sync/googlereader.cpp	2009-06-18 11:58:51.912746122 +0300
@@ -114,6 +114,7 @@
 
 void GoogleReader::update(const SubscriptionList & list) 
 {
+    Q_UNUSED(list)
     kDebug();
 
     // Emit signal
diff -Naur akregator-orig/plugins/onlinesync/sync/opml.cpp akregator/plugins/onlinesync/sync/opml.cpp
--- akregator-orig/plugins/onlinesync/sync/opml.cpp	2008-09-13 11:16:08.000000000 +0300
+++ akregator/plugins/onlinesync/sync/opml.cpp	2009-06-18 11:58:51.912746122 +0300
@@ -149,6 +149,7 @@
 
 void Opml::update(const SubscriptionList & list) 
 {
+    Q_UNUSED(list)
     kDebug();
 
     // Send signal
@@ -157,6 +158,7 @@
 
 void Opml::remove(const SubscriptionList & list) 
 {
+    Q_UNUSED(list)
     kDebug();
 
     // Send signal
diff -Naur akregator-orig/plugins/onlinesync/sync/subscriptionlist.cpp akregator/plugins/onlinesync/sync/subscriptionlist.cpp
--- akregator-orig/plugins/onlinesync/sync/subscriptionlist.cpp	2008-10-30 16:16:09.000000000 +0200
+++ akregator/plugins/onlinesync/sync/subscriptionlist.cpp	2009-06-18 11:58:51.912746122 +0300
@@ -22,11 +22,11 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include "subscriptionlist.h"
+
 #include <kdebug.h>
 #include <QStringList>
 
-#include "subscriptionlist.h"
-
 namespace feedsync
 {
 
@@ -118,6 +118,8 @@
 
 int SubscriptionList::indexOf(const QString& iRss, const QString& iName, const QString& iCat) const
 {
+    Q_UNUSED(iName)
+
     for (int i=0; i<this->count(); i++) {
         QString m_rss = this->getRss(i);
         QString m_cat = this->getCat(i);
diff -Naur akregator-orig/plugins/onlinesync/ui/configurationdialogadd.h akregator/plugins/onlinesync/ui/configurationdialogadd.h
--- akregator-orig/plugins/onlinesync/ui/configurationdialogadd.h	2008-09-13 11:16:08.000000000 +0300
+++ akregator/plugins/onlinesync/ui/configurationdialogadd.h	2009-06-18 11:58:51.912746122 +0300
@@ -22,8 +22,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef CONFIGURATIONFRAMEADD_H
-#define CONFIGURATIONFRAMEADD_H
+#ifndef CONFIGURATIONDIALOGADD_H
+#define CONFIGURATIONDIALOGADD_H
 
 #include <KDialog>
 
@@ -54,4 +54,4 @@
  
 }
 
-#endif
+#endif // CONFIGURATIONDIALOGADD_H
diff -Naur akregator-orig/plugins/onlinesync/ui/configurationdialog.h akregator/plugins/onlinesync/ui/configurationdialog.h
--- akregator-orig/plugins/onlinesync/ui/configurationdialog.h	2008-09-13 11:16:08.000000000 +0300
+++ akregator/plugins/onlinesync/ui/configurationdialog.h	2009-06-18 11:58:51.912746122 +0300
@@ -22,8 +22,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef CONFIGURATIONWIDGET_H
-#define CONFIGURATIONWIDGET_H
+#ifndef CONFIGURATIONDIALOG_H
+#define CONFIGURATIONDIALOG_H
 
 #include "ui_configurationwidget.h"
 
@@ -46,4 +46,4 @@
  
 }
 
-#endif
+#endif // CONFIGURATIONDIALOG_H
diff -Naur akregator-orig/plugins/onlinesync/ui/configurationwidget.h akregator/plugins/onlinesync/ui/configurationwidget.h
--- akregator-orig/plugins/onlinesync/ui/configurationwidget.h	2008-09-13 11:16:08.000000000 +0300
+++ akregator/plugins/onlinesync/ui/configurationwidget.h	2009-06-18 11:58:51.912746122 +0300
@@ -22,8 +22,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#ifndef CONFIGURATIONWIDGET_H_
-#define CONFIGURATIONWIDGET_H_
+#ifndef CONFIGURATIONWIDGET_H
+#define CONFIGURATIONWIDGET_H
 
 #include "ui_configurationwidget.h"
 
@@ -55,4 +55,4 @@
  
 }
 
-#endif /*CONFIGURATIONWIDGET_H_*/
+#endif // CONFIGURATIONWIDGET_H
diff -Naur akregator-orig/plugins/onlinesync/ui/configurationwidget.ui akregator/plugins/onlinesync/ui/configurationwidget.ui
--- akregator-orig/plugins/onlinesync/ui/configurationwidget.ui	2008-05-21 11:33:37.000000000 +0300
+++ akregator/plugins/onlinesync/ui/configurationwidget.ui	2009-06-18 11:58:51.912746122 +0300
@@ -91,7 +91,7 @@
      <item>
       <widget class="QLabel" name="lDeletePolicy" >
        <property name="text" >
-        <string>Delete feeds</string>
+        <string>Delete feeds:</string>
        </property>
       </widget>
      </item>
diff -Naur akregator-orig/src/about/top-left-akregator.png akregator/src/about/top-left-akregator.png
--- akregator-orig/src/about/top-left-akregator.png	2008-06-18 15:42:07.000000000 +0300
+++ akregator/src/about/top-left-akregator.png	2009-06-18 11:58:51.903746150 +0300
@@ -1,33 +1,58 @@
 PNG
 
-   IHDR         OΞ   sRGB    	pHYs    B(x   tIME
-VL   tEXtComment Created with GIMPW   bKGD     #wIDATxřN(KHB	b^3c{Ϭ =̱aMA$I<Yع}wvFݹJ}jj[CUOAJ([_VWW2̯̯le~e++[__VW22̯̯le~e++[__VW22̯lClLSHb 1"crz7KLLrˌƀ  Ei
-PFRD#+7<{?j8$j"J<r!R2FSL15iuPv@]^^4x{!By>V$kTSMjhLP}iC^evPGlG)*LUicJC؈:A(%24Lh^ ,  x35P3`008Z5G5ΉbD
-L3"RDN
-RATD 6T5"Pc$P#R z$ohmz.T9!0"9/0*p9;;:ꠤ@j_aD@*5OOrؔ|d(B:4p-jbZHu(`Dj'	xѡ5lf%>E}`ǽUk1pIj4\DBhh)3siP5gYC#E$YpQxf](ԵK	[*4!4U>t`j0wy8Qg<x-Sܽ< _tq!U\RtȦL˝014d0c2rFvgA3?DF	5@sU!?	#Mj9$A"sHw&}4?]8'i+%y[ɬ2%o{ȭ'FʇQL==:?@BWtڄ,؞qQ+A3w|/v$q$C)4/|Cf~Vo)3PE+Bs3sI@]y5 fSd۾?ӧx8]AFƏņS³n"BS*0]U7L}yc^PdIQI1E{+J׵7ށW&ao@.7V'Z2q]ƊeOWda!l` yT7|4a`ǿvuib(*etxsah*	?/-x#
-]i5j2lM%dq(ܒ	Rv4m'[G[lϰa'-DL ϾxZ>;IDїd:q^l?TWE$s3"X--vGom޸XôO|9o5ʗBsظ7\d2?i̧Wọ~y2Ky
-3!`\$Bt	9TdmrÙ5s ܸv<Shp};rWHT
-GyAɊƝ܇J|D\N$`-Ƨ,fAk[tSd6oAxqPO '5zKvAL'|/-1L:"}t~@Bloxә2t o_KO<kQyyRaRcd̿SG(NW1FN>ǗOOi,1rHXI	S`H!	vF$q6{7lsLƯn؍U3OT,ZT<펭Z~з.Əqgmk|6yTKUHns/o	ftx6'{KxH0
-ݲfHA:1J7NrOr0Gy6{=r~9wr^rlL1Rԟ/yI:!0Z=qν1w6N? 6g@`pܹT^&Wgnb8R/]tܘG}ns/]7s/pLmp: r?d@z7dr<DpLDiB``u,RFǠ RfB1XLcΗa_.NaP-ՙ'qB#U يy6'+>lu4IG`c%?BhjqV@]gf\R"D]bCrPy0}`	H`<X!CcM G7rR8vWB x?7晖lqyHb NMFSK19&whJ~v9=@L1L>	Nbt;&2lGіP!C#Нay]+
-cH̽KFmtXh@e?Q=c_矌W][/tx.xWrT3v:FH0<eudtX1vXdrt>k+kDb(Zh>ZOj
-,>l 8<;:y<_vEw~ޅ^#M>5B`%#
-zolO|>tR_naOj\Ǖ':C=FH3'`;tx%K6vf୛`
-`H;Vh;A
-)92B'8cWrFqO_·۠=Ҏ[f+Ӈsu q}!+i~ܰl-}µ AB0}s8.tw	%53A<Q	"l>| V)C:A?7#%x^7%F XX3gQEb>NyV`M^vV
-#:|ӵhX`YyO,>.Y0&X[AZp-0H);u졮?g0h{ԙ`ni06y0N߄7tF$Jyy6IlB.-TlݏÆ*&ìo `KJ0d47:<_8[10Y>sYZ40|6ߠ`!7h3|J$G҈ ~G"SfV_3G9Ã H~e+1|ÓLۀ0\!|tL8S 7"AƸOO>o~ȮIρ)gRN~jz7L*@:n84s5#| 92\5TD_QΣtRg#}Lö@-pTO)ava@ƛ܌9G)?X#~VYg=8A.Dd^ >EN,սüIITTH=P޽`{#ޜ/m6ԥ&"L	\[ !H2b Ck&fvX1ir .~|SG~8#pķOy|hZ`Cr%@C@aulKV߷s	2&yQC+fd傥W5}`d)C -5_YdE?ˋMY^g<8/xYI$(G;O羇>:!~釩Bppүa@A#Ԕ 2|@Q<=3&>>k;,F?:dDxbc?=/xi {ߤz6Tc'
-TMmepp-=gW~Z_z<	׼NFjUk&5T%o:cl$rAx#?rUUՕW^kCNv̾
-A[;ݵ!b#v/JWs_U_F]^PǀC?nQV	?3WmˮWOF8Z9%>%fA(h
-,	|H([1EV}l)YU6mҜ9g͚1yF{Deu)D1L7/Xޞ2~IWD엾p?p3R4i@!D@=!퐘<U<;-.g0SLr c^y'O1uj̙ϘޞH$!p_@ifPUTT|oeghD:g.`4zF
-z_Sz,2!F7J$ 	PYU}Ϙ1F}}]KKsScS.[o~+Ua>g3x7_w'Yzveب6/T9007+lt )Wۙ駕B /i<n&c#>c;p6)HK}yW.4gCfZzdT40<)Mv]*vSD(JwR(e'O^dɦM_͟?d*U<=	5ѓȯ&`9_bSzoس!&ߣ2̓\P`<|	P䑲s WnVZ"bL?ؓ>Etk%w嚹sy<I8nݻl۶Փ:&(E};WwУ =6b$}`p̭P=v<	vo/T1z
-iFx30%sɽ-uzc5&V ݵoMgO2kgoaCC</wܸ|W!f.?p̙3w~躺k^W\nڗ^z_'.i-m*0rDl~Ba 7!Q׺kq3d|Ȟ.%HKS+6߹-IU[>p.Kn8%o9"\j*9vRA>MӰoOj/[ؔ} `H[n޴i;~痲YJ@]#9m( Kx?3E*f~A^i]Л;ZӲ7,1YSS6mrX~\{\XH{4*{ӟTS]bB*UX;C>(*e0i&F#QSSӝwqE#φYjdF`5f5 MC!LxG΃3z^>yhsZTnXeVEJK:6&Ogc4jw:I}SyÉpѰ#m>&f:2S޺{K Dg{TbhoVYQb1sg{ڴi/usp%[AB(
-v؈vf|PVOol*:X̝PЧbI٤|fjɎZ ;Y^Tںu]1,۷  8iZ&
-AbR;'jdr3Ibg`":cwuu	5QFPHD  4kp<ۮǞX<{	t՗(/MA1Dِg;m}B;EJMF]ST%eerĢ(xKU$m,:JhWnOh ,ǺpKܵ7 ᶋo_jѺE X;a"c+!Ѐs{ٷo&%jμdYYuCGHȬK+^ZuNWəvd_W#zP#I5&jXuWRSilt&jjV6McmYQ7)"pF:oKr2ʏ@!E\},+8VQXn}4m>2	2/~F$$& PVUa]߿l2F+~ $2"VDE<E7}F"Wm;ŋ@PkkI$ٴܸo<7bILiK8Nu^C12DB,T4Ո05Zh٥GIMCŦ!`\M;l,}-2-$RE+ O}Aر}5kP|\zHh0㌶k&!Iīj:-Y/%Hg*1=l֐)uv|c*@T6 ڄE=	 e6U	6~5=tt1.#Z:lfM%GHZZrtF;.# JNmdj &1Yaʎ߳c0^Bg?eÆwqcO9!L&ISܗa$V|exoFoo/L |fz	MsI,֑֔p80BU h %Y$J7&zPJwL {S1A9.?>3Ǳ;ުZ3AuE%oL6dj	Er>w߽ի/ҥKw4F\=*"L Ċp8T]t|_\j5'T=huS XLf".zj+")z"5+J	[Wث1v *ar=x4$IRD2f"1f+F
-9	ʉsXs/ܾ}͛q!⇷CD_B`PB4TMC'y=W_u|%GqW3i3D34M0dC0MWlF#	=!5$2I "n幮iCo*i/^rJ.~>+F6
-'eֹ'g&ٵC&ȏ07҅hi9oZvF7bxnsXJx;l"$L^Nc<ĤF,aiOZ][O~S0 `i{1&M6Ar&N*Tf9MG[A14ԐSXV
-#Ԉ juٹ=w)W\}=N5X{qWN\u>꣞[h	fqѢ5)0PMF~YUgR(iK]]wb)PTBa1/EX)"#q~޼-[>̚5{Yr>OP4k^׵\6m0"E++ñfj]7MUSC54+BCySgU.Lf`[G;7|5U5knx7fo4tjx&J3; ܷGցT7<\3W2w}KyRJ-eYƸBD.Xb]h! @L'`K6	p!_fZD<Ǎ,k֦#]׿/OqX}iR\1?w?*`ןLNT&./q޹S)D$5pf3YUVUW#c R(+y>c\` /0$
-52Xi-_$
-{}wμb4i7%#֩o[ޟx;)S: 3&Itתn<$"[gȾ]x3ʭqca.Cm!B
-_`GM[Y,\H{$ۿM&.)\-L?v<yQS9niX g^rO;}֬?7."LIP OMSK>X:bOQ5sVp{qNWÿ}=m3-SUOH]|vN4i4	4-Z8e̟=?bVՠq{m|5Ѥ)7!:NGgXdg+^{/[컨΢ZX`nf\Sӄ/}ztX8;Qms})>hA
-*f_)T 8{.u}J	B,<KB=֭D+Kws={s0K: 8Vyh!o0#da~9O-C/wY`-{_?K:!A9zK &h7zW0IA Nܾ %\s `bѸe
-ZN8c//84|5W_{E|ɵ55!||BU L[YV5>%Lav'N\`g؄"xhq@/Xߘ/Gxg'p]²B!#i$c0xO<aY90E,ocm9}.߳{}ݷrKv<ǋZ攕X={ܱvZRAA`e~ ~a\< nHg2XczʣV]
-yf<?+hV73J eke~e4VWFleYơ-!#Y    IENDB`
\ Dosya sonunda yenisatır yok.
+   IHDR        *i_   sRGB    bKGD      	pHYs    B(x   tIME-.1C   tEXtComment Created with GIMPW  ?IDATx}	չ[30&(5K;75q$"J.MD@Pd_Ge٘}饺u׹kʞfdn>Y8թS58P)~wdInAȺggcI5, (Sk>j]U4G8 Ryz3Nj1dMZjLZ`Da (Z'@@n^و!UJ+< ,s
+ӚMƿfNWbk2O1#^`?a3U Hfa#Xw8PT &c~[V<'>je9|ȑێݩX!u>otfx7n9#' x?\(7vɍOq Qj[㾗:ŷo˱iǰ^zu͜W^;PSX7hP}2"-+~[rݮe~_6fG=-999)9tW K<@9]`dW w}Z7_Uouc|F@y2X;Pnt-WbpeLyCkɯQ[lNKFdt̲,NcJY("V"?F8.38"0:57,Gl`]gG1Ala˺F`'@FgjW1SA7CI2D}1X1RM"8:ZЬ|С<	KM^^8-2XVV=zپ[BNNg/7'p2(ROp p-|Μ9n}<㱒Gg޼uS`x)!m@n0gum!^+(8ѻ{q`J|%[Q*ݹsg o)8^*++ӏ=wڵ 65BAr!$eQXf@w$x+PzL\e̘o8v~̣F4F,e<៿S3_TĀ-!E]5Qb6@U^_zpQb֝2n͐΃96;aRC
+F)J6 L#+l0=`s4ذF6B&/[k0hyyb*͝~ QZ`Dw1	Jì$~(Te+`O#sM/n^xpؕR!:m6%/-ATOWEQ9 &ř{1.ʠ'MxZ_
+ FcV󡵽ն*8l*8c[sVO0M6l"WUܜkv5Y4LCgE*S/|NƏg_?BU Znbb)10̴ʴ- 	FoҞ4TTT0d8JQpʃDlش$`C7{rTFL}+,,؆Y;v@xOxs[.OSڽ9Hr3$99<*:M:.~(
+nul;ߝzǀs.(ϕ/15%%3fBxe^+\]ߺuk[o<'6is<SiDp8cmlqi2Adӓ
+iae] z~Gp=<7U,>-F0~xwVuS>$e!PUahPRtcA/sըFdd/6AP9QW6ϋ>2j(EFa߾LQ]0;YcoWԕaݡ,ۍj
+Z%ݢiQ!glMR̥qCle;M@jM /uk@vؔSiz8baXߘ'dy+@iPp9"R~}ʂic	̓C6-fP]ƈhSH:d}Jw:*jvI
+afSR`m6/3^ 8|64F#N'î4`ZA"o7H5)BB[
+#0m`|4ۗSmȼmTJ1@8+`p*ɔMFѷ6+	j}bM1v:Ϯr(Nd"oGqӈט-伕ڰ#FpQ49)(]B-kԳcMLgfQe5}7mڤqJyj/U{P!ϾG|Ȑ!|ԨQ<QUuC@ذG+>5j5[-;bͿ(O Ut	c]&н{w>s])(BD$?y,N.V5d|kC֢~=xm_<`_={vx޽)K
+{F,ӻu#%ߋIlx<[й	L{j:t6QNOKFd۷;ZҽKKQ~"W3nݒQty^7pzz*twBUU}׍Vih^(M@y?CP45{0Wq-[0-Q?ll)qؔWMƊP;Hts$8*yeaʙekw"Ȓߡz<OFiKG+E#'A⾰?g3~=Ԃ+Uy@u(R\Vt:+Xcף,W.4tLE \'{K(x=8o޼>h̲Yۿ4M.qSnq8O^ E'slS4==~yVx<ay͛7O<x_}	#D&':"s\D1@m~ ~ovJPsz+Y/Ao7I^AX|fo?ya0 N4bTI$DpHq\%1'5j
+Mx8h z45w`v$~pF,pg=LX1li	NH\d֠!XY ң0H\g/pSQLLhEZ-OFVGLnZ-&-F#Xy3Q'1db{m-uqQ
+b(؍(}
+mԼqW,#,+=gŔeʿe;/NgcuCNk($HL8!x{e[c9]-,"g&X"""۳muK>2<Ik{"U!jm"r`yNPBA=k "J/"l%-8P
+>b҃.y
+-Wl|@X%x*Sbn4{!PvYbEjw`u:P]z*2J @xcIY2<<xK!Κ
+R\sQu6%H:ԁP%rY6.,]BxP|%P5'4ؽʰ1Kg/&;+'q˩ށ(nO+PR^%=_Rja?hcE|)n'Pns3>4 <2girح.0b$M~U.$ЊrǀEi n[lI'lz/`]xXzˁWӬ?kz{aI{#Xwڔ_r3f} (}8i4s_fbm2X(|~b(ּ,Ez}e5=0dEѦJGЁDt5~L6)bWvw~Ω7ݺ1K -7^{tt92BQ,H舸P,1El+`.+HXQZj|bjjjfYkHM^U{)jϬS^&Sl:(Xv;E8F7n_v&jn֡76g':l/("i~yyy'X!ޭ}`oy/ǋR;:tN/ѓ~{=	AWb-*cJ9QæލP^jeA95#']CAil(SkW<;8x 0bd<
+tx&ڲ^xpċADn" Zq~s̙BZ	P!t|<O=S:df+.Eߊ7	5ţ)ҐWF8VQTR2TVFo\|BFFݵš?@9h 69-kG 7tv3%@eU%p? |ŋszD1Ne$eѾ'%XP`}hB{dez}H~xC1)E
+ZP|CeDJJYc؋+q K']: FdU!\K]u]gXwQSa]=heF@(AL!v!+>Ni9I.cz=VFXcuեEjڭC'si0(Lp]*Kƺ&ԴDZVw{h89	T.N+ՑEM8Ta@Ӹ^=RiI]]ܹsgyS^l𧁖(nu\s'N:^zrҷ42`p(ġx9c>9s΅j/wr(ǡ~w{|			}`A!SCUUyK^kb:t۷oSKO֌FFb+V@ O`\5ku%SD`<1NjȎ\C\HGxW
+:cCH&O>{# F= !.'6!
+<mPpz6ynțŚ ~9ZpNFXS/es<YPR:CIB41S,`
+jbyFGI_[?ɸ%H&fDpPw*DP=0MCO4$׎Ġ%|{XȿAC>#֮kXRNpz7րyRzp'Fo"*
+&0Ģ\N93;i)o
+k;I`HaA㬳
+Q;%9=z]1UЫ ʠ&P4@u=_@J~8DEDf`EbzG[(k%F+"2D޾muR<}}s8>R{]WQãDK)E 6%ia[c̚	@z|z_ZS7*9Uz;OSffH [D{d|X1<aB$kQ9!8K{d1Dc1EB!|VH<nO)u:ްwؚZ'bK`}&0~/= XT֎hMe-"m3f1!RL[mɐi4He'vm1˥@ZL.Cq?1b1/Iv 8&ƙ"A4umKO1F<ͨaeLheOmŤ=bey5B AfSd._Bq&qAXw)0m<jGs{zLu%H!a[Wպ`+3{z1.)&?j 8riv`ގy\i`pt..v$a{C&X,v01d1LFt%3$QG=h1HHXL@ &2ۆe"pUS[-(hK:)@k y`q 	Dcb\[RDp8X% 9(;'p[xwIv:V|63vHȈUy1=ښ? Ґ[$ס]/"q)O9F	 X}KT8ƼA"fȨmf­vѸ2Ҫ뀒\V'ktAi2HKÆ[1ZEQg=ylDyNyCתolrR$R )Gɡ0u<!p=]L98WXuZ"%GٽCMn`ʡha,uCMl؎)/i.$ϧͬI Y.]?)R<3r| d[ 8!==mg<7I֋:f|i<?V]	4N$}V~,p.6Aq<{z&JqֳZ~βw޷|cׄH,5=sHB֡>X>j`Y+]ƹQ ?^xptcLjI`i
+ojL!vyzŊUo=R6godr҇@@>4(W|+g,+Z=(iNYGSs<GӍ_9܈GÆN.yPߘۤ{eG}۩n=<nVn
+`c0r0Ln?OÌ=9Ǧn^R5F+߉>7Y˕kVouF?$bp.V}＿ނE,lUK/Ygx
+дE/nr-(^Rs2 *	!qg<XUѻr>5551R1
+AJ71Bw[OOƙ- 4c$:^B>4|۴(dyOl=59زu__(ynn.߽{7""mI;(ô77~ہw1u{7Vfg/s`Aӑ)3?;=_+aρO+:\_gӓU﷘ٳg'h~d7n"Q^|ҙ!fS1{rG[
+.q^gxJ"/owT1i
+d
+P. gO>%%% <*;O*_IJ+@]A_]"S_bFeu*ۿAԙtTktռ]PlC*nY=ѿjRZZ`id1=#ҬY9rijKĬOIBcCzEH,P~0#MCăSڌ>UQT!L( 83`0^Hr!A2p~&vF^!V Qq 'a{k`>n9FL%K.]*h<H5#Up_֪ ~UT+MΊ4ЧW'TTRjp1p^.jK1C~SrK<]/z߈o.|'jg;~ѳ`=5;fGԨL1`/H@xmt f!X{Y?e#M>T8ȘQr+J$]W+ȦLAI %1!H Ayo>p^s|&⓿m-3*>:$X]2t >#MH@o(N!b'bGQ_wD_sfm撣ٵR@w@Cx
+}.Dp'# 7[ j Hy%RJ+Lʓ 3~|݉g2\=	-, qLj	)QΠi@PT)ɏ\2bRѱcgwabN!J$S|}Y ,3$jPgfLՂ~&sk>.')
+)zW4qTCTq"j_cxOG[PY':ce2^Pgt9BaАMwpnS/},V ONFlwվcE4Iu!4G]a=f}x)eГNazB*gj:gF*1ݩ]$@edNN%D<P`}p_PCb D,+_5)/WH!oJRq*
+RYXhu.4>o |жCRĮ"WH>i9	}W]u0WBbਗ਼j+U΂#Pu44zɵ;5봠:i/zuϞwKyNp8\[o	<qL!T569!wYgPGԿ4z:GK	GffUG}~E TWrp/ qiܩi\W8yyڻ(9rݪefz-3Y&Y!@d_#E*S|yP
+DB!!>ed֞齫}Ws)j:H8[k?E,|ٕ EXjil9`'>ޘr66{B@6}b=+euP9?#R]ETBAz5ŋ7қt랯}xF`0W-CPz)>UNU#R=t1%/.@`8Lo?~)r<}UC˩{=r`kL4~jbX*[L,aKXZ{x'Ow3h)njB^}gP]iAN:3iJoIA1*w{}}H$\|C}1 B=ř F#ZPTyxI6@MRZqAҢZR^=2;(ݲeK.v~AAՇ,s}@>,A5%_l˟VP?!x	R)"91ac0o62u3k+ +oAڊMdE6)2 څ Yۉ]uw>\?܇'աz:(Rd㶠D2M> X ł%"  -R!Jʂg+H gSt	+!tNV H-w!1awV%w_L9$lyIImZ<L6IJ8d$800[I9|[]#TXn!/L^>!H$Np]p,-<)ɿA|LT.UĭvN~ ʂ{#P3,3,
+#R[:0\n{IJJLթ*2 2l-PLj;"8:l;4lt<t6G" |BT~9#|Tע)zcX0@9k d<3֋`fwE:z XSk^;kϰ.>H	~q^Ϣ
+Fn=_Ȅ#ei׭4`9WJ KlZi+	d 1^ϳBB!mGçOZ?Ͽ}\V}-VxNB~ܰ0@ȳDmW8s2y؈IW_?W5g?}	apߔl<I8xXTebpx*ϰdm?ȿzwAyx$w;np艈#=yo':gS>$(\i̓ȋŤPǒHSV[.1	x1
+?/OXA<v0ǈ}(fZxԊG,DC/XX;`aPQ	)G( x._DNr`ԋJC1:b*`>=Q~DzcIhg}->is_Q0<PmXUm6t}6ݏyΟ}<ӈ=5
+1Zu0FZڂAIQ}j%O#b
+ӈb*]cT>^˵nh:K@(-UEn111ԲKd~mG%HuJLz%_JA:Q+TS	e]ǻwYG)U)?+cp>aG=@b?ϱ:IYw
++-&"_>8=<[X2#:^_vx>7ugv؟S7l~Bo
+Κ
+`i!]MJy#qZ`9)m#U2Sޔu7"{z`WB m/[pdR /]q`LEe[><FUʛ ʿ!j1dFS
+|ؾ`֐/ޒRC90hX*QA\^`rC~oTL- al7~%&O̴H=S~Y#.k03ZnO#te]"L|{'Tj&t9$HLa= =
+OL5Jg\<%|m_enXJ'C¿.=lA}
+iPTޢ4BQj)ϭN\<{yaP2	d3p/<rٟ,:}<ջSC3>	L<>pb3o-o˲{=ZǁyNqE=_̹`@l$F2+s	<·\Zuß cjq8՟h? tuT^I6?8
+8EdR!mx	`TbpMG,n}g&@FRym^ v,"[8>k}UX3h'4'OCSyL}:xh<CV"9,IİyO\uPdQm~w{o%9b*pwK|& VʎlNʦ Z0`RL>Z Or l a|=P>ebܦغ54LYjOvy Ļ`:G\I;8um/:y[tb*XTipX}	+;1,.*@:1xLy"S|6Ϻma ^ޏo&[Bb*E)2}6MQ
+w_Rx$ϻ$]a%ɵHuE+Wd˶^I&S:,-=_Eoevm/*O Ɲ+%zewH0U<LRX[vt=gWo$ܫ&.#>B1f glȿE@ED`Ëo֍T0`ۂ}k7	MXWu_SO|s04|˧ɵ_S0% yPp2۝ޡCҩy;VTM |Z0@xy۾>@"e=Vc1exLԈ.'9ǊkoI|'HX"Q5k<|6mw>P˗P8S1xFtT>x:q/aD9 >MS@eE@۟շ ޙD+w[/T:ޱ)QK<GƀYf`|cǡ.ek-K&ὸou=H)D*Vo7o^9]{M.:#ѐ$~wFg08`4.ERT>(DxĖ<#!0,p7'qiVs44؍ZT2ɛI䪭^D5~JKgHu7r2̙s9e_lh.n̾3E4xsAF'O5ߐf%1,w}.P8BH
+ĞT&gȁCz{k=E9BTܨ"UMu4:98*?8cƌi9[#MߺX7Y	ʶwW.ƟwEIPd_}SŵG<Fz!F.J,VKMANBp`vb8 pT-8z0}dŠ<[ĉ풔TYY6񾊪r>۶m5yI\m֪}w₳O'N(1v`ؿy@#DV <	}w qç5Zve=0,#Bo*=Ҟrp0&T#%wftsmkp17aMZ#j `&cܪO+Vr-eTҜ'ﳿR[z4"ݱ='s3)_y&+?BaRXd['QwQVi(~ gz1|ǀ#-?~ew)~F=89ϕUGww=l	?f'3̬@nb[ж}3>P_|[octuupCRB|7!ֱ}Um|ۚCg4>klK{/4R/^~!x eTPu)8O}jm)BZ-=!ch A]XT1զ1!c8~R wqॖRLH,zmdޯ|tEPʦcf;x=@=:׍A9k&5wT^Z 9C]A#\,iȋLR`H}_Eկ^?t+*p2Q-]9mEߛ
+u aaW_d\C86@$cq$IPqܲ+pe٤(--j"pFzhB0}myy᠎"`fشe8w;0<yN`!a}I^lj80:\zϮʕ+VZ%v,#AK5*'s g@̩Q.quK:C
+wF۷sҴeťz}m9&4#Rl `p0T:MEvDk{788$'V33M{x4^L2Vr)`@'X@Z)̀s1^Ux75 -Owon6\Imom;'?Gmm744)Ϙ L">id@
+XI%Ĳ
+UQ	0t ֪iKb0DYY]?/Tp,4#R@Th%㠅 d6eY6 -w!R}`fRlOH+=XOm*0	Gd+1~x.@m$klfj3)	&V7% xZ'm5ۊS_dNzWmm--[68<O%NQ9<HҊ~d{\H 䜬76v,|"OgH^S;hM7&Hr lpG%`Za[I4` 4I CmnkB6Æ:Vw,7!"@A$JIqؿ=<O1Ϛn_g&چئ5 R}d
+t&k ̀}Yq)<tY3e/K-M2H,RƤ ĸce&2?YbPA5VU?"W~64>sKXiW,VYfVP[33Z6]m{mhټ6=i^1&t& JB($5EC`d&Kd֯aCl>Vm//`amWեW@!8.TqE*cKO<e"]sk(
+5y 4ȑswl4%bY̢֝':b'ƊåL69fð4\V*bCFyiFXCPO,,i3sew	\"1E^son|.LIi:'jԆi4MX0AaZA!hV<	DyAX?+aDDkǥC6+t-ƚђ{)Hf Oʍkt9N4tmB3-eLBKK`biQk˪kkjC9!mݺo 9qb!!f8 5<F!VI!Fʪ*Iq׋EM3?y&C:?v+LB	UN;BǙ$.`ZaHxuY+,πe2}LfL1+!qHM?#}/vzw0$AX(*C[0!L<2f<ɚ?|뭡Pb^D4HW=x*SHZisBƴJ#5P8Lq;;?7c
+! Mz%(>ޙ=fD.?~;h4D*/Yx<_ SM~{|h?	ѦNmͲ==xY:::O@iJi@  M%rtɐ 9֯uOD쒁7?+<=QD@:ݗZLs8pW\BrHO04w=p7xOOO2̝7/] ,#^F>Y⃒rB# 5Tr5B_\%N/I[6T,HQi#i6 U AmA@P,RA.3\v2sݺu}lkYyMhP4eָ9j<C>Cn 9ϐ kDhH_)n=2}Ma|>s":.=|Ν#cgOKa3)(&i[ߋǘ{&F<@"@áM.vݳ^FIؤa1%[)Um`eLTRD8QRer4}^bT@	.;1ac8}x    IENDB`
\ Dosya sonunda yenisatır yok.
diff -Naur akregator-orig/src/aboutdata.h akregator/src/aboutdata.h
--- akregator-orig/src/aboutdata.h	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/aboutdata.h	2009-06-18 11:58:51.905745944 +0300
@@ -28,7 +28,7 @@
 #include "akregator_export.h"
 #include <kaboutdata.h>
 
-#define AKREGATOR_VERSION "1.4.4"
+#define AKREGATOR_VERSION "1.4.50"
 
 namespace Akregator {
 /**
diff -Naur akregator-orig/src/abstractselectioncontroller.h akregator/src/abstractselectioncontroller.h
--- akregator-orig/src/abstractselectioncontroller.h	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/abstractselectioncontroller.h	2009-06-18 11:58:51.906745945 +0300
@@ -96,7 +96,7 @@
     explicit AbstractSelectionController( QObject* parent = 0 );
     virtual ~AbstractSelectionController();
 
-    virtual void setFeedList( Akregator::FeedList* list ) = 0;
+    virtual void setFeedList( const boost::shared_ptr<FeedList>& list ) = 0;
 
     virtual void setFeedSelector( QAbstractItemView* feedSelector ) = 0;
 
diff -Naur akregator-orig/src/actionmanagerimpl.cpp akregator/src/actionmanagerimpl.cpp
--- akregator-orig/src/actionmanagerimpl.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/actionmanagerimpl.cpp	2009-06-18 11:58:51.899620796 +0300
@@ -33,7 +33,7 @@
 #include "framemanager.h"
 #include "kernel.h"
 #include "mainwidget.h"
-//#include "speechclient.h"
+#include "speechclient.h"
 #include "subscriptionlistview.h"
 #include "tabwidget.h"
 #include "trayicon.h"
@@ -181,6 +181,8 @@
     configure->setIcon(KIcon("configure"));
     connect(configure, SIGNAL(triggered()), d->part, SLOT(showOptions()));
 
+    KStandardAction::configureNotifications(d->part, SLOT(showNotificationOptions()), d->actionCollection); // options_configure_notifications
+
     /*action = d->actionCollection->addAction("akregator_configure_akregator");
     action->setIcon(KIcon("configure"));
     action->setText(i18n("Configure &Akregator..."));
@@ -226,37 +228,24 @@
     connect(action, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotFeedModify()));
     action->setShortcuts(KShortcut( "F2" ));
 
-    KActionMenu* vm = coll->add<KActionMenu>("view_mode");
-    vm->setText(i18n("&View Mode"));
-
-    QActionGroup* agViewMode = new QActionGroup(this);
-    agViewMode->setExclusive(true);
-    KToggleAction *ra = coll->add<KToggleAction>("normal_view");
-    ra->setIcon(KIcon("view-split-top-bottom"));
-    ra->setText(i18n("&Normal View"));
-    connect(ra, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotNormalView()));
-    ra->setShortcuts(KShortcut( "Ctrl+Shift+1" ));
-    ra->setActionGroup(agViewMode);
-    ra->setChecked(mainWidget->viewMode() == MainWidget::NormalView);
-    vm->addAction(ra);
-
-    ra = coll->add<KToggleAction>("widescreen_view");
-    ra->setIcon(KIcon("view-split-left-right"));
-    ra->setText(i18n("&Widescreen View"));
-    connect(ra, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotWidescreenView()));
-    ra->setShortcuts(KShortcut( "Ctrl+Shift+2" ));
-    ra->setActionGroup(agViewMode);
-    ra->setChecked(mainWidget->viewMode() == MainWidget::WidescreenView);
-    vm->addAction(ra);
-
-    ra = coll->add<KToggleAction>("combined_view");
-    ra->setIcon(KIcon("view-list-text"));
-    ra->setText(i18n("C&ombined View"));
-    connect(ra, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotCombinedView()));
-    ra->setShortcuts(KShortcut( "Ctrl+Shift+3" ));
-    ra->setActionGroup(agViewMode);
-    ra->setChecked(mainWidget->viewMode() == MainWidget::CombinedView);
-    vm->addAction(ra);
+    // toolbar / View
+    action = coll->addAction("normal_view");
+    action->setIcon(KIcon("view-split-top-bottom"));
+    action->setText(i18n("&Normal View"));
+    connect(action, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotNormalView()));
+    action->setShortcuts(KShortcut( "Ctrl+Shift+1" ));
+
+    action = coll->addAction("widescreen_view");
+    action->setIcon(KIcon("view-split-left-right"));
+    action->setText(i18n("&Widescreen View"));
+    connect(action, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotWidescreenView()));
+    action->setShortcuts(KShortcut( "Ctrl+Shift+2" ));
+
+    action = coll->addAction("combined_view");
+    action->setIcon(KIcon("view-list-text"));
+    action->setText(i18n("C&ombined View"));
+    connect(action, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotCombinedView()));
+    action->setShortcuts(KShortcut( "Ctrl+Shift+3" ));
 
     // toolbar / feed menu
     action = coll->addAction("feed_fetch");
@@ -334,16 +323,20 @@
     statusMenu->setText(i18n("&Mark As"));
     statusMenu->setEnabled( false );
 
-    //d->speakSelectedArticlesAction = new KAction(KIcon("media-playback-start"), i18n("&Speak Selected Articles"), actionCollection(), "akr_texttospeech");
-    //connect(d->speakSelectedArticlesAction, SIGNAL(triggered(bool) ), d->mainWidget, SLOT(slotTextToSpeechRequest()));
+    d->speakSelectedArticlesAction = coll->addAction("akr_texttospeech");
+    d->speakSelectedArticlesAction->setIcon(KIcon("media-playback-start"));
+    d->speakSelectedArticlesAction->setText(i18n("&Speak Selected Articles"));
+    connect(d->speakSelectedArticlesAction, SIGNAL(triggered(bool)), d->mainWidget, SLOT(slotTextToSpeechRequest()));
+
 
-    //KAction *abortTTS = new KAction(KIcon("media-playback-stop"), i18n( "&Stop Speaking" ), actionCollection(), "akr_aborttexttospeech");
-    //connect(abortTTS, SIGNAL(triggered(bool)), SpeechClient::self(), SLOT(slotAbortJobs()));
-    //abortTTS->setShortcut(QKeySequence(Qt::Key_Escape));
-    //abortTTS->setEnabled(false);
+    action = coll->addAction("akr_aborttexttospeech");
+    action->setText(i18n( "&Stop Speaking" ));
+    action->setIcon(KIcon("media-playback-stop"));
+    connect(action, SIGNAL(triggered(bool)),SpeechClient::self(), SLOT(slotAbortJobs()));
+    //action->setShortcuts(Qt::Key_Escape);
+    action->setEnabled(false);
 
-    //connect(SpeechClient::self(), SIGNAL(signalActivated(bool)),
-    //abortTTS, SLOT(setEnabled(bool)));
+    connect(SpeechClient::self(), SIGNAL(signalActivated(bool)), action, SLOT(setEnabled(bool)));
 
     action = coll->addAction("article_set_status_read");
     action->setText(i18nc("as in: mark as read","&Read"));
diff -Naur akregator-orig/src/addfeeddialog.cpp akregator/src/addfeeddialog.cpp
--- akregator-orig/src/addfeeddialog.cpp	2008-03-25 19:23:11.000000000 +0200
+++ akregator/src/addfeeddialog.cpp	2009-06-18 11:58:51.904746253 +0300
@@ -87,7 +87,7 @@
     m_feed = new Feed( Kernel::self()->storage() );
 
     // HACK: make weird wordpress links ("feed:http://foobar/rss") work
-    if (feedUrl.startsWith("feed:"))
+    if (feedUrl.startsWith(QLatin1String("feed:")))
         feedUrl = feedUrl.right( feedUrl.length() - 5 );
 
     if (feedUrl.indexOf(":/") == -1)
diff -Naur akregator-orig/src/addfeedwidgetbase.ui akregator/src/addfeedwidgetbase.ui
--- akregator-orig/src/addfeedwidgetbase.ui	2008-01-15 03:57:29.000000000 +0200
+++ akregator/src/addfeedwidgetbase.ui	2009-06-18 11:58:51.899620796 +0300
@@ -102,6 +102,9 @@
            <height>0</height>
           </size>
          </property>
+	 <property name="showClearButton" stdset="0">
+	   <bool>true</bool>
+	 </property>
         </widget>
        </item>
        <item row="0" column="0" colspan="3" >
@@ -161,8 +164,6 @@
    </item>
   </layout>
  </widget>
- <layoutdefault spacing="6" margin="11" />
- <pixmapfunction>qPixmapFromMimeSource</pixmapfunction>
  <customwidgets>
   <customwidget>
    <class>KLineEdit</class>
diff -Naur akregator-orig/src/akregator.desktop akregator/src/akregator.desktop
--- akregator-orig/src/akregator.desktop	2009-04-30 12:12:22.000000000 +0300
+++ akregator/src/akregator.desktop	2009-06-18 11:58:51.904746253 +0300
@@ -17,8 +17,7 @@
 GenericName[et]=Uudistevoogude lugemisvahend
 GenericName[fr]=Lecteur de flux
 GenericName[ga]=Léitheoir Fothaí
-GenericName[gl]=Lector de Novas
-GenericName[hu]=Hírolvasó
+GenericName[gl]=Lector de novas
 GenericName[it]=Lettore di fonti
 GenericName[ja]=フィードリーダー
 GenericName[km]=កម្មវិធី​អាន​មតិព័ត៌មាន
@@ -54,7 +53,6 @@
 Comment[fr]=Un lecteur de flux pour KDE
 Comment[ga]=Léitheoir Fothaí KDE
 Comment[gl]=Un lector de novas para o KDE
-Comment[hu]=RSS-alapú hírolvasó a KDE-hez
 Comment[it]=Un lettore di fonti per KDE
 Comment[ja]=KDE のフィードリーダー
 Comment[km]=កម្មវិធី​អាន​មតិព័ត៌មាន​របស់ KDE
@@ -80,5 +78,5 @@
 Comment[zh_CN]=KDE 的RSS 种子阅读器
 Comment[zh_TW]=KDE 的 RSS Feed 閱讀器
 Terminal=false
-Categories=Qt;KDE;Network;
+Categories=Qt;KDE;Network;News;
 X-DBUS-StartupType=Unique
diff -Naur akregator-orig/src/akregator.notifyrc akregator/src/akregator.notifyrc
--- akregator-orig/src/akregator.notifyrc	2009-04-30 12:12:21.000000000 +0300
+++ akregator/src/akregator.notifyrc	2009-06-18 11:58:51.906745945 +0300
@@ -120,7 +120,7 @@
 Name[fr]=Nouveaux articles
 Name[fy]=Nije artikels
 Name[ga]=Altanna Nua
-Name[gl]=Artigos Novos
+Name[gl]=Artigos novos
 Name[he]=מאמרים חדשים
 Name[hu]=Hírekk
 Name[is]=Nýjar greinar
diff -Naur akregator-orig/src/akregator_part.cpp akregator/src/akregator_part.cpp
--- akregator-orig/src/akregator_part.cpp	2009-04-30 12:12:22.000000000 +0300
+++ akregator/src/akregator_part.cpp	2009-06-18 11:58:51.905745944 +0300
@@ -23,15 +23,16 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "aboutdata.h"
-#include "actionmanagerimpl.h"
 #include "akregatorconfig.h"
 #include "akregator_part.h"
+#include "aboutdata.h"
+#include "actionmanagerimpl.h"
 #include "article.h"
 #include "fetchqueue.h"
 #include "feediconmanager.h"
 #include "framemanager.h"
 #include "kernel.h"
+#include "loadfeedlistcommand.h"
 #include "mainwidget.h"
 #include "notificationmanager.h"
 #include "plugin.h"
@@ -70,6 +71,69 @@
 #include <QDomDocument>
 #include "partadaptor.h"
 
+#include <memory>
+
+using namespace boost;
+
+namespace {
+
+    static QDomDocument createDefaultFeedList() {
+        QDomDocument doc;
+        QDomProcessingInstruction z = doc.createProcessingInstruction("xml","version=\"1.0\" encoding=\"UTF-8\"");
+        doc.appendChild( z );
+
+        QDomElement root = doc.createElement( "opml" );
+        root.setAttribute("version","1.0");
+        doc.appendChild( root );
+
+        QDomElement head = doc.createElement( "head" );
+        root.appendChild(head);
+
+        QDomElement text = doc.createElement( "text" );
+        text.appendChild(doc.createTextNode(i18n("Feeds")));
+        head.appendChild(text);
+
+        QDomElement body = doc.createElement( "body" );
+        root.appendChild(body);
+
+        QDomElement mainFolder = doc.createElement( "outline" );
+        mainFolder.setAttribute("text","KDE");
+        body.appendChild(mainFolder);
+
+        QDomElement ak = doc.createElement( "outline" );
+        ak.setAttribute("text",i18n("Akregator News"));
+        ak.setAttribute("xmlUrl","http://akregator.sf.net/rss2.php");
+        mainFolder.appendChild(ak);
+
+        QDomElement akb = doc.createElement( "outline" );
+        akb.setAttribute("text",i18n("Akregator Blog"));
+        akb.setAttribute("xmlUrl","http://akregator.pwsp.net/blog/?feed=rss2");
+        mainFolder.appendChild(akb);
+
+        QDomElement dot = doc.createElement( "outline" );
+        dot.setAttribute("text",i18n("KDE Dot News"));
+        dot.setAttribute("xmlUrl","http://www.kde.org/dotkdeorg.rdf");
+        mainFolder.appendChild(dot);
+
+        QDomElement plan = doc.createElement( "outline" );
+        plan.setAttribute("text",i18n("Planet KDE"));
+        plan.setAttribute("xmlUrl","http://planetkde.org/rss20.xml");
+        mainFolder.appendChild(plan);
+
+        QDomElement apps = doc.createElement( "outline" );
+        apps.setAttribute("text",i18n("KDE Apps"));
+        apps.setAttribute("xmlUrl","http://www.kde.org/dot/kde-apps-content.rdf");
+        mainFolder.appendChild(apps);
+
+        QDomElement look = doc.createElement( "outline" );
+        look.setAttribute("text",i18n("KDE Look"));
+        look.setAttribute("xmlUrl","http://www.kde.org/kde-look-content.rdf");
+        mainFolder.appendChild(look);
+
+        return doc;
+    }
+}
+
 namespace Akregator {
 
 static const KAboutData &createAboutData()
@@ -121,7 +185,7 @@
 
     Backend::StorageFactoryDummyImpl* dummyFactory = new Backend::StorageFactoryDummyImpl();
     Backend::StorageFactoryRegistry::self()->registerFactory(dummyFactory, dummyFactory->key());
-    loadStoragePlugins(); // FIXME: also unload them!
+    loadPlugins( QLatin1String("storage") ); // FIXME: also unload them!
 
     m_storage = 0;
     Backend::StorageFactory* storageFactory = Backend::StorageFactoryRegistry::self()->getFactory(Settings::archiveBackend());
@@ -158,8 +222,6 @@
     TrayIcon::setInstance(trayIcon);
     m_actionManager->initTrayIcon(trayIcon);
 
-    connect(trayIcon, SIGNAL(toggleShowPart()), this, SIGNAL(toggleShowPart()));
-
     if ( isTrayIconEnabled() )
         trayIcon->show();
 
@@ -183,17 +245,20 @@
         useragent = Settings::customUserAgent();
 
     Syndication::FileRetriever::setUserAgent( useragent );
-}
 
+    loadPlugins( QLatin1String("extension") ); // FIXME: also unload them!
+}
 
-void Part::loadStoragePlugins()
+void Part::loadPlugins( const QString& type )
 {
-    KService::List offers = PluginManager::query( "[X-KDE-akregator-plugintype] == 'storage'" );
-    for ( KService::List::ConstIterator it = offers.constBegin(), end = offers.constEnd(); it != end; ++it )
-    {
-        Akregator::Plugin* plugin = PluginManager::createFromService(*it);
-        if (plugin)
-            plugin->initialize();
+    const KService::List offers = PluginManager::query( QString::fromLatin1("[X-KDE-akregator-plugintype] == '%1'").arg( type ) );
+
+    Q_FOREACH ( const KService::Ptr& i, offers ) {
+        Akregator::Plugin* plugin = PluginManager::createFromService( i );
+        if ( !plugin )
+            continue;
+        plugin->initialize();
+        plugin->insertGuiClients( this );
     }
 }
 
@@ -278,134 +343,19 @@
 
 void Part::openStandardFeedList()
 {
-    if ( !m_standardFeedList.isEmpty() && openUrl(KUrl::fromPath(m_standardFeedList)) )
-        m_standardListLoaded = true;
+    if ( !m_standardFeedList.isEmpty() )
+        openUrl( KUrl::fromPath( m_standardFeedList ) );
 }
 
-QDomDocument Part::createDefaultFeedList()
-{
-    QDomDocument doc;
-    QDomProcessingInstruction z = doc.createProcessingInstruction("xml","version=\"1.0\" encoding=\"UTF-8\"");
-    doc.appendChild( z );
-
-    QDomElement root = doc.createElement( "opml" );
-    root.setAttribute("version","1.0");
-    doc.appendChild( root );
-
-    QDomElement head = doc.createElement( "head" );
-    root.appendChild(head);
-
-    QDomElement text = doc.createElement( "text" );
-    text.appendChild(doc.createTextNode(i18n("Feeds")));
-    head.appendChild(text);
-
-    QDomElement body = doc.createElement( "body" );
-    root.appendChild(body);
-
-    QDomElement mainFolder = doc.createElement( "outline" );
-    mainFolder.setAttribute("text","KDE");
-    body.appendChild(mainFolder);
-
-    QDomElement ak = doc.createElement( "outline" );
-    ak.setAttribute("text",i18n("Akregator News"));
-    ak.setAttribute("xmlUrl","http://akregator.sf.net/rss2.php");
-    mainFolder.appendChild(ak);
-
-    QDomElement akb = doc.createElement( "outline" );
-    akb.setAttribute("text",i18n("Akregator Blog"));
-    akb.setAttribute("xmlUrl","http://akregator.pwsp.net/blog/?feed=rss2");
-    mainFolder.appendChild(akb);
-
-    QDomElement dot = doc.createElement( "outline" );
-    dot.setAttribute("text",i18n("KDE Dot News"));
-    dot.setAttribute("xmlUrl","http://www.kde.org/dotkdeorg.rdf");
-    mainFolder.appendChild(dot);
-
-    QDomElement plan = doc.createElement( "outline" );
-    plan.setAttribute("text",i18n("Planet KDE"));
-    plan.setAttribute("xmlUrl","http://planetkde.org/rss20.xml");
-    mainFolder.appendChild(plan);
-
-    QDomElement apps = doc.createElement( "outline" );
-    apps.setAttribute("text",i18n("KDE Apps"));
-    apps.setAttribute("xmlUrl","http://www.kde.org/dot/kde-apps-content.rdf");
-    mainFolder.appendChild(apps);
-
-    QDomElement look = doc.createElement( "outline" );
-    look.setAttribute("text",i18n("KDE Look"));
-    look.setAttribute("xmlUrl","http://www.kde.org/kde-look-content.rdf");
-    mainFolder.appendChild(look);
-
-    return doc;
-}
-
-bool Part::openFile()
-{
-    emit setStatusBarText(i18n("Opening Feed List...") );
-
-    QString str;
-    // m_file is always local so we can use QFile on it
-    QFile file(localFilePath());
-
-    bool fileExists = file.exists();
-    QString listBackup = m_storage->restoreFeedList();
-
-    QDomDocument doc;
-
-    if (!fileExists)
-    {
-        doc = createDefaultFeedList();
-    }
-    else
-    {
-        if (file.open(QIODevice::ReadOnly))
-        {
-            // Read OPML feeds list and build QDom tree.
-            QTextStream stream(&file);
-            stream.setCodec("UTF-8"); // FIXME not all opmls are in utf8
-            str = stream.readAll();
-            file.close();
-        }
-
-        if (!doc.setContent(str))
-        {
-
-            QString backup = localFilePath()
-                + QLatin1String("-backup.")
-                + QString::number(QDateTime::currentDateTime().toTime_t());
-
-            if ( QFile::copy( localFilePath(), backup ) )
-                KMessageBox::error(m_mainWidget, i18n("<qt>The standard feed list is corrupted (invalid XML). A backup was created:<p><b>%1</b></p></qt>", backup), i18n("XML Parsing Error") );
-            else
-                KMessageBox::error(m_mainWidget, i18n("<qt>The standard feed list is corrupted (invalid XML). Could not create a backup!</p></qt>" ), i18n("XML Parsing Error") );
-
-            if (!doc.setContent(listBackup))
-                doc = createDefaultFeedList();
-        }
-    }
-
-    if (!m_mainWidget->loadFeeds(doc))
-    {
-        QString backup = localFilePath()
-            + QLatin1String("-backup.")
-            + QString::number(QDateTime::currentDateTime().toTime_t());
-
-        if ( QFile::copy( localFilePath(), backup ) )
-            KMessageBox::error(m_mainWidget, i18n("<qt>The standard feed list is corrupted (no valid OPML). A backup of the previous list was created:<p><b>%1</b></p></qt>", backup), i18n("OPML Parsing Error") );
-        else
-            KMessageBox::error(m_mainWidget, i18n("<qt>The standard feed list is corrupted (no valid OPML). Could not create a backup!></p></qt>" ), i18n("OPML Parsing Error") );
-        m_mainWidget->loadFeeds(createDefaultFeedList());
-    }
-
-    emit setStatusBarText(QString::null);	//krazy:exclude=nullstrassign for old broken gcc
-
-
-    if( Settings::markAllFeedsReadOnStartup() )
-        m_mainWidget->slotMarkAllFeedsRead();
-
-    if (Settings::fetchOnStartup())
-            m_mainWidget->slotFetchAllFeeds();
-
+bool Part::openFile() {
+    std::auto_ptr<LoadFeedListCommand> cmd( new LoadFeedListCommand( m_mainWidget ) );
+    cmd->setParentWidget( m_mainWidget );
+    cmd->setStorage( Kernel::self()->storage() );
+    cmd->setFileName( localFilePath() );
+    cmd->setDefaultFeedList( createDefaultFeedList() );
+    connect( cmd.get(), SIGNAL(result(boost::shared_ptr<Akregator::FeedList>)),
+             this, SLOT(feedListLoaded(boost::shared_ptr<Akregator::FeedList>)) );
+    cmd.release()->start();
     return true;
 }
 
@@ -419,6 +369,16 @@
     return file.finalize();
 }
 
+void Part::feedListLoaded( const shared_ptr<FeedList>& list ) {
+    m_mainWidget->setFeedList( list );
+    m_standardListLoaded = list != 0;
+
+    if( Settings::markAllFeedsReadOnStartup() )
+        m_mainWidget->slotMarkAllFeedsRead();
+
+    if (Settings::fetchOnStartup())
+        m_mainWidget->slotFetchAllFeeds();
+}
 
 void Part::slotSaveFeedList()
 {
@@ -441,7 +401,7 @@
 
     KMessageBox::error( m_mainWidget,
                         i18n( "Access denied: Cannot save feed list to <b>%1</b>. Please check your permissions.", localFilePath() ),
-                        i18n( "Write error" ) );
+                        i18n( "Write Error" ) );
 }
 
 bool Part::isTrayIconEnabled() const
@@ -474,7 +434,7 @@
         // Read OPML feeds list and build QDom tree.
         QDomDocument doc;
         if (doc.setContent(file.readAll()))
-            m_mainWidget->importFeeds(doc);
+            m_mainWidget->importFeedList( doc );
         else
             KMessageBox::error(m_mainWidget, i18n("Could not import the file %1 (no valid OPML)", filename), i18n("OPML Parsing Error") );
     }
@@ -565,11 +525,10 @@
     m_mainWidget->slotFeedAdd();
 }
 
-void Part::showKNotifyOptions()
+void Part::showNotificationOptions()
 {
-    KAboutData* about = new Akregator::AboutData;
-    KNotifyConfigWidget::configure(m_mainWidget, about->appName() );
-    delete about;
+    const Akregator::AboutData about;
+    KNotifyConfigWidget::configure(m_mainWidget, about.appName() );
 }
 
 void Part::showOptions()
diff -Naur akregator-orig/src/akregator_part.h akregator/src/akregator_part.h
--- akregator-orig/src/akregator_part.h	2009-04-30 12:12:22.000000000 +0300
+++ akregator/src/akregator_part.h	2009-06-18 11:58:51.904746253 +0300
@@ -30,6 +30,8 @@
 #include <kparts/browserextension.h>
 #include <kparts/part.h>
 
+#include <boost/shared_ptr.hpp>
+
 class KConfigGroup;
 class KUrl;
 class KCMultiDialog;
@@ -39,13 +41,13 @@
 
 namespace Akregator {
 
-namespace Backend
-{
+namespace Backend {
     class Storage;
 }
 
 class ActionManagerImpl;
 class Feed;
+class FeedList;
 class MainWidget;
 class Part;
 class TrayIcon;
@@ -130,7 +132,7 @@
 
         /** Shows configuration dialog */
         void showOptions();
-        void showKNotifyOptions();
+        void showNotificationOptions();
 
     signals:
         void signalSettingsChanged();
@@ -141,8 +143,10 @@
     /** @return Whether the tray icon is enabled or not */
         bool isTrayIconEnabled() const;
 
-        /** loads all Akregator storage plugins */
-        void loadStoragePlugins();
+        /** loads all plugins of a given type
+         * @param type The category of plugins to load, currently one of "storage" and "extension"
+         */
+        void loadPlugins( const QString& type );
 
         /** This must be implemented by each part */
         bool openFile();
@@ -157,6 +161,8 @@
         void slotOnShutdown();
         void slotSettingsChanged();
 
+        void feedListLoaded( const boost::shared_ptr<Akregator::FeedList>& list );
+
     private: // methods
 
         /** fills the font settings with system fonts, if fonts are not set */
@@ -164,9 +170,6 @@
 
         bool writeToTextFile( const QString& data, const QString& fname ) const;
 
-        /** creates an OPML file containing the initial feeds (KDE feeds) */
-        static QDomDocument createDefaultFeedList();
-
     private: // attributes
 
         class ApplyFiltersInterceptor;
diff -Naur akregator-orig/src/akregator_part.rc akregator/src/akregator_part.rc
--- akregator-orig/src/akregator_part.rc	2008-09-03 14:24:45.000000000 +0300
+++ akregator/src/akregator_part.rc	2009-06-18 11:58:51.898620837 +0300
@@ -1,141 +1,139 @@
 <!DOCTYPE kpartgui SYSTEM "kpartgui.dtd">
-<kpartgui name="akregator_part" version="412">
-<MenuBar>
-  <Menu name="file">
-    <Action name="file_import"/>
-    <Action name="file_export"/>
-    <Action name="file_getfromweb"/>
-    <Separator/> 
-    <Action name="file_print"/>
-    <Separator/> 
-  </Menu>
-
-    
+<kpartgui name="akregator_part" version="415">
+  <MenuBar>
+    <Menu name="file">
+      <Action name="file_import"/>
+      <Action name="file_export"/>
+      <Action name="file_getfromweb"/>
+      <Separator/>
+      <Action name="file_print"/>
+      <Separator/>
+    </Menu>
 
-   <Menu name="edit">
+    <Menu name="edit">
       <text>&amp;Edit</text>
       <Action name="feed_modify"/>
       <Action name="feed_remove"/>
       <Separator/>
-   </Menu>
+    </Menu>
+
+    <Menu name="view">
+      <text>&amp;View</text>
+      <Action name="normal_view"/>
+      <Action name="widescreen_view"/>
+      <Action name="combined_view"/>
+    </Menu>
+
+    <Menu name="go">
+      <text>&amp;Go</text>
+      <Action name="go_previous_article"/>
+      <Action name="go_prev_unread_article"/>
+      <Action name="go_next_article"/>
+      <Action name="go_next_unread_article"/>
+      <Separator/>
+      <Action name="go_prev_feed"/>
+      <Action name="go_prev_unread_feed"/>
+      <Action name="go_next_feed"/>
+      <Action name="go_next_unread_feed"/>
+    </Menu>
+
+    <Menu name="feed">
+      <text>Fee&amp;d</text>
+      <Action name="feed_add"/>
+      <Action name="feed_add_group"/>
+      <Separator/>
+      <Action name="feed_mark_all_as_read"/>
+      <Action name="feed_mark_all_feeds_as_read"/>
+      <Separator/>
+      <Action name="feed_fetch"/>
+      <Action name="feed_fetch_all"/>
+      <Action name="feed_stop"/>
+    </Menu>
+
+    <Menu name ="article">
+      <text>&amp;Article</text>
+      <Action name="article_open"/>
+      <Action name="article_open_external" />
+      <Separator/>
+      <Action name="article_set_status_important"/>
+      <Action name="article_set_status"/>
+      <Action name="article_delete"/>
+      <Separator/>
+      <Action name="article_assign_tag_menu"/>
+      <Action name="article_remove_tag_menu"/>
+      <Separator/>
+      <Action name="file_sendlink"/>
+      <Action name="file_sendfile"/>
+    </Menu>
+
+    <Menu noMerge="1" name="settings">
+      <text>&amp;Settings</text>
+      <DefineGroup append="top_merge" name="top_merge" />
+      <Action name="show_quick_filter" group="top_merge" />
+      <Action name="options_configure_notifications" group="settings_configure"/>
+      <Action name="options_configure" group="settings_configure" />
+    </Menu>
+
+    <Menu name="help">
+    </Menu>
+  </MenuBar>
 
-  
-  <Menu name="view">
-    <text>&amp;View</text>
-    <Action name="view_mode"/>
-  </Menu>
-  
-  <Menu name="go">
-    <text>&amp;Go</text>
+  <ToolBar noMerge="1" name="mainToolBar" fullWidth="true"><text>Main Toolbar</text>
+    <Action name="feed_fetch"/>
+    <Action name="feed_fetch_all"/>
+    <Action name="feed_stop"/>
+    <Action name="feed_mark_all_as_read"/>
+    <Action name="article_tagmenu"/>
+    <DefineGroup name="pageviewer_operations" />
+    <Merge/>
+  </ToolBar>
+
+  <ToolBar name="browserToolBar"><text>Browser Toolbar</text>
+    <Action name="browser_back"/>
+    <Action name="browser_forward"/>
+    <Action name="browser_reload"/>
+    <Action name="browser_stop"/>
+    <Merge/>
+  </ToolBar>
+
+  <ToolBar hidden="true" name="textToSpeechToolBar"><text>Speech Toolbar</text>
+    <Action name="akr_texttospeech"/>
+    <Action name="akr_aborttexttospeech"/>
+    <Merge/>
+  </ToolBar>
+
+  <!-- this menu doesn't show up in the app, just groups the actions -->
+  <Menu name="various">
     <Action name="go_previous_article"/>
-    <Action name="go_prev_unread_article"/>
     <Action name="go_next_article"/>
-    <Action name="go_next_unread_article"/>
-    <Separator/>
-    <Action name="go_prev_feed"/>
-    <Action name="go_prev_unread_feed"/>
-    <Action name="go_next_feed"/>
-    <Action name="go_next_unread_feed"/>
-  </Menu>
-  
-  
-  <Menu name="feed">
-    <text>F&amp;eed</text>
-    <Action name="feed_add"/>
-    <Action name="feed_add_group"/>
-    <Separator/>
+    <Action name="feedstree_up"/>
+    <Action name="feedstree_down"/>
+    <Action name="feedstree_left"/>
+    <Action name="feedstree_right"/>
+    <Action name="feedstree_home"/>
+    <Action name="feedstree_end"/>
+    <Action name="feedstree_move_up"/>
+    <Action name="feedstree_move_down"/>
+    <Action name="feedstree_move_left"/>
+    <Action name="feedstree_move_right"/>
+    <Action name="article_open_in_tab"/>
+    <Action name="article_open"/>
+    <Action name="select_previous_tab"/>
+    <Action name="select_next_tab"/>
+  </Menu>
+
+  <Menu name="feeds_popup">
     <Action name="feed_mark_all_as_read"/>
-    <Action name="feed_mark_all_feeds_as_read"/>
     <Separator/>
     <Action name="feed_fetch"/>
-    <Action name="feed_fetch_all"/>
-    <Action name="feed_stop"/> 
+    <Separator/>
+    <Action name="feed_homepage"/>
+    <Separator/>
+    <Action name="feed_modify"/>
+    <Action name="feed_remove"/>
   </Menu>
-  
-  <Menu name ="article">
-  <text>&amp;Article</text>
-  <Action name="article_open"/>
-  <Action name="article_open_external" />
-  <Separator/>
-  <Action name="article_set_status_important"/>
-  <Action name="article_set_status"/>
-  <Action name="article_delete"/>
-  <Separator/>
-  <Action name="article_assign_tag_menu"/>
-  <Action name="article_remove_tag_menu"/>
-  <Separator/>
-  <Action name="file_sendlink"/>
-  <Action name="file_sendfile"/>
-
-  </Menu>
-
-  <Menu noMerge="1" name="settings" >
-   <text>&amp;Settings</text>
-   <DefineGroup append="top_merge" name="top_merge" />
-   <Action name="show_quick_filter" group="top_merge" />
-   <Action name="options_configure" group="settings_configure" />
-  </Menu>
-
-  <Menu name="help">
-  </Menu>
-</MenuBar>
-
-<ToolBar noMerge="1" name="mainToolBar" fullWidth="true"><text>Main Toolbar</text>
-  <Action name="feed_fetch"/>
-  <Action name="feed_fetch_all"/>
-  <Action name="feed_stop"/>
-  <Action name="feed_mark_all_as_read"/>
-  <Action name="article_tagmenu"/>
-  <DefineGroup name="pageviewer_operations" />
-  <Merge/>
-</ToolBar>
-
-<ToolBar name="browserToolBar"><text>Browser Toolbar</text>
-	<Action name="browser_back"/>
-	<Action name="browser_forward"/>
-	<Action name="browser_reload"/>
-	<Action name="browser_stop"/>
-	<Merge/>
-</ToolBar>
-
-<ToolBar hidden="true" name="textToSpeechToolBar"><text>Speech Toolbar</text>
-	<Action name="akr_texttospeech"/>
-	<Action name="akr_aborttexttospeech"/>
-	<Merge/>
-</ToolBar>
-
-<!-- this menu doesn't show up in the app, just groups the actions -->
-<Menu name="various">
-<Action name="go_previous_article"/>
-<Action name="go_next_article"/>
-<Action name="feedstree_up"/>
-<Action name="feedstree_down"/>
-<Action name="feedstree_left"/>
-<Action name="feedstree_right"/>
-<Action name="feedstree_home"/>
-<Action name="feedstree_end"/>
-<Action name="feedstree_move_up"/>
-<Action name="feedstree_move_down"/>
-<Action name="feedstree_move_left"/>
-<Action name="feedstree_move_right"/>
-<Action name="article_open_in_tab"/>
-<Action name="article_open"/>
-<Action name="select_previous_tab"/>
-<Action name="select_next_tab"/>
-</Menu>
-
-<Menu name="feeds_popup">
-  <Action name="feed_mark_all_as_read"/>
-  <Separator/>
-  <Action name="feed_fetch"/>
-  <Separator/>
-  <Action name="feed_homepage"/>
-  <Separator/>
-  <Action name="feed_modify"/>
-  <Action name="feed_remove"/>
-</Menu>
 
-<Menu name="feedgroup_popup">
+  <Menu name="feedgroup_popup">
     <Action name="feed_mark_all_as_read"/>
     <Separator/>
     <Action name="feed_fetch"/>
@@ -144,41 +142,39 @@
     <Action name="feed_add_group"/>
     <Action name="feed_modify"/>
     <Action name="feed_remove"/>
-</Menu>
+  </Menu>
 
-<Menu name="tagfolder_popup">
-	<Action name="feed_mark_all_as_read"/>
-	<Separator/>
-	<Action name="tag_new"/>
-<!--	<Action name="feed_add_group"/> -->
-	<Action name="feed_modify"/>
-	<Action name="feed_remove"/>
-</Menu>
-
-
-<Menu name="tagnode_popup">
-	<Action name="feed_mark_all_as_read"/>
-	<Action name="feed_modify"/>
-	<Action name="feed_remove"/>
-</Menu>
-
-<Menu name="article_popup">
-  <Action name="article_open"/>
-  <Action name="article_open_external" />
-  <Action name="article_copy_link_address" />
-  <Separator/>
-  <Action name="article_set_status_important"/>
-  <Action name="article_set_status"/>
-  <Action name="article_toggle_keep"/>
-  <Action name="article_delete"/>
-  <Separator/>
-  <Action name="article_tagmenu"/>
-</Menu>
-
-<Menu name="tab_popup">
-  <Action name="tab_detach"/>
-  <Action name="tab_copylinkaddress"/>
-  <Action name="tab_remove"/>
-</Menu>
+  <Menu name="tagfolder_popup">
+    <Action name="feed_mark_all_as_read"/>
+    <Separator/>
+    <Action name="tag_new"/>
+    <!--<Action name="feed_add_group"/> -->
+    <Action name="feed_modify"/>
+    <Action name="feed_remove"/>
+  </Menu>
 
+  <Menu name="tagnode_popup">
+    <Action name="feed_mark_all_as_read"/>
+    <Action name="feed_modify"/>
+    <Action name="feed_remove"/>
+  </Menu>
+
+  <Menu name="article_popup">
+    <Action name="article_open"/>
+    <Action name="article_open_external" />
+    <Action name="article_copy_link_address" />
+    <Separator/>
+    <Action name="article_set_status_important"/>
+    <Action name="article_set_status"/>
+    <Action name="article_toggle_keep"/>
+    <Action name="article_delete"/>
+    <Separator/>
+    <Action name="article_tagmenu"/>
+  </Menu>
+
+  <Menu name="tab_popup">
+    <Action name="tab_detach"/>
+    <Action name="tab_copylinkaddress"/>
+    <Action name="tab_remove"/>
+  </Menu>
 </kpartgui>
diff -Naur akregator-orig/src/akregator_shell.rc akregator/src/akregator_shell.rc
--- akregator-orig/src/akregator_shell.rc	2008-09-03 14:24:45.000000000 +0300
+++ akregator/src/akregator_shell.rc	2009-06-18 11:58:51.899620796 +0300
@@ -23,7 +23,7 @@
   </Menu>
   
   <Menu noMerge="1" name="feed">
-    <text>&amp;Feed</text>
+    <text>Fee&amp;d</text>
     <Merge/>
   </Menu>
 
diff -Naur akregator-orig/src/article.cpp akregator/src/article.cpp
--- akregator-orig/src/article.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/article.cpp	2009-06-18 11:58:51.899620796 +0300
@@ -62,7 +62,7 @@
         tagName=rx.cap(2);
         if (tagName=="SCRIPT"||tagName=="script")
             toReplace=rx.cap(0); // strip tag AND tag contents
-        else if (tagName.startsWith("br") || tagName.startsWith("BR"))
+        else if (tagName.startsWith(QLatin1String("br")) || tagName.startsWith(QLatin1String("BR")))
         {
             toReplace=rx.cap(1);
             replaceWith=" ";
@@ -183,7 +183,7 @@
         //archive->setComments(guid, article.comments());
         //archive->setCommentsLink(guid, article.commentsLink().url());
         archive->setGuidIsPermaLink(guid, false);
-        archive->setGuidIsHash(guid, guid.startsWith("hash:"));
+        archive->setGuidIsHash(guid, guid.startsWith(QLatin1String("hash:")));
         const time_t datePublished = article->datePublished();
         if ( datePublished > 0 )
             pubDate.setTime_t( datePublished );
@@ -389,6 +389,7 @@
 {
     return d->archive->authorUri(d->guid);
 }
+
 QString Article::authorShort() const {
     const QString name = authorName();
     if ( !name.isEmpty() )
@@ -406,18 +407,21 @@
     const QString name = authorName();
     const QString email = authorEMail();
 
-    if (!email.isEmpty())
+    if (!email.isEmpty()) {
         if (!name.isEmpty())
             return QString("<a href=\"mailto:%1\">%2</a>").arg( email, name );
         else
             return QString("<a href=\"mailto:%1\">%1</a>").arg( email );
+    }
 
     const QString uri = authorUri();
-    if (!name.isEmpty())
+    if (!name.isEmpty()) {
         if (!uri.isEmpty())
-                return QString("<a href=\"%1\">%2</a>").arg( uri, name );
-            else
-                return name;
+            return QString("<a href=\"%1\">%2</a>").arg( uri, name );
+        else
+            return name;
+    }
+
     if ( !uri.isEmpty() )
         return QString( "<a href=\"%1\">%1</a>" ).arg( uri );
     return QString();
diff -Naur akregator-orig/src/articleformatter.cpp akregator/src/articleformatter.cpp
--- akregator-orig/src/articleformatter.cpp	2008-11-28 17:39:38.000000000 +0200
+++ akregator/src/articleformatter.cpp	2009-06-18 11:58:51.904746253 +0300
@@ -23,8 +23,8 @@
 */
 
 #include "akregatorconfig.h"
-#include "article.h"
 #include "articleformatter.h"
+#include "article.h"
 #include "feed.h"
 #include "folder.h"
 #include "treenode.h"
diff -Naur akregator-orig/src/articlejobs.cpp akregator/src/articlejobs.cpp
--- akregator-orig/src/articlejobs.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/articlejobs.cpp	2009-06-18 11:58:51.898620837 +0300
@@ -29,6 +29,7 @@
 #include "kernel.h"
 
 #include <KDebug>
+#include <KLocalizedString>
 
 #include <QTimer>
 
@@ -173,4 +174,28 @@
     }
 }
 
+ArticleListJob::ArticleListJob( TreeNode* p ) : KJob( p ), m_node( p ) {}
+
+void ArticleListJob::start() {
+    QTimer::singleShot( 20, this, SLOT( doList() ) );
+}
+
+void ArticleListJob::doList() {
+    if ( m_node )
+        m_articles = m_node->articles();
+    else {
+        setError( ListingFailed );
+        setErrorText( i18n("The feed to be listed was already removed.") );
+    }
+    emitResult();
+}
+
+TreeNode* ArticleListJob::node() const {
+    return m_node;
+}
+
+QList<Article> ArticleListJob::articles() const {
+    return m_articles;
+}
+
 #include "articlejobs.moc"
diff -Naur akregator-orig/src/articlejobs.h akregator/src/articlejobs.h
--- akregator-orig/src/articlejobs.h	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/articlejobs.h	2009-06-18 11:58:51.899620796 +0300
@@ -32,10 +32,14 @@
 #include <QPointer>
 #include <QString>
 
+#include <boost/shared_ptr.hpp>
+
 //transitional job classes
 namespace Akregator {
 
+class Article;
 class FeedList;
+class TreeNode;
 
 struct ArticleId
 {
@@ -73,7 +77,7 @@
     void doStart();
 
 private:
-    QPointer<Akregator::FeedList> m_feedList;
+    boost::shared_ptr<FeedList> m_feedList;
     ArticleIdList m_ids;
 };
 
@@ -93,11 +97,35 @@
     void doStart();
 
 private:
-    QPointer<Akregator::FeedList> m_feedList;
+    boost::shared_ptr<FeedList> m_feedList;
     QMap<ArticleId, bool> m_keepFlags;
     QMap<ArticleId, int> m_status;
 };
 
+
+class ArticleListJob : public KJob
+{
+    Q_OBJECT
+public:
+    explicit ArticleListJob( TreeNode* parent = 0 );
+
+    QList<Article> articles() const;
+    TreeNode* node() const;
+
+    /* reimp */ void start();
+
+    enum Error {
+        ListingFailed = KJob::UserDefinedError
+    };
+
+private Q_SLOTS:
+    void doList();
+
+private:
+    const QPointer<TreeNode> m_node;
+    QList<Article> m_articles;
+};
+
 } // namespace akregator
 
 #endif // AKREGATOR_ARTICLE_JOBS_H
diff -Naur akregator-orig/src/articlelistview.cpp akregator/src/articlelistview.cpp
--- akregator-orig/src/articlelistview.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/articlelistview.cpp	2009-06-18 11:58:51.899620796 +0300
@@ -303,6 +303,8 @@
     setUniformRowHeights( true );
     setRootIsDecorated( false );
     setAllColumnsShowFocus( true );
+    setDragDropMode( QAbstractItemView::DragOnly );
+
     setMinimumSize( 250, 150 );
     setWhatsThis( i18n("<h2>Article list</h2>"
         "Here you can browse articles from the currently selected feed. "
@@ -428,7 +430,7 @@
 {
     if ( !model() )
         return;
-    emit userActionTakingPlace();
+
     const QModelIndex idx = currentIndex();
     const int newRow = qMax( 0, ( idx.isValid() ? idx.row() : model()->rowCount() ) - 1 );
     const QModelIndex newIdx = idx.isValid() ? idx.sibling( newRow, 0 ) : model()->index( newRow, 0 );
@@ -440,7 +442,6 @@
     if ( !model() )
         return;
 
-    emit userActionTakingPlace();
     const QModelIndex idx = currentIndex();
     const int newRow = idx.isValid() ? ( idx.row() + 1 ) : 0;
     const QModelIndex newIdx = model()->index( qMin( newRow, model()->rowCount() - 1 ), 0 );
diff -Naur akregator-orig/src/articlelistview.h akregator/src/articlelistview.h
--- akregator-orig/src/articlelistview.h	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/articlelistview.h	2009-06-18 11:58:51.901620775 +0300
@@ -139,10 +139,6 @@
 
     void slotNextUnreadArticle();
 
-Q_SIGNALS:
-
-    void userActionTakingPlace();
-
 private:
     void saveHeaderSettings();
     void loadHeaderSettings();
diff -Naur akregator-orig/src/articlemodel.cpp akregator/src/articlemodel.cpp
--- akregator-orig/src/articlemodel.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/articlemodel.cpp	2009-06-18 11:58:51.900620759 +0300
@@ -26,17 +26,19 @@
 #include "article.h"
 #include "articlematcher.h"
 #include "akregatorconfig.h"
-#include "treenode.h"
 #include "feed.h"
 
 #include <syndication/tools.h>
 
+#include <QMimeData>
 #include <QString>
 #include <QVector>
 
 #include <KLocale>
 #include <KGlobal>
 
+#include <memory>
+
 #include <cassert>
 #include <cmath>
 
@@ -46,37 +48,25 @@
 private:
     ArticleModel* const q;
 public:
-    Private( TreeNode* node_, ArticleModel* qq );
-    Akregator::TreeNode* node;
-    QList<Akregator::Article> articles;
+    Private( const QList<Article>& articles, ArticleModel* qq );
+    QList<Article> articles;
     QVector<QString> titleCache;
 
-    void nodeDestroyed();
-    void articlesAdded( TreeNode*, const QList<Article>& );
-    void articlesRemoved( TreeNode*, const QList<Article>& );
-    void articlesUpdated( TreeNode*, const QList<Article>& );
+    void articlesAdded( const QList<Article>& );
+    void articlesRemoved( const QList<Article>& );
+    void articlesUpdated( const QList<Article>& );
 
 };
 
-ArticleModel::Private::Private( TreeNode* node_, ArticleModel* qq )
- : q( qq ), node( node_ )
+ArticleModel::Private::Private( const QList<Article>& articles_, ArticleModel* qq )
+ : q( qq ), articles( articles_ )
 {
-    Q_ASSERT( node );
-    articles = node->articles();
     titleCache.resize( articles.count() );
     for ( int i = 0; i < articles.count(); ++i )
         titleCache[i] = Syndication::htmlToPlainText( articles[i].title() );
-    connect( node, SIGNAL( destroyed() ) , q, SLOT( nodeDestroyed() ) );
-    connect( node, SIGNAL( signalArticlesAdded( Akregator::TreeNode*, QList<Akregator::Article> ) ),
-                          q, SLOT( articlesAdded( Akregator::TreeNode*, QList<Akregator::Article> ) ) );
-    connect( node, SIGNAL( signalArticlesRemoved( Akregator::TreeNode*, QList<Akregator::Article> ) ),
-                           q, SLOT( articlesRemoved( Akregator::TreeNode*, QList<Akregator::Article> ) ) );
-    connect( node, SIGNAL( signalArticlesUpdated( Akregator::TreeNode*, QList<Akregator::Article> ) ),
-                           q, SLOT( articlesUpdated( Akregator::TreeNode*, QList<Akregator::Article> ) ) );
-
 }
 
-Akregator::ArticleModel::ArticleModel(TreeNode* node, QObject* parent) : QAbstractTableModel( parent ), d( new Private( node, this ) )
+Akregator::ArticleModel::ArticleModel(const QList<Article>& articles, QObject* parent) : QAbstractTableModel( parent ), d( new Private( articles, this ) )
 {
 }
 
@@ -183,16 +173,26 @@
     return QVariant();
 }
 
-void Akregator::ArticleModel::Private::nodeDestroyed()
+void ArticleModel::clear()
 {
-    node = 0;
-    articles.clear();
-    q->reset();
+    d->articles.clear();
+    d->titleCache.clear();
+    reset();
 }
 
-void ArticleModel::Private::articlesAdded( TreeNode* node, const QList<Article>& list )
+void ArticleModel::articlesAdded( TreeNode*, const QList<Article>& l ) {
+    d->articlesAdded( l );
+}
+
+void ArticleModel::articlesRemoved( TreeNode*, const QList<Article>& l ) {
+    d->articlesRemoved( l );
+}
+void ArticleModel::articlesUpdated( TreeNode*, const QList<Article>& l ) {
+    d->articlesUpdated( l );
+}
+
+void ArticleModel::Private::articlesAdded( const QList<Article>& list )
 {
-    Q_UNUSED( node );
     if ( list.isEmpty() ) //assert?
         return;
     const int first = static_cast<int>( articles.count() );
@@ -206,9 +206,8 @@
     q->endInsertRows();
 }
 
-void ArticleModel::Private::articlesRemoved( TreeNode* node, const QList<Article>& list )
+void ArticleModel::Private::articlesRemoved( const QList<Article>& list )
 {
-    Q_UNUSED( node );
     //might want to avoid indexOf() in case of performance problems
     Q_FOREACH ( const Article& i, list )
     {
@@ -219,9 +218,8 @@
 }
 
 
-void ArticleModel::Private::articlesUpdated( TreeNode* node, const QList<Article>& list )
+void ArticleModel::Private::articlesUpdated( const QList<Article>& list )
 {
-    Q_UNUSED( node );
     int rmin = 0;
     int rmax = 0;
 
@@ -259,4 +257,35 @@
     return d->articles[row];
 }
 
+QStringList ArticleModel::mimeTypes() const
+{
+    return QStringList() << QString::fromLatin1( "text/uri-list" );
+}
+
+QMimeData* ArticleModel::mimeData( const QModelIndexList& indexes ) const
+{
+    std::auto_ptr<QMimeData> md( new QMimeData );
+    QList<QUrl> urls;
+    Q_FOREACH( const QModelIndex& i, indexes ) {
+        const QUrl url = i.data( ArticleModel::LinkRole ).value<KUrl>();
+        if ( url.isValid() )
+            urls.push_back( url );
+        else {
+            const QUrl guid( i.data( ArticleModel::GuidRole ).toString() );
+            if ( guid.isValid() )
+                urls.push_back( guid );
+        }
+    }
+    md->setUrls( urls );
+    return md.release();
+}
+
+Qt::ItemFlags ArticleModel::flags( const QModelIndex& idx ) const
+{
+    const Qt::ItemFlags f = QAbstractTableModel::flags( idx );
+    if ( !idx.isValid() )
+        return f;
+    return f | Qt::ItemIsDragEnabled;
+}
+
 #include "articlemodel.moc"
diff -Naur akregator-orig/src/articlemodel.h akregator/src/articlemodel.h
--- akregator-orig/src/articlemodel.h	2008-06-10 14:41:20.000000000 +0300
+++ akregator/src/articlemodel.h	2009-06-18 11:58:51.898620837 +0300
@@ -25,6 +25,7 @@
 #define AKREGATOR_ARTICLEMODEL_H
 
 #include <QAbstractTableModel>
+#include <QList>
 
 #include "akregator_export.h"
 
@@ -67,7 +68,7 @@
         IsDeletedRole
     };
 
-    explicit ArticleModel( Akregator::TreeNode* node, QObject* parent = 0 );
+    explicit ArticleModel( const QList<Article>& articles, QObject* parent = 0 );
     ~ArticleModel();
 
     //reimpl
@@ -84,16 +85,25 @@
 
     Article article( int row ) const;
 
+    /* reimp */ QStringList mimeTypes() const;
+
+    /* reimp */ QMimeData* mimeData( const QModelIndexList& indexes ) const;
+
+    /* reimp */ Qt::ItemFlags flags( const QModelIndex& idx ) const;
+
+public Q_SLOTS:
+
+    void articlesAdded( Akregator::TreeNode*, const QList<Akregator::Article>& );
+    void articlesUpdated( Akregator::TreeNode*, const QList<Akregator::Article>& );
+    void articlesRemoved( Akregator::TreeNode*, const QList<Akregator::Article>& );
+    void clear();
+
 private:
     ArticleModel( const ArticleModel& );
     ArticleModel& operator=( const ArticleModel& );
 
     class Private;
     Private* const d;
-    Q_PRIVATE_SLOT( d, void nodeDestroyed() )
-    Q_PRIVATE_SLOT( d, void articlesAdded( Akregator::TreeNode*, QList<Akregator::Article> ) )
-    Q_PRIVATE_SLOT( d, void articlesUpdated( Akregator::TreeNode*, QList<Akregator::Article> ) )
-    Q_PRIVATE_SLOT( d, void articlesRemoved( Akregator::TreeNode*, QList<Akregator::Article> ) )
 };
 
 } //namespace Akregator
diff -Naur akregator-orig/src/articleviewer.cpp akregator/src/articleviewer.cpp
--- akregator-orig/src/articleviewer.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/articleviewer.cpp	2009-06-18 11:58:51.906745945 +0300
@@ -30,6 +30,7 @@
 #include "actions.h"
 #include "article.h"
 #include "articleformatter.h"
+#include "articlejobs.h"
 #include "articlematcher.h"
 #include "feed.h"
 #include "folder.h"
@@ -114,9 +115,6 @@
     connect( ext, SIGNAL(openUrlRequestDelayed(KUrl, KParts::OpenUrlArguments, KParts::BrowserArguments)),
              this, SLOT(slotOpenUrlRequestDelayed(KUrl, KParts::OpenUrlArguments, KParts::BrowserArguments)) );
 
-    connect( ext, SIGNAL(createNewWindow(KUrl, KParts::OpenUrlArguments, KParts::BrowserArguments)),
-             this, SLOT(slotCreateNewWindow(KUrl, KParts::OpenUrlArguments, KParts::BrowserArguments)) );
-
     connect(ext, SIGNAL(createNewWindow(KUrl,
             KParts::OpenUrlArguments,
             KParts::BrowserArguments,
@@ -228,16 +226,6 @@
     emit signalOpenUrlRequest(req);
 }
 
-void ArticleViewer::slotCreateNewWindow(const KUrl& url, const KParts::OpenUrlArguments& args, const KParts::BrowserArguments& browserArgs)
-{
-    OpenUrlRequest req(url);
-    req.setArgs(args);
-    req.setBrowserArgs(browserArgs);
-    req.setOptions(OpenUrlRequest::NewTab);
-
-    emit signalOpenUrlRequest(req);
-}
-
 void ArticleViewer::slotCreateNewWindow(const KUrl& url,
                                        const KParts::OpenUrlArguments& args,
                                        const KParts::BrowserArguments& browserArgs,
@@ -560,46 +548,58 @@
     if (!m_node)
         return slotClear();
 
-    QList<Article> articles = m_node->articles();
-    qSort(articles);
 
-    QString text;
+   QString text;
 
-    int num = 0;
-    QTime spent;
-    spent.start();
+   int num = 0;
+   QTime spent;
+   spent.start();
 
-    const std::vector< shared_ptr<const AbstractMatcher> >::const_iterator filterEnd = m_filters.end();
+   const std::vector< shared_ptr<const AbstractMatcher> >::const_iterator filterEnd = m_filters.end();
 
-    Q_FOREACH( const Article& i, articles )
-    {
-        if ( i.isDeleted() )
-            continue;
+   Q_FOREACH( const Article& i, m_articles )
+   {
+       if ( i.isDeleted() )
+           continue;
 
-        if ( std::find_if( m_filters.begin(), m_filters.end(), !bind( &AbstractMatcher::matches, _1, i ) ) != filterEnd )
-            continue;
+       if ( std::find_if( m_filters.begin(), m_filters.end(), !bind( &AbstractMatcher::matches, _1, i ) ) != filterEnd )
+           continue;
 
-        text += "<p><div class=\"article\">"+m_combinedViewFormatter->formatArticle( i, ArticleFormatter::NoIcon)+"</div><p>";
-        ++num;
-    }
+       text += "<p><div class=\"article\">"+m_combinedViewFormatter->formatArticle( i, ArticleFormatter::NoIcon)+"</div><p>";
+       ++num;
+   }
 
-    kDebug() <<"Combined view rendering: (" << num <<" articles):" <<"generating HTML:" << spent.elapsed() <<"ms";
-    renderContent(text);
-    kDebug() <<"HTML rendering:" << spent.elapsed() <<"ms";
+   kDebug() <<"Combined view rendering: (" << num <<" articles):" <<"generating HTML:" << spent.elapsed() <<"ms";
+   renderContent(text);
+   kDebug() <<"HTML rendering:" << spent.elapsed() <<"ms";
 }
 
 void ArticleViewer::slotArticlesUpdated(TreeNode* /*node*/, const QList<Article>& /*list*/)
 {
-    if (m_viewMode == CombinedView)
+    if (m_viewMode == CombinedView) {
+        //TODO
         slotUpdateCombinedView();
+    }
 }
 
-void ArticleViewer::slotArticlesAdded(TreeNode* /*node*/, const QList<Article>& /*list*/)
+void ArticleViewer::slotArticlesAdded(TreeNode* /*node*/, const QList<Article>& list)
 {
+    if (m_viewMode == CombinedView) {
+        //TODO sort list, then merge
+        m_articles << list;
+        std::sort( m_articles.begin(), m_articles.end() );
+        slotUpdateCombinedView();
+    }
 }
 
-void ArticleViewer::slotArticlesRemoved(TreeNode* /*node*/, const QList<Article>& /*list*/)
+void ArticleViewer::slotArticlesRemoved(TreeNode* /*node*/, const QList<Article>& list )
 {
+    Q_UNUSED(list)
+
+    if (m_viewMode == CombinedView) {
+        //TODO
+        slotUpdateCombinedView();
+    }
 }
 
 void ArticleViewer::slotClear()
@@ -607,6 +607,7 @@
     disconnectFromNode(m_node);
     m_node = 0;
     m_article = Article();
+    m_articles.clear();
 
     renderContent(QString());
 }
@@ -620,11 +621,41 @@
 
     connectToNode(node);
 
+    m_articles.clear();
     m_article = Article();
     m_node = node;
 
-    if (node && !node->articles().isEmpty())
-        m_link = node->articles().first().link();
+    delete m_listJob;
+
+    m_listJob = node->createListJob();
+    connect( m_listJob, SIGNAL(finished(KJob*)), this, SLOT(slotArticlesListed(KJob*)));
+    m_listJob->start();
+
+
+
+    slotUpdateCombinedView();
+}
+
+void ArticleViewer::slotArticlesListed( KJob* job ) {
+    assert( job );
+    assert( job == m_listJob );
+
+    TreeNode* node = m_listJob->node();
+
+    if ( job->error() || !node ) {
+        if ( !node )
+            kWarning() << "Node to be listed is already deleted";
+        else
+            kWarning() << job->errorText();
+        slotUpdateCombinedView();
+        return;
+    }
+
+    m_articles = m_listJob->articles();
+    std::sort( m_articles.begin(), m_articles.end() );
+
+    if (node && m_articles.isEmpty())
+        m_link = m_articles.first().link();
     else
         m_link = KUrl();
 
diff -Naur akregator-orig/src/articleviewer.h akregator/src/articleviewer.h
--- akregator-orig/src/articleviewer.h	2009-03-26 16:43:26.000000000 +0200
+++ akregator/src/articleviewer.h	2009-06-18 11:58:51.900620759 +0300
@@ -35,6 +35,7 @@
 #include <boost/shared_ptr.hpp>
 #include <vector>
 
+class KJob;
 class KUrl;
 
 namespace Akregator {
@@ -44,6 +45,7 @@
 }
 
 class ArticleFormatter;
+class ArticleListJob;
 class OpenUrlRequest;
 class TreeNode;
 
@@ -122,8 +124,6 @@
 
         void slotOpenUrlRequestDelayed(const KUrl&, const KParts::OpenUrlArguments&, const KParts::BrowserArguments&);
 
-        void slotCreateNewWindow(const KUrl& url, const KParts::OpenUrlArguments& args, const KParts::BrowserArguments& browserArgs);
-
         void slotCreateNewWindow(const KUrl& url,
                                     const KParts::OpenUrlArguments& args,
                                     const KParts::BrowserArguments& browserArgs,
@@ -160,6 +160,8 @@
 
         void slotSelectionChanged();
 
+        void slotArticlesListed(KJob* job);
+
         void slotArticlesUpdated(Akregator::TreeNode* node, const QList<Akregator::Article>& list);
         void slotArticlesAdded(Akregator::TreeNode* node, const QList<Akregator::Article>& list);
         void slotArticlesRemoved(Akregator::TreeNode* node, const QList<Akregator::Article>& list);
@@ -196,7 +198,9 @@
         QString m_currentText;
         KUrl m_imageDir;
         QPointer<TreeNode> m_node;
+        QPointer<ArticleListJob> m_listJob;
         Article m_article;
+        QList<Article> m_articles;
         KUrl m_link;
         std::vector<boost::shared_ptr<const Filters::AbstractMatcher> > m_filters;
         enum ViewMode { NormalView, CombinedView, SummaryView };
diff -Naur akregator-orig/src/browserframe.cpp akregator/src/browserframe.cpp
--- akregator-orig/src/browserframe.cpp	2008-11-19 12:18:54.000000000 +0200
+++ akregator/src/browserframe.cpp	2009-06-18 11:58:51.901620775 +0300
@@ -22,10 +22,10 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "actionmanager.h"
-#include "actions.h"
 #include "browserframe.h"
 #include "browserframe_p.h"
+#include "actionmanager.h"
+#include "actions.h"
 #include "openurlrequest.h"
 #include "utils/temporaryvalue.h"
 
@@ -157,6 +157,10 @@
                    BrowserExtension::PopupFlags flags,
                    const KParts::BrowserExtension::ActionGroupMap& actionGroups )
 {
+    Q_UNUSED( mode )
+    Q_UNUSED( args )
+    Q_UNUSED( browserArgs )
+
     const bool showReload = (flags & BrowserExtension::ShowReload) != 0;
     const bool showNavigationItems = (flags & BrowserExtension::ShowNavigationItems) != 0;
     const bool isLink = (flags & BrowserExtension:: IsLink) != 0;
diff -Naur akregator-orig/src/CMakeLists.txt akregator/src/CMakeLists.txt
--- akregator-orig/src/CMakeLists.txt	2008-12-21 22:20:28.000000000 +0200
+++ akregator/src/CMakeLists.txt	2009-06-18 11:58:51.904746253 +0300
@@ -32,7 +32,7 @@
 
 kde4_add_library(akregatorprivate SHARED ${akregatorprivate_LIB_SRCS})
 
-target_link_libraries(akregatorprivate kdepim  ${KDE4_KHTML_LIBS} ${KDE4_SYNDICATION_LIBS} akregatorinterfaces)
+target_link_libraries(akregatorprivate kdepim  ${KDE4_KHTML_LIBS} ${KDEPIMLIBS_SYNDICATION_LIBS} akregatorinterfaces)
 target_link_libraries(akregatorprivate LINK_INTERFACE_LIBRARIES ${KDE4_KHTML_LIBS} )
 
 set_target_properties(akregatorprivate
@@ -84,7 +84,9 @@
    articleviewer.cpp 
    articleformatter.cpp
    addfeeddialog.cpp 
+   loadfeedlistcommand.cpp
    editsubscriptioncommand.cpp
+   importfeedlistcommand.cpp
    feedpropertiesdialog.cpp 
    tabwidget.cpp 
    progressmanager.cpp 
@@ -93,10 +95,12 @@
    mainwidget.cpp 
    notificationmanager.cpp 
    subscriptionlistview.cpp
+   subscriptionlistdelegate.cpp
    dummystorage/storagedummyimpl.cpp 
    dummystorage/storagefactorydummyimpl.cpp 
-   dummystorage/feedstoragedummyimpl.cpp )
-   #speechclient.cpp )
+   dummystorage/feedstoragedummyimpl.cpp 
+   speechclient.cpp )
+qt4_add_dbus_interfaces(akregatorpart_PART_SRCS ${KDE4_DBUS_INTERFACES_DIR}/org.kde.KSpeech.xml)
 qt4_add_dbus_adaptor( akregatorpart_PART_SRCS org.kde.akregator.part.xml akregator_part.h Akregator::Part )
 
 
@@ -107,7 +111,7 @@
 
 kde4_add_plugin(akregatorpart ${akregatorpart_PART_SRCS})
 
-target_link_libraries(akregatorpart  ${KDE4_KUTILS_LIBS} ${KDE4_KNOTIFYCONFIG_LIBS} ${KDE4_SOLID_LIBRARY} akregatorinterfaces akregatorprivate kdepim ${KDE4_SYNDICATION_LIBS} ${KDE4_KPIMUTILS_LIBS}  ${KDE4_KDE3SUPPORT_LIBS} )
+target_link_libraries(akregatorpart  ${KDE4_KUTILS_LIBS} ${KDE4_KNOTIFYCONFIG_LIBS} ${KDE4_SOLID_LIBRARY} akregatorinterfaces akregatorprivate kdepim ${KDEPIMLIBS_SYNDICATION_LIBS} ${KDEPIMLIBS_KPIMUTILS_LIBS}  ${KDE4_KDE3SUPPORT_LIBS} )
 
 install(TARGETS akregatorpart  DESTINATION ${PLUGIN_INSTALL_DIR})
 
diff -Naur akregator-orig/src/deletesubscriptioncommand.cpp akregator/src/deletesubscriptioncommand.cpp
--- akregator-orig/src/deletesubscriptioncommand.cpp	2008-03-25 19:23:11.000000000 +0200
+++ akregator/src/deletesubscriptioncommand.cpp	2009-06-18 11:58:51.903746150 +0300
@@ -37,6 +37,7 @@
 #include <QTimer>
 
 using namespace Akregator;
+using namespace boost;
 
 namespace {
 
@@ -45,14 +46,14 @@
     public:
         explicit DeleteNodeVisitor( QWidget* parent ) : m_widget( parent ), m_job( 0 ) {}
 
-        
+
         bool visitFolder( Folder* node )
         {
             const QString msg = node->title().isEmpty()
-                                ? i18n("<qt>Are you sure you want to delete this folder and its feeds and subfolders?</qt>") 
+                                ? i18n("<qt>Are you sure you want to delete this folder and its feeds and subfolders?</qt>")
                                 : i18n("<qt>Are you sure you want to delete folder <b>%1</b> and its feeds and subfolders?</qt>", node->title());
 
-            if ( KMessageBox::warningContinueCancel( m_widget, 
+            if ( KMessageBox::warningContinueCancel( m_widget,
                                                      msg,
                                                      i18n( "Delete Folder" ),
                                                      KStandardGuiItem::del(),
@@ -73,7 +74,7 @@
             else
                 msg = i18n("<qt>Are you sure you want to delete feed <b>%1</b>?</qt>", node->title());
 
-            if ( KMessageBox::warningContinueCancel( m_widget, 
+            if ( KMessageBox::warningContinueCancel( m_widget,
                                                      msg,
                                                      i18n( "Delete Feed" ),
                                                      KStandardGuiItem::del(),
@@ -85,7 +86,7 @@
             // m_widget->m_feedListView->setFocus();
             return true;
         }
-        
+
 
         DeleteSubscriptionJob* createJob( TreeNode* node )
         {
@@ -102,7 +103,7 @@
             job->setSubscriptionId( node->id() );
             return job;
         }
-        
+
     private:
         QPointer<QWidget> m_widget;
         QPointer<DeleteSubscriptionJob> m_job;
@@ -116,19 +117,19 @@
 public:
     explicit Private( DeleteSubscriptionCommand* qq );
     ~Private();
-    
+
     void startDelete();
     void jobFinished();
-    
-    FeedList* m_list;
+
+    weak_ptr<FeedList> m_list;
     int m_subscriptionId;
 };
 
 DeleteSubscriptionCommand::Private::Private( DeleteSubscriptionCommand* qq ) : q( qq ),
-                                                                               m_list( 0 ),
+                                                                               m_list(),
                                                                                m_subscriptionId( -1 )
 {
-    
+
 }
 
 DeleteSubscriptionCommand::Private::~Private()
@@ -144,7 +145,7 @@
     delete d;
 }
 
-void DeleteSubscriptionCommand::setSubscription( FeedList* feedList, int subId )
+void DeleteSubscriptionCommand::setSubscription( const weak_ptr<FeedList>& feedList, int subId )
 {
     d->m_list = feedList;
     d->m_subscriptionId = subId;
@@ -155,11 +156,11 @@
     return d->m_subscriptionId;
 }
 
-FeedList* DeleteSubscriptionCommand::feedList() const
+weak_ptr<FeedList> DeleteSubscriptionCommand::feedList() const
 {
     return d->m_list;
 }
-    
+
 void DeleteSubscriptionCommand::doStart()
 {
     QTimer::singleShot( 0, this, SLOT( startDelete() ) );
@@ -172,7 +173,12 @@
 
 void DeleteSubscriptionCommand::Private::startDelete()
 {
-    TreeNode* const node = m_list->findByID( m_subscriptionId );
+    const shared_ptr<FeedList> list = m_list.lock();
+    if ( !list ) {
+        q->done();
+        return;
+    }
+    TreeNode* const node = list->findByID( m_subscriptionId );
     DeleteNodeVisitor visitor( q->parentWidget() );
     DeleteSubscriptionJob* job = visitor.createJob( node );
     if ( !job )
@@ -180,14 +186,14 @@
         q->done();
         return;
     }
-    
+
     QObject::connect( job, SIGNAL( finished( KJob* ) ), q, SLOT( jobFinished() ) );
     job->start();
 }
 
 void DeleteSubscriptionCommand::doAbort()
 {
-    
+
 }
 
 #include "deletesubscriptioncommand.moc"
diff -Naur akregator-orig/src/deletesubscriptioncommand.h akregator/src/deletesubscriptioncommand.h
--- akregator-orig/src/deletesubscriptioncommand.h	2008-03-25 19:23:11.000000000 +0200
+++ akregator/src/deletesubscriptioncommand.h	2009-06-18 11:58:51.904746253 +0300
@@ -29,6 +29,8 @@
 
 #include <QVector>
 
+#include <boost/weak_ptr.hpp>
+
 namespace Akregator {
 
 class FeedList;
@@ -39,16 +41,16 @@
 public:
     explicit DeleteSubscriptionCommand( QObject* parent = 0 );
     ~DeleteSubscriptionCommand();
-    
-    void setSubscription( FeedList* feedList, int subId );
-    
+
+    void setSubscription( const boost::weak_ptr<FeedList>& feedList, int subId );
+
     int subscriptionId() const;
-    FeedList* feedList() const;
-    
+    boost::weak_ptr<FeedList> feedList() const;
+
 private:
     void doStart();
     void doAbort();
-    
+
 private:
     class Private;
     Private* const d;
diff -Naur akregator-orig/src/dummystorage/storagedummyimpl.cpp akregator/src/dummystorage/storagedummyimpl.cpp
--- akregator-orig/src/dummystorage/storagedummyimpl.cpp	2008-11-19 12:18:54.000000000 +0200
+++ akregator/src/dummystorage/storagedummyimpl.cpp	2009-06-18 11:58:51.898620837 +0300
@@ -1,7 +1,7 @@
 /*
     This file is part of Akregator.
 
-    2005 Frank Osterfeld <osterfeld@kde.org>
+    Copyright 2005 Frank Osterfeld <osterfeld@kde.org>
 
     This program is free software; you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
diff -Naur akregator-orig/src/editsubscriptioncommand.cpp akregator/src/editsubscriptioncommand.cpp
--- akregator-orig/src/editsubscriptioncommand.cpp	2008-03-25 19:23:11.000000000 +0200
+++ akregator/src/editsubscriptioncommand.cpp	2009-06-18 11:58:51.903746150 +0300
@@ -36,6 +36,7 @@
 #include <cassert>
 
 using namespace Akregator;
+using namespace boost;
 
 namespace {
 
@@ -43,7 +44,7 @@
 {
 public:
     EditNodePropertiesVisitor( SubscriptionListView* subcriptionListView, QWidget* parent );
-    
+
     bool visitFolder(Folder* node)
     {
         m_subscriptionListView->startNodeRenaming( node );
@@ -78,21 +79,21 @@
 public:
     explicit Private( EditSubscriptionCommand* qq );
     ~Private();
-    
+
     void startEdit();
     void jobFinished();
-    
-    FeedList* m_list;
+
+    shared_ptr<FeedList> m_list;
     int m_subscriptionId;
     SubscriptionListView* m_subscriptionListView;
 };
 
 EditSubscriptionCommand::Private::Private( EditSubscriptionCommand* qq ) : q( qq ),
-                                                                               m_list( 0 ),
+                                                                               m_list(),
                                                                                m_subscriptionId( -1 ),
                                                                                m_subscriptionListView( 0 )
 {
-    
+
 }
 
 EditSubscriptionCommand::Private::~Private()
@@ -108,7 +109,7 @@
     delete d;
 }
 
-void EditSubscriptionCommand::setSubscription( FeedList* feedList, int subId )
+void EditSubscriptionCommand::setSubscription( const shared_ptr<FeedList>& feedList, int subId )
 {
     d->m_list = feedList;
     d->m_subscriptionId = subId;
@@ -119,7 +120,7 @@
     return d->m_subscriptionId;
 }
 
-FeedList* EditSubscriptionCommand::feedList() const
+shared_ptr<FeedList> EditSubscriptionCommand::feedList() const
 {
     return d->m_list;
 }
@@ -143,17 +144,19 @@
 void EditSubscriptionCommand::Private::startEdit()
 {
     TreeNode* const node = m_list->findByID( m_subscriptionId );
-    if ( !node )
+    if ( !node ) {
+        q->done();
         return;
-    
-    EditNodePropertiesVisitor visitor( m_subscriptionListView, q->parentWidget() );  
+    }
+
+    EditNodePropertiesVisitor visitor( m_subscriptionListView, q->parentWidget() );
     visitor.visit( node );
     q->done();
 }
 
 void EditSubscriptionCommand::doAbort()
 {
-    
+
 }
 
 #include "editsubscriptioncommand.moc"
diff -Naur akregator-orig/src/editsubscriptioncommand.h akregator/src/editsubscriptioncommand.h
--- akregator-orig/src/editsubscriptioncommand.h	2008-03-25 19:23:11.000000000 +0200
+++ akregator/src/editsubscriptioncommand.h	2009-06-18 11:58:51.903746150 +0300
@@ -27,6 +27,8 @@
 
 #include "command.h"
 
+#include <boost/shared_ptr.hpp>
+
 namespace Akregator {
 
 class FeedList;
@@ -38,19 +40,19 @@
 public:
     explicit EditSubscriptionCommand( QObject* parent = 0 );
     ~EditSubscriptionCommand();
-    
-    void setSubscription( FeedList* feedList, int subId );    
+
+    void setSubscription( const boost::shared_ptr<FeedList>& feedList, int subId );
     int subscriptionId() const;
-    FeedList* feedList() const;
+    boost::shared_ptr<FeedList> feedList() const;
 
     SubscriptionListView* subscriptionListView() const;
     void setSubscriptionListView( SubscriptionListView* view );
 
-    
+
 private:
     void doStart();
     void doAbort();
-    
+
 private:
     class Private;
     Private* const d;
diff -Naur akregator-orig/src/expireitemscommand.cpp akregator/src/expireitemscommand.cpp
--- akregator-orig/src/expireitemscommand.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/expireitemscommand.cpp	2009-06-18 11:58:51.904746253 +0300
@@ -34,8 +34,11 @@
 #include <QSet>
 #include <QTimer>
 
+#include <boost/shared_ptr.hpp>
+
 #include <cassert>
 
+using namespace boost;
 using namespace Akregator;
 
 class ExpireItemsCommand::Private
@@ -48,7 +51,7 @@
     void addDeleteJobForFeed( Feed* feed );
     void jobFinished( KJob* );
 
-    QPointer<FeedList> m_feedList;
+    weak_ptr<FeedList> m_feedList;
     QVector<int> m_feeds;
     QSet<KJob*> m_jobs;
 };
@@ -80,9 +83,11 @@
 void ExpireItemsCommand::Private::createDeleteJobs()
 {
     assert( m_jobs.isEmpty() );
-    if ( m_feeds.isEmpty() || !m_feedList )
+    const shared_ptr<FeedList> feedList = m_feedList.lock();
+
+    if ( m_feeds.isEmpty() || !feedList )
     {
-        if ( !m_feedList )
+        if ( !feedList )
             kWarning() << "Associated feed list was deleted, could not expire items";
         q->done();
         return;
@@ -90,7 +95,7 @@
 
     Q_FOREACH ( const int i, m_feeds )
     {
-        Feed* const feed = qobject_cast<Feed*>( m_feedList->findByID( i ) );
+        Feed* const feed = qobject_cast<Feed*>( feedList->findByID( i ) );
         if ( feed )
             addDeleteJobForFeed( feed );
     }
@@ -105,12 +110,12 @@
     delete d;
 }
 
-void ExpireItemsCommand::setFeedList( FeedList* feedList )
+void ExpireItemsCommand::setFeedList( const weak_ptr<FeedList>& feedList )
 {
     d->m_feedList = feedList;
 }
 
-FeedList* ExpireItemsCommand::feedList() const
+weak_ptr<FeedList> ExpireItemsCommand::feedList() const
 {
     return d->m_feedList;
 }
diff -Naur akregator-orig/src/expireitemscommand.h akregator/src/expireitemscommand.h
--- akregator-orig/src/expireitemscommand.h	2008-03-25 19:23:11.000000000 +0200
+++ akregator/src/expireitemscommand.h	2009-06-18 11:58:51.902621085 +0300
@@ -29,6 +29,8 @@
 
 #include <QVector>
 
+#include <boost/weak_ptr.hpp>
+
 namespace Akregator {
 
 class FeedList;
@@ -40,12 +42,12 @@
     explicit ExpireItemsCommand( QObject* parent = 0 );
     ~ExpireItemsCommand();
 
-    void setFeedList( FeedList* feedList );
-    FeedList* feedList() const;
-    
+    void setFeedList( const boost::weak_ptr<FeedList>& feedList );
+    boost::weak_ptr<FeedList> feedList() const;
+
     void setFeeds( const QVector<int>& feeds );
     QVector<int> feeds() const;
-    
+
 private:
     void doStart();
     void doAbort();
diff -Naur akregator-orig/src/feed.cpp akregator/src/feed.cpp
--- akregator-orig/src/feed.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/feed.cpp	2009-06-18 11:58:51.902621085 +0300
@@ -24,9 +24,9 @@
 */
 
 #include "akregatorconfig.h"
+#include "feed.h"
 #include "article.h"
 #include "articlejobs.h"
-#include "feed.h"
 #include "feediconmanager.h"
 #include "feedstorage.h"
 #include "fetchqueue.h"
@@ -414,7 +414,7 @@
     if (d->loadLinkedWebsite)
         el.setAttribute( "loadLinkedWebsite", "true" );
     el.setAttribute( "maxArticleNumber", d->maxArticleNumber );
-    el.setAttribute( "type", "rss" ); // despite some additional fields, its still "rss" OPML
+    el.setAttribute( "type", "rss" ); // despite some additional fields, it is still "rss" OPML
     el.setAttribute( "version", "RSS" );
     parent.appendChild( el );
     return el;
@@ -657,7 +657,7 @@
                                 + Utils::fileNameForUrl(d->xmlUrl) + ".png";
         d->imagePixmap=QPixmap(imageFileName, "PNG");
 
-        // if we aint got teh image and the feed provides one, get it....
+        // if we ain't got the image and the feed provides one, get it....
         // TODO: reenable image fetching!
         if (false) // d->imagePixmap.isNull() && doc.image())
         {
diff -Naur akregator-orig/src/feed.h akregator/src/feed.h
--- akregator-orig/src/feed.h	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/feed.h	2009-06-18 11:58:51.902621085 +0300
@@ -51,8 +51,8 @@
 /** represents a feed */
 class AKREGATORPART_EXPORT Feed : public TreeNode, public virtual FaviconListener
 {
-    friend class Article;
-
+    friend class ::Akregator::Article;
+    friend class ::Akregator::Folder;
     Q_OBJECT
     public:
         /** the archiving modes */
@@ -167,8 +167,6 @@
         /** sets the description of this feed */
         void setDescription(const QString& s);
 
-        QList<Article> articles();
-
         /** returns article by guid
             * @param guid the guid of the article to be returned
             * @return the article object with the given guid, or a
@@ -246,6 +244,8 @@
         Akregator::Backend::Storage* storage();
 
     private:
+        QList<Article> articles();
+
         /** loads articles from archive **/
         void loadArticles();
         void enforceLimitArticleNumber();
diff -Naur akregator-orig/src/feedlist.cpp akregator/src/feedlist.cpp
--- akregator-orig/src/feedlist.cpp	2008-11-19 12:18:54.000000000 +0200
+++ akregator/src/feedlist.cpp	2009-06-18 11:58:51.900620759 +0300
@@ -21,8 +21,9 @@
     with any edition of Qt, and distribute the resulting executable,
     without including the source code for Qt in the source distribution.
 */
-#include "storage.h"
+
 #include "feedlist.h"
+#include "storage.h"
 #include "article.h"
 #include "feed.h"
 #include "folder.h"
@@ -43,19 +44,25 @@
 
 #include <cassert>
 
+using namespace boost;
+
 namespace Akregator {
 
 class FeedList::Private
 {
+    FeedList* const q;
+
 public:
+    Private( Backend::Storage* st, FeedList* qq );
+
     Akregator::Backend::Storage* storage;
     QList<TreeNode*> flatList;
     Folder* rootNode;
-    QString title;
     QHash<int, TreeNode*> idMap;
     AddNodeVisitor* addNodeVisitor;
     RemoveNodeVisitor* removeNodeVisitor;
     QHash<QString, QList<Feed*> > urlMap;
+    mutable int unreadCache;
 };
 
 class FeedList::AddNodeVisitor : public TreeNodeVisitor
@@ -155,18 +162,22 @@
         FeedList* m_list;
 };
 
-FeedList::FeedList(Akregator::Backend::Storage* storage, QObject *parent)
-    : QObject(parent), d(new Private)
-{
+FeedList::Private::Private( Backend::Storage* st, FeedList* qq )
+    : q( qq )
+    , storage( st )
+    , rootNode( 0 )
+    , addNodeVisitor( new AddNodeVisitor( q ) )
+    , removeNodeVisitor( new RemoveNodeVisitor( q ) )
+    , unreadCache( -1 ) {
     Q_ASSERT( storage );
-    d->storage = storage;
-    d->rootNode = 0;
-    d->addNodeVisitor = new AddNodeVisitor(this);
-    d->removeNodeVisitor = new RemoveNodeVisitor(this);
-    Folder* rootNode = new Folder(i18n("All Feeds"));
-    rootNode->setId(1);
-    setRootNode(rootNode);
-    addNode(rootNode, true);
+}
+
+FeedList::FeedList( Backend::Storage* storage )
+    : QObject( 0 ), d( new Private( storage, this ) ) {
+    Folder* rootNode = new Folder( i18n("All Feeds") );
+    rootNode->setId( 1 );
+    setRootNode( rootNode );
+    addNode( rootNode, true );
 }
 
 QVector<int> FeedList::feedIds() const
@@ -281,11 +292,11 @@
 
     while( !i.isNull() )
     {
-        parseChildNodes(i, rootNode());
+        parseChildNodes(i, allFeedsFolder());
         i = i.nextSibling();
     }
 
-    for (TreeNode* i = rootNode()->firstChild(); i && i != rootNode(); i = i->next() )
+    for (TreeNode* i = allFeedsFolder()->firstChild(); i && i != allFeedsFolder(); i = i->next() )
         if (i->id() == 0)
     {
             uint id = generateID();
@@ -294,7 +305,7 @@
     }
 
     kDebug() <<"measuring startup time: STOP," << spent.elapsed() <<"ms";
-    kDebug() <<"Number of articles loaded:" << rootNode()->totalCount();
+    kDebug() <<"Number of articles loaded:" << allFeedsFolder()->totalCount();
     return true;
 }
 
@@ -335,14 +346,14 @@
         return;
 
     if ( !d->flatList.contains(parent) )
-        parent = rootNode();
+        parent = allFeedsFolder();
 
-    QList<TreeNode*> children = list->rootNode()->children();
+    QList<TreeNode*> children = list->allFeedsFolder()->children();
 
     QList<TreeNode*>::ConstIterator end(  children.constEnd() );
     for (QList<TreeNode*>::ConstIterator it = children.constBegin(); it != end; ++it)
     {
-        list->rootNode()->removeChild(*it);
+        list->allFeedsFolder()->removeChild(*it);
         parent->insertChild(*it, after);
         after = *it;
     }
@@ -363,23 +374,15 @@
     QDomElement ti = doc.createElement( "text" );
     head.appendChild( ti );
 
-    QDomText t = doc.createTextNode( title() );
-    ti.appendChild( t );
-
     QDomElement body = doc.createElement( "body" );
     root.appendChild( body );
 
-    foreach( const TreeNode* const i, rootNode()->children() )
+    foreach( const TreeNode* const i, allFeedsFolder()->children() )
         body.appendChild( i->toOPML(body, doc) );
 
     return doc;
 }
 
-QString FeedList::title() const
-{
-    return d->title;
-}
-
 const TreeNode* FeedList::findByID(int id) const
 {
     return d->idMap[id];
@@ -392,25 +395,20 @@
 
 QList<const TreeNode*> FeedList::findByTitle(const QString& title ) const
 {
-    return rootNode()->namedChildren( title );
+    return allFeedsFolder()->namedChildren( title );
 }
 
 QList<TreeNode*> FeedList::findByTitle(const QString& title )
 {
-    return rootNode()->namedChildren( title );
-}
-
-void FeedList::setTitle(const QString& title)
-{
-    d->title = title;
+    return allFeedsFolder()->namedChildren( title );
 }
 
-const Folder* FeedList::rootNode() const
+const Folder* FeedList::allFeedsFolder() const
 {
     return d->rootNode;
 }
 
-Folder* FeedList::rootNode()
+Folder* FeedList::allFeedsFolder()
 {
     return d->rootNode;
 }
@@ -420,28 +418,31 @@
     return d->rootNode->firstChild() == 0;
 }
 
-void FeedList::clear()
-{
-    Q_ASSERT(rootNode());
-
-    QList<TreeNode*> children = rootNode()->children();
-
-    for (QList<TreeNode*>::ConstIterator it = children.constBegin(); it != children.constEnd(); ++it)
-        delete *it; // emits signal "emitSignalDestroyed"
+void FeedList::rootNodeChanged() {
+    assert( d->rootNode );
+    const int newUnread = d->rootNode->unread();
+    if ( newUnread == d->unreadCache )
+        return;
+    d->unreadCache = newUnread;
+    emit unreadCountChanged( newUnread );
 }
 
 void FeedList::setRootNode(Folder* folder)
 {
+    if ( folder == d->rootNode )
+        return;
+
     delete d->rootNode;
     d->rootNode = folder;
+    d->unreadCache = -1;
 
-    if (d->rootNode)
-    {
+    if ( d->rootNode ) {
         d->rootNode->setOpen(true);
         connect(d->rootNode, SIGNAL(signalChildAdded(Akregator::TreeNode*)), this, SLOT(slotNodeAdded(Akregator::TreeNode*)));
         connect(d->rootNode, SIGNAL(signalAboutToRemoveChild(Akregator::TreeNode*)), this, SIGNAL(signalAboutToRemoveNode(Akregator::TreeNode*)));
         connect(d->rootNode, SIGNAL(signalChildRemoved(Akregator::Folder*, Akregator::TreeNode*)), this, SLOT(slotNodeRemoved(Akregator::Folder*, Akregator::TreeNode*)));
         connect( d->rootNode, SIGNAL( signalChanged(Akregator::TreeNode* ) ), this, SIGNAL( signalNodeChanged(Akregator::TreeNode* ) ) );
+        connect( d->rootNode, SIGNAL( signalChanged(Akregator::TreeNode* ) ), this, SLOT(rootNodeChanged()) );
     }
 }
 
@@ -476,12 +477,27 @@
     emit signalNodeRemoved( node );
 }
 
-FeedListManagementImpl::FeedListManagementImpl( FeedList* list ) : m_feedList( list )
+int FeedList::unread() const {
+    if ( d->unreadCache == -1 )
+        d->unreadCache = d->rootNode ? d->rootNode->unread() : 0;
+    return d->unreadCache;
+}
+
+void FeedList::addToFetchQueue( FetchQueue* qu, bool intervalOnly ) {
+    if ( d->rootNode )
+        d->rootNode->slotAddToFetchQueue( qu, intervalOnly );
+}
+
+KJob* FeedList::createMarkAsReadJob() {
+    return d->rootNode ? d->rootNode->createMarkAsReadJob() : 0;
+}
+
+FeedListManagementImpl::FeedListManagementImpl( const shared_ptr<FeedList>& list ) : m_feedList( list )
 {
 
 }
 
-void FeedListManagementImpl::setFeedList( FeedList* list )
+void FeedListManagementImpl::setFeedList( const shared_ptr<FeedList>& list )
 {
     m_feedList = list;
 }
@@ -547,7 +563,7 @@
     Feed * new_feed = new Feed( Kernel::self()->storage() );
     new_feed->setXmlUrl(url);
     // new_feed->setTitle(url);
-    new_feedlist->rootNode()->appendChild(new_feed);
+    new_feedlist->allFeedsFolder()->appendChild(new_feed);
 
     // Get last in the folder
     TreeNode* m_last = m_folder->childAt( m_folder->totalCount() );
@@ -576,11 +592,13 @@
 
 QString FeedListManagementImpl::addCategory( const QString& name, const QString& parentId ) const
 {
+    Q_UNUSED( parentId )
+
     if ( !m_feedList )
         return "";
 
     Folder * m_folder = new Folder(name);
-    m_feedList->rootNode()->appendChild(m_folder);
+    m_feedList->allFeedsFolder()->appendChild(m_folder);
 
     return QString::number(m_folder->id());
 }
diff -Naur akregator-orig/src/feedlist.h akregator/src/feedlist.h
--- akregator-orig/src/feedlist.h	2008-08-28 19:13:16.000000000 +0300
+++ akregator/src/feedlist.h	2009-06-18 11:58:51.899620796 +0300
@@ -32,17 +32,22 @@
 #include <QObject>
 #include <QPointer>
 
+#include <boost/shared_ptr.hpp>
+
 class QDomDocument;
 class QDomNode;
 template <class T> class QList;
 template <class K,class T> class QHash;
 class QString;
 
+class KJob;
+
 namespace Akregator {
 
 class Article;
 class Feed;
 class FeedList;
+class FetchQueue;
 class Folder;
 class TreeNode;
 
@@ -53,8 +58,8 @@
 
 class AKREGATORPART_EXPORT FeedListManagementImpl : public FeedListManagementInterface {
 public:
-    explicit FeedListManagementImpl( FeedList* list=0 );
-    void setFeedList( FeedList* list );
+    explicit FeedListManagementImpl( const boost::shared_ptr<FeedList>& list=boost::shared_ptr<FeedList>() );
+    void setFeedList( const boost::shared_ptr<FeedList>& list );
 
     /* reimp */ QStringList categories() const;
     /* reimp */ QStringList feeds( const QString& catId ) const;
@@ -64,7 +69,7 @@
     /* reimp */ QString getCategoryName( const QString& catId ) const;
 
 private:
-    QPointer<FeedList> m_feedList;
+    boost::shared_ptr<FeedList> m_feedList;
 };
 
 /** The model of a feed tree, represents an OPML document. Contains an additional root node "All Feeds" which isn't stored. Note that a node instance must not be in more than one FeedList at a time! When deleting the feed list, all contained nodes are deleted! */
@@ -74,13 +79,13 @@
     Q_OBJECT
 public:
 
-    explicit FeedList(Akregator::Backend::Storage* storage, QObject *parent = 0);
+    explicit FeedList(Akregator::Backend::Storage* storage);
 
     /** Destructor. Contained nodes are deleted! */
     ~FeedList();
 
-    const Folder* rootNode() const;
-    Folder* rootNode();
+    const Folder* allFeedsFolder() const;
+    Folder* allFeedsFolder();
 
     bool isEmpty() const;
 
@@ -130,12 +135,10 @@
 
     const Article findArticle(const QString& feedURL, const QString& guid) const;
 
-public slots:
+    int unread() const;
 
-    /**
-     * Clears the list without touching the root node.
-     */
-    void clear();
+    void addToFetchQueue( FetchQueue* queue, bool intervalOnly=false );
+    KJob* createMarkAsReadJob();
 
 signals:
 
@@ -165,6 +168,8 @@
     /** emitted when a fetch is aborted */
     void fetchAborted(Akregator::Feed *);
 
+    void unreadCountChanged( int unread );
+
 private:
 
     void addNode(TreeNode* node, bool preserveID);
@@ -180,6 +185,7 @@
     void slotNodeDestroyed(Akregator::TreeNode* node);
     void slotNodeAdded(Akregator::TreeNode* node);
     void slotNodeRemoved(Akregator::Folder* parent, Akregator::TreeNode* node);
+    void rootNodeChanged();
 
 private:
     friend class AddNodeVisitor;
diff -Naur akregator-orig/src/feedpropertiesdialog.cpp akregator/src/feedpropertiesdialog.cpp
--- akregator-orig/src/feedpropertiesdialog.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/feedpropertiesdialog.cpp	2009-06-18 11:58:51.901620775 +0300
@@ -23,7 +23,6 @@
 */
 
 #include "akregatorconfig.h"
-#include "feed.h"
 #include "feedpropertiesdialog.h"
 
 #include <kcombobox.h>
diff -Naur akregator-orig/src/feedpropertiesdialog.h akregator/src/feedpropertiesdialog.h
--- akregator-orig/src/feedpropertiesdialog.h	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/feedpropertiesdialog.h	2009-06-18 11:58:51.906745945 +0300
@@ -21,9 +21,11 @@
     with any edition of Qt, and distribute the resulting executable,
     without including the source code for Qt in the source distribution.
 */
-#ifndef AKREGATOR_PROPERTIESDIALOG_H
-#define AKREGATOR_PROPERTIESDIALOG_H
 
+#ifndef AKREGATOR_FEEDPROPERTIESDIALOG_H
+#define AKREGATOR_FEEDPROPERTIESDIALOG_H
+
+#include "feed.h"
 #include "ui_feedpropertieswidgetbase.h"
 
 #include <kdialog.h>
@@ -32,6 +34,7 @@
 
 namespace Akregator {
 
+
 class FeedPropertiesWidget : public QWidget, public Ui::FeedPropertiesWidgetBase
 {
     Q_OBJECT
@@ -100,4 +103,5 @@
 
 } // namespace Akregator
 
-#endif // AKREGATOR_PROPERTIESDIALOG_H
+#endif // AKREGATOR_FEEDPROPERTIESDIALOG_H
+
diff -Naur akregator-orig/src/feedpropertieswidgetbase.ui akregator/src/feedpropertieswidgetbase.ui
--- akregator-orig/src/feedpropertieswidgetbase.ui	2008-02-07 15:20:21.000000000 +0200
+++ akregator/src/feedpropertieswidgetbase.ui	2009-06-18 11:58:51.906745945 +0300
@@ -1,7 +1,4 @@
 <ui version="4.0" >
- <author></author>
- <comment></comment>
- <exportmacro></exportmacro>
  <class>Akregator::FeedPropertiesWidgetBase</class>
  <widget class="QWidget" name="Akregator::FeedPropertiesWidgetBase" >
   <property name="geometry" >
@@ -407,8 +404,6 @@
    </item>
   </layout>
  </widget>
- <layoutdefault spacing="6" margin="11" />
- <pixmapfunction>qPixmapFromMimeSource</pixmapfunction>
  <customwidgets>
   <customwidget>
    <class>KLineEdit</class>
diff -Naur akregator-orig/src/feed.protocol akregator/src/feed.protocol
--- akregator-orig/src/feed.protocol	2008-01-15 03:57:29.000000000 +0200
+++ akregator/src/feed.protocol	2009-06-18 11:58:51.906745945 +0300
@@ -5,7 +5,7 @@
 output=none
 helper=true
 reading=false
-listing=false
+listing=
 writing=false
 makedir=false
 deleting=false
diff -Naur akregator-orig/src/folder.cpp akregator/src/folder.cpp
--- akregator-orig/src/folder.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/folder.cpp	2009-06-18 11:58:51.906745945 +0300
@@ -181,7 +181,7 @@
     if (pos < 0)
         prependChild(node);
     else
-        insertChild(pos+1, node);
+        insertChild(pos, node);
 }
 
 QIcon Folder::icon() const
diff -Naur akregator-orig/src/folder.h akregator/src/folder.h
--- akregator-orig/src/folder.h	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/folder.h	2009-06-18 11:58:51.901620775 +0300
@@ -60,10 +60,6 @@
 
         bool accept(TreeNodeVisitor* visitor);
 
-        /** returns recursively concatenated articles of children
-        @return an article sequence containing articles of children */
-        QList<Article> articles();
-
         /** returns the number of unread articles in all children
         @return number of unread articles */
         int unread() const;
@@ -198,6 +194,7 @@
         void doArticleNotification();
 
     private:
+        QList<Article> articles();
 
         void connectToNode(TreeNode* child);
         void disconnectFromNode(TreeNode* child);
diff -Naur akregator-orig/src/frame.cpp akregator/src/frame.cpp
--- akregator-orig/src/frame.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/frame.cpp	2009-06-18 11:58:51.907746085 +0300
@@ -22,6 +22,8 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include "frame.h"
+
 #include <QGridLayout>
 #include <QRegExp>
 
@@ -32,11 +34,8 @@
 #include <kparts/browserextension.h>
 #include <kparts/part.h>
 
-
 #include <libkdepim/progressmanager.h>
 
-#include "frame.h"
-
 namespace Akregator {
 
 
@@ -208,7 +207,7 @@
     return m_progress;
 }
 
-MainFrame::MainFrame(QWidget* parent, KParts::ReadOnlyPart* part, QWidget* visibleWidget, const QString& /*title*/) : Frame(parent), m_part(part)
+MainFrame::MainFrame(QWidget* parent, KParts::ReadOnlyPart* part, QWidget* visibleWidget) : Frame(parent), m_part(part)
 {
     setRemovable(false);
     QGridLayout* layout = new QGridLayout(this);
diff -Naur akregator-orig/src/frame.h akregator/src/frame.h
--- akregator-orig/src/frame.h	2008-09-26 17:56:29.000000000 +0300
+++ akregator/src/frame.h	2009-06-18 11:58:51.903746150 +0300
@@ -175,7 +175,7 @@
 
     public:
 
-        MainFrame(QWidget* /*parent*/, KParts::ReadOnlyPart* /*part*/, QWidget* /*widget*/, const QString& /*title*/);
+        MainFrame(QWidget* parent, KParts::ReadOnlyPart* part, QWidget* widget);
         virtual ~MainFrame();
 
         virtual KUrl url() const;
diff -Naur akregator-orig/src/framemanager.cpp akregator/src/framemanager.cpp
--- akregator-orig/src/framemanager.cpp	2008-11-04 19:12:56.000000000 +0200
+++ akregator/src/framemanager.cpp	2009-06-18 11:58:51.906745945 +0300
@@ -22,12 +22,12 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "actionmanager.h"
 #include "akregatorconfig.h"
+#include "framemanager.h"
+#include "frame.h"
+#include "actionmanager.h"
 #include "browserrun.h"
 #include "browserframe.h"
-#include "frame.h"
-#include "framemanager.h"
 #include "openurlrequest.h"
 
 #include <kaction.h>
@@ -89,7 +89,7 @@
 
 void FrameManager::slotRemoveFrame(int id)
 {
-    Frame* frame = m_frames[id];
+    Frame* frame = m_frames.value(id);
 
     if (!frame)
         return;
@@ -102,20 +102,20 @@
         slotChangeFrame(-1);
     }
 
-    m_frames[id] = 0;
+    m_frames.insert(id, 0);
     m_frames.remove(id);
     emit signalFrameRemoved(id);
-    frame->deleteLater();
+    delete frame;
 }
 
 Frame* FrameManager::findFrameById(int id) const
 {
-    return m_frames[id];
+    return m_frames.value(id);
 }
 
 void FrameManager::slotChangeFrame(int frameId)
 {
-    Frame* frame = m_frames[frameId];
+    Frame* frame = m_frames.value(frameId);
     if (frame == m_currentFrame)
         return;
 
@@ -255,6 +255,7 @@
     if (!request.openInBackground())
         emit signalSelectFrame(request.frameId());
 }
+
 void FrameManager::openInExternalBrowser(const OpenUrlRequest& request)
 {
     KUrl url = request.url();
@@ -360,7 +361,7 @@
 
     config.writeEntry( QString::fromLatin1( "Children" ), strlst );
     config.writeEntry( QString::fromLatin1( "activeChildIndex" ),
-        m_frames.key(m_currentFrame) );
+                       m_frames.key(m_currentFrame) );
 }
 
 } // namespace Akregator
diff -Naur akregator-orig/src/importfeedlistcommand.cpp akregator/src/importfeedlistcommand.cpp
--- akregator-orig/src/importfeedlistcommand.cpp	1970-01-01 02:00:00.000000000 +0200
+++ akregator/src/importfeedlistcommand.cpp	2009-06-18 11:58:51.905745944 +0300
@@ -0,0 +1,157 @@
+/*
+    This file is part of Akregator.
+
+    Copyright (C) 2009 Frank Osterfeld <osterfeld@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "importfeedlistcommand.h"
+
+#include "feedlist.h"
+#include "folder.h"
+#include "kernel.h"
+
+#include <KDebug>
+#include <KInputDialog>
+#include <KLocalizedString>
+
+#include <QDomDocument>
+#include <QPointer>
+#include <QTimer>
+
+#include <boost/shared_ptr.hpp>
+
+#include <cassert>
+
+using namespace boost;
+using namespace Akregator;
+
+class ImportFeedListCommand::Private
+{
+    ImportFeedListCommand* const q;
+public:
+    explicit Private( ImportFeedListCommand* qq );
+
+    void doImport();
+
+    weak_ptr<FeedList> targetList;
+    QDomDocument document;
+    ImportFeedListCommand::RootFolderOption rootFolderOption;
+    QString importedRootFolderName;
+};
+
+ImportFeedListCommand::Private::Private( ImportFeedListCommand* qq )
+    : q( qq )
+    , targetList()
+    , rootFolderOption( Ask )
+    , importedRootFolderName( i18n("Imported Feeds") )
+{
+
+}
+
+void ImportFeedListCommand::Private::doImport()
+{
+    const shared_ptr<FeedList> target = targetList.lock();
+
+    if ( !target )
+    {
+        if ( !target )
+            kWarning() << "Target list was deleted, could not import feed list";
+        q->done();
+        return;
+    }
+
+    std::auto_ptr<FeedList> importedList( new FeedList( Kernel::self()->storage() ) );
+    const bool parsed = importedList->readFromOpml( document );
+
+    // FIXME: parsing error, print some message
+    if (!parsed) {
+        q->done();
+        return;
+    }
+
+
+    QPointer<QObject> that( q );
+
+    bool ok;
+
+    if ( rootFolderOption == ImportFeedListCommand::Ask )
+        importedRootFolderName = KInputDialog::getText( i18n("Add Imported Folder"),
+                i18n("Imported folder name:"),
+                importedRootFolderName,
+                &ok,
+                q->parentWidget() );
+
+
+    if ( !ok || !that ) {
+        if ( that )
+            q->done();
+        return;
+    }
+
+    Folder* folder = target->allFeedsFolder();
+
+    if ( rootFolderOption != None ) {
+        folder = new Folder( importedRootFolderName );
+        target->allFeedsFolder()->appendChild( folder );
+    }
+
+    target->append( importedList.get(), folder );
+
+    q->done();
+}
+
+ImportFeedListCommand::ImportFeedListCommand( QObject* parent ) : Command( parent ), d( new Private( this ) )
+{
+}
+
+ImportFeedListCommand::~ImportFeedListCommand()
+{
+    delete d;
+}
+
+void ImportFeedListCommand::setTargetList( const weak_ptr<FeedList>& feedList )
+{
+    d->targetList = feedList;
+}
+
+void ImportFeedListCommand::setImportedRootFolderOption( RootFolderOption opt ) {
+    d->rootFolderOption = opt;
+}
+
+void ImportFeedListCommand::setImportedRootFolderName( const QString& defaultName ) {
+    d->importedRootFolderName = defaultName;
+}
+
+void ImportFeedListCommand::setFeedListDocument( const QDomDocument& doc ) {
+    d->document = doc;
+}
+
+void ImportFeedListCommand::doAbort()
+{
+    //TODO
+}
+
+void ImportFeedListCommand::doStart()
+{
+    QTimer::singleShot( 0, this, SLOT( doImport() ) );
+}
+
+#include "importfeedlistcommand.moc"
diff -Naur akregator-orig/src/importfeedlistcommand.h akregator/src/importfeedlistcommand.h
--- akregator-orig/src/importfeedlistcommand.h	1970-01-01 02:00:00.000000000 +0200
+++ akregator/src/importfeedlistcommand.h	2009-06-18 11:58:51.904746253 +0300
@@ -0,0 +1,71 @@
+/*
+    This file is part of Akregator.
+
+    Copyright (C) 2009 Frank Osterfeld <osterfeld@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef AKREGATOR_IMPORTFEEDLISTCOMMAND_H
+#define AKREGATOR_IMPORTFEEDLISTCOMMAND_H
+
+#include "command.h"
+
+#include <boost/weak_ptr.hpp>
+
+class QDomDocument;
+
+namespace Akregator {
+
+class FeedList;
+
+class ImportFeedListCommand : public Command
+{
+    Q_OBJECT
+public:
+    explicit ImportFeedListCommand( QObject* parent = 0 );
+    ~ImportFeedListCommand();
+
+
+    void setTargetList( const boost::weak_ptr<FeedList>& feedList );
+
+    enum RootFolderOption {
+        None,
+        Auto,
+        Ask
+    };
+
+    void setImportedRootFolderOption( RootFolderOption opt );
+    void setImportedRootFolderName( const QString& defaultName );
+
+    void setFeedListDocument( const QDomDocument& doc );
+
+private:
+    void doStart();
+    void doAbort();
+
+private:
+    class Private;
+    Private* const d;
+    Q_PRIVATE_SLOT( d, void doImport() )
+};
+
+}
+
+#endif // AKREGATOR_IMPORTFEEDLISTCOMMAND_H
diff -Naur akregator-orig/src/kernel.cpp akregator/src/kernel.cpp
--- akregator-orig/src/kernel.cpp	2008-10-23 02:04:14.000000000 +0300
+++ akregator/src/kernel.cpp	2009-06-18 11:58:51.901620775 +0300
@@ -32,6 +32,8 @@
 
 #include <QPointer>
 
+using namespace boost;
+
 namespace Akregator
 {
 
@@ -51,7 +53,7 @@
     public:
 
     Backend::Storage* storage;
-    QPointer<FeedList> feedList;
+    shared_ptr<FeedList> feedList;
     FetchQueue* fetchQueue;
     FrameManager* frameManager;
 };
@@ -81,12 +83,12 @@
     d->storage = storage;
 }
 
-FeedList* Kernel::feedList()
+shared_ptr<FeedList> Kernel::feedList() const
 {
     return d->feedList;
 }
 
-void Kernel::setFeedList(FeedList* feedList)
+void Kernel::setFeedList(const shared_ptr<FeedList>& feedList)
 {
     d->feedList = feedList;
 }
diff -Naur akregator-orig/src/kernel.h akregator/src/kernel.h
--- akregator-orig/src/kernel.h	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/kernel.h	2009-06-18 11:58:51.903746150 +0300
@@ -25,9 +25,11 @@
 #ifndef AKREGATOR_KERNEL_H
 #define AKREGATOR_KERNEL_H
 
+#include <boost/shared_ptr.hpp>
+
 namespace Akregator {
 
-namespace Backend 
+namespace Backend
 {
     class Storage;
 }
@@ -43,12 +45,12 @@
         static Kernel* self();
 
         ~Kernel();
-         
+
         Backend::Storage* storage();
         void setStorage(Backend::Storage* storage);
 
-        FeedList* feedList();
-        void setFeedList(FeedList* feedList);
+        boost::shared_ptr<FeedList> feedList() const;
+        void setFeedList(const boost::shared_ptr<FeedList>& feedList);
 
         FetchQueue* fetchQueue();
 
diff -Naur akregator-orig/src/loadfeedlistcommand.cpp akregator/src/loadfeedlistcommand.cpp
--- akregator-orig/src/loadfeedlistcommand.cpp	1970-01-01 02:00:00.000000000 +0200
+++ akregator/src/loadfeedlistcommand.cpp	2009-06-18 11:58:51.898620837 +0300
@@ -0,0 +1,176 @@
+/*
+    This file is part of Akregator.
+
+    Copyright (C) 2008 Frank Osterfeld <osterfeld@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "loadfeedlistcommand.h"
+
+#include "feedlist.h"
+#include "storage.h"
+
+#include <KLocale>
+#include <KMessageBox>
+#include <KRandom>
+
+#include <QDateTime>
+#include <QDomDocument>
+#include <QFile>
+#include <QPointer>
+#include <QString>
+#include <QTimer>
+
+#include <cassert>
+
+using namespace boost;
+using namespace Akregator;
+using namespace Akregator::Backend;
+
+class LoadFeedListCommand::Private {
+    LoadFeedListCommand* const q;
+public:
+    explicit Private( LoadFeedListCommand* qq ) : q( qq ), storage( 0 ) {}
+    void handleDocument( const QDomDocument& doc );
+    QString createBackup( const QString& path, bool* ok );
+    void emitResult( const shared_ptr<FeedList>& list );
+    void doLoad();
+
+    QString fileName;
+    QDomDocument defaultFeedList;
+    Storage* storage;
+};
+
+void LoadFeedListCommand::Private::emitResult( const shared_ptr<FeedList>& list ) {
+    emit q->result( list );
+    q->done();
+}
+
+void LoadFeedListCommand::Private::handleDocument( const QDomDocument& doc ) {
+    shared_ptr<FeedList> feedList( new FeedList( storage ) );
+    if ( !feedList->readFromOpml( doc ) ) {
+        bool backupCreated;
+        const QString backupFile = createBackup( fileName, &backupCreated );
+        const QString msg = backupCreated
+            ? i18n("<qt>The standard feed list is corrupted (invalid OPML). A backup was created:<p><b>%1</b></p></qt>", backupFile )
+            : i18n("<qt>The standard feed list is corrupted (invalid OPML). Could not create a backup.</p></qt>" );
+
+        QPointer<QObject> that( q );
+        KMessageBox::error( q->parentWidget(), msg, i18n("OPML Parsing Error") );
+        if ( !that )
+            return;
+        feedList.reset();
+    }
+    emitResult( feedList );
+}
+
+QString LoadFeedListCommand::Private::createBackup( const QString& path, bool* ok ) {
+    const QString backup = path
+        + QLatin1String("-backup.")
+        + QString::number(QDateTime::currentDateTime().toTime_t());
+
+    const bool copied = QFile::copy( path, backup );
+    if ( ok )
+        *ok = copied;
+    return backup;
+}
+
+LoadFeedListCommand::LoadFeedListCommand( QObject* parent ) : Command( parent ), d( new Private( this ) ) {
+}
+
+LoadFeedListCommand::~LoadFeedListCommand() {
+    delete d;
+}
+
+void LoadFeedListCommand::setFileName( const QString& fileName ) {
+    d->fileName = fileName;
+}
+void LoadFeedListCommand::setDefaultFeedList( const QDomDocument& doc ) {
+    d->defaultFeedList = doc;
+}
+
+void LoadFeedListCommand::setStorage( Backend::Storage* s ) {
+    d->storage = s;
+}
+
+void LoadFeedListCommand::doStart() {
+    QTimer::singleShot( KRandom::random() % 400, this, SLOT(doLoad()) );
+}
+
+void LoadFeedListCommand::doAbort() {
+
+}
+
+void LoadFeedListCommand::Private::doLoad() {
+    assert( storage );
+    assert( !fileName.isNull() );
+    emit q->progress( 0, i18n("Opening Feed List...") );
+
+
+    QString str;
+
+    const QString listBackup = storage->restoreFeedList();
+
+    QDomDocument doc;
+
+    if ( !QFile::exists( fileName ) ) {
+        handleDocument( defaultFeedList );
+        return;
+    }
+
+    QFile file( fileName );
+
+    if ( !file.open( QIODevice::ReadOnly ) ) {
+        QPointer<QObject> that( q );
+        KMessageBox::error( q->parentWidget(), i18n( "<qt>Could not open feed list (%1) for reading.</p></qt>", file.fileName() ), i18n( "Read Error" ) );
+        if ( that )
+            handleDocument( defaultFeedList );
+        return;
+    }
+
+    QString errMsg;
+    int errLine = 0;
+    int errCol = 0;
+    if ( !doc.setContent( &file, true, &errMsg, &errLine, &errCol ) ) {
+        bool backupCreated = false;
+        const QString backupFile = createBackup( fileName, &backupCreated );
+        const QString title = i18nc( "error message window caption", "XML Parsing Error" );
+        const QString details = i18n( "<qt><p>XML parsing error in line %1, column %2 of %3:</p><p>%4</p></qt>",
+                                      QString::number( errLine ),
+                                      QString::number( errCol ),
+                                      fileName,
+                                      errMsg );
+        const QString msg = backupCreated
+            ? i18n( "<qt>The standard feed list is corrupted (invalid XML). A backup was created:<p><b>%1</b></p></qt>", backupFile )
+            : i18n( "<qt>The standard feed list is corrupted (invalid XML). Could not create a backup.</p></qt>" );
+
+        QPointer<QObject> that( q );
+
+        KMessageBox::detailedError( q->parentWidget(), msg, details, title );
+
+        if ( that )
+            emitResult( shared_ptr<FeedList>() );
+        return;
+    }
+
+    handleDocument( doc );
+}
+
+#include "loadfeedlistcommand.moc"
diff -Naur akregator-orig/src/loadfeedlistcommand.h akregator/src/loadfeedlistcommand.h
--- akregator-orig/src/loadfeedlistcommand.h	1970-01-01 02:00:00.000000000 +0200
+++ akregator/src/loadfeedlistcommand.h	2009-06-18 11:58:51.907746085 +0300
@@ -0,0 +1,50 @@
+/*
+ * loadfeedlistcommand.h
+ *
+ *  Created on: Dec 6, 2008
+ *      Author: frank
+ */
+
+#ifndef AKREGATOR_LOADFEEDLISTCOMMAND_H
+#define AKREGATOR_LOADFEEDLISTCOMMAND_H
+
+#include "command.h"
+
+#include <boost/shared_ptr.hpp>
+
+class QDomDocument;
+
+namespace Akregator {
+
+    namespace Backend {
+        class Storage;
+    }
+
+    class FeedList;
+
+    class LoadFeedListCommand : public Command {
+        Q_OBJECT
+    public:
+        explicit LoadFeedListCommand( QObject* parent = 0 );
+        ~LoadFeedListCommand();
+
+        void setFileName( const QString& fileName );
+        void setDefaultFeedList( const QDomDocument& doc );
+        void setStorage( Backend::Storage* storage );
+
+    Q_SIGNALS:
+        void result( const boost::shared_ptr<Akregator::FeedList>& feedList );
+
+    private:
+        void doStart();
+        void doAbort();
+
+    private:
+        class Private;
+        Private* const d;
+        Q_PRIVATE_SLOT( d, void doLoad() )
+    };
+
+}
+
+#endif // AKREGATOR_LOADFEEDLISTCOMMAND_H
diff -Naur akregator-orig/src/mainwidget.cpp akregator/src/mainwidget.cpp
--- akregator-orig/src/mainwidget.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/mainwidget.cpp	2009-06-18 11:58:51.904746253 +0300
@@ -38,6 +38,7 @@
 #include "deletesubscriptioncommand.h"
 #include "editsubscriptioncommand.h"
 #include "expireitemscommand.h"
+#include "importfeedlistcommand.h"
 #include "feed.h"
 #include "feedlist.h"
 #include "feedpropertiesdialog.h"
@@ -50,7 +51,7 @@
 #include "progressmanager.h"
 #include "searchbar.h"
 #include "selectioncontroller.h"
-//#include "speechclient.h"
+#include "speechclient.h"
 #include "subscriptionlistjobs.h"
 #include "subscriptionlistmodel.h"
 #include "subscriptionlistview.h"
@@ -87,6 +88,7 @@
 #include <memory>
 #include <cassert>
 
+using namespace boost;
 using namespace Akregator;
 using namespace Solid;
 
@@ -101,7 +103,7 @@
 
 Akregator::MainWidget::MainWidget( Part *part, QWidget *parent, ActionManagerImpl* actionManager, const char *name)
      : QWidget(parent),
-     m_feedList( 0 ),
+     m_feedList(),
      m_viewMode(NormalView),
      m_actionManager(actionManager),
      m_feedListManagementInterface( new FeedListManagementImpl )
@@ -134,10 +136,6 @@
     m_feedListView->setObjectName( "feedtree" );
     m_actionManager->initSubscriptionListView( m_feedListView );
 
-    
-    connect( m_feedListView, SIGNAL(userActionTakingPlace()),
-             this, SLOT(ensureArticleTabVisible()) );
-    
     connect(m_feedListView, SIGNAL(signalDropped (KUrl::List &, Akregator::TreeNode*,
             Akregator::Folder*)),
             this, SLOT(slotFeedUrlDropped (KUrl::List &,
@@ -189,9 +187,7 @@
     m_articleSplitter->setObjectName("panner2");
 
     m_articleListView = new ArticleListView( m_articleSplitter );
-    connect( m_articleListView, SIGNAL(UserActionTakingPlace()),
-             this, SLOT(ensureArticleTabVisible()) );
-    
+
     m_selectionController = new SelectionController( this );
     m_selectionController->setArticleLister( m_articleListView );
     m_selectionController->setFeedSelector( m_feedListView );
@@ -241,8 +237,8 @@
 
     mainTabLayout->addWidget( m_articleSplitter );
 
-    m_mainFrame = new MainFrame(this, m_part, m_mainTab, i18n("Articles"));
-
+    m_mainFrame = new MainFrame( this, m_part, m_mainTab );
+    m_mainFrame->slotSetTitle( i18n("Articles") );
     Kernel::self()->frameManager()->slotAddFrame(m_mainFrame);
 
     const QList<int> sp1sizes = Settings::splitter1Sizes();
@@ -277,7 +273,7 @@
     m_markReadTimer->setSingleShot(true);
     connect(m_markReadTimer, SIGNAL(timeout()), this, SLOT(slotSetCurrentArticleReadDelayed()) );
 
-    setFeedList( new FeedList( Kernel::self()->storage() ) );
+    setFeedList( shared_ptr<FeedList>( new FeedList( Kernel::self()->storage() ) ) );
 
     switch (Settings::viewMode())
     {
@@ -302,20 +298,20 @@
 {
     m_shuttingDown = true;
 
-    Kernel::self()->fetchQueue()->slotAbort();
+    // close all pageviewers in a controlled way
+    // fixes bug 91660, at least when no part loading data
+    while ( m_tabWidget->count() > 1 ) { // remove frames until only the main frame remains
+        m_tabWidget->setCurrentIndex( m_tabWidget->count() - 1 ); // select last page
+        m_tabWidget->slotRemoveCurrentFrame();
+    }
 
-    setFeedList( 0 );
+    Kernel::self()->fetchQueue()->slotAbort();
+    setFeedList( shared_ptr<FeedList>() );
 
     delete m_feedListManagementInterface;
     delete m_feedListView; // call delete here, so that the header settings will get saved
     delete m_articleListView; // same for this one
 
-    // close all pageviewers in a controlled way
-    // fixes bug 91660, at least when no part loading data
-    m_tabWidget->setCurrentIndex(m_tabWidget->count()-1); // select last page
-    while (m_tabWidget->count() > 1) // remove frames until only the main frame remains
-        m_tabWidget->slotRemoveCurrentFrame();
-
     delete m_mainTab;
     delete m_mainFrame;
 
@@ -393,80 +389,41 @@
     }
 }
 
-bool Akregator::MainWidget::importFeeds(const QDomDocument& doc)
+void MainWidget::importFeedList( const QDomDocument& doc )
 {
-    std::auto_ptr<FeedList> feedList( new FeedList( Kernel::self()->storage() ) );
-    const bool parsed = feedList->readFromOpml(doc);
-
-    // FIXME: parsing error, print some message
-    if (!parsed)
-        return false;
-
-    QString title = !feedList->title().isEmpty() ? feedList->title() : i18n("Imported Folder");
-
-    bool ok;
-    title = KInputDialog::getText( i18n("Add Imported Folder"),
-                                   i18n("Imported folder name:"),
-                                   title,
-                                   &ok,
-                                   this );
-
-    if (!ok)
-        return false;
-
-    Folder* fg = new Folder(title);
-    m_feedList->rootNode()->appendChild(fg);
-    m_feedList->append(feedList.get(), fg);
-
-    return true;
+    std::auto_ptr<ImportFeedListCommand> cmd( new ImportFeedListCommand );
+    cmd->setParentWidget( this );
+    cmd->setFeedListDocument( doc );
+    cmd->setTargetList( m_feedList );
+    cmd.release()->start();
 }
 
-void Akregator::MainWidget::setFeedList( FeedList* list )
+void Akregator::MainWidget::setFeedList( const shared_ptr<FeedList>& list )
 {
     if ( list == m_feedList )
         return;
-    FeedList* const oldList = m_feedList;
+    const shared_ptr<FeedList> oldList = m_feedList;
 
     m_feedList = list;
-    if ( m_feedList )
-    {
-        connect( m_feedList->rootNode(), SIGNAL( signalChanged( Akregator::TreeNode* ) ),
-                 this, SLOT( slotSetTotalUnread() ) );
-        slotSetTotalUnread();
+    if ( m_feedList ) {
+        connect( m_feedList.get(), SIGNAL(unreadCountChanged(int) ),
+                 this, SLOT(slotSetTotalUnread()) );
     }
 
+    slotSetTotalUnread();
+
     m_feedListManagementInterface->setFeedList( m_feedList );
-    Kernel::self()->setFeedList( m_feedList);
+    Kernel::self()->setFeedList( m_feedList );
     ProgressManager::self()->setFeedList( m_feedList );
     m_selectionController->setFeedList( m_feedList );
 
-    kDebug() << "new feed list is %p old one: %p" << m_feedList.data() << oldList;
-
-    if ( oldList ) {
+    if ( oldList )
         oldList->disconnect( this );
-        oldList->rootNode()->disconnect( this );
-    }
-    delete oldList;
-    slotDeleteExpiredArticles();
-}
-
-bool Akregator::MainWidget::loadFeeds(const QDomDocument& doc)
-{
-    assert( m_feedList );
-    std::auto_ptr<FeedList> feedList( new FeedList( Kernel::self()->storage() ) );
 
-    if ( !feedList->readFromOpml( doc ) )
-        return false;
-
-    m_feedListView->setUpdatesEnabled( false );
-    setFeedList( feedList.release() );
-    m_feedListView->setUpdatesEnabled( true );
-    m_feedListView->triggerUpdate();
-    return true;
+    slotDeleteExpiredArticles();
 }
 
-
-void Akregator::MainWidget::deleteExpiredArticles( FeedList* list )
+void Akregator::MainWidget::deleteExpiredArticles( const shared_ptr<FeedList>& list )
 {
     if ( !list )
         return;
@@ -502,7 +459,7 @@
     if (!group)
     {
         Folder* g = new Folder( groupName );
-        m_feedList->rootNode()->appendChild(g);
+        m_feedList->allFeedsFolder()->appendChild(g);
         group = g;
     }
 
@@ -568,11 +525,6 @@
     Settings::setViewMode( m_viewMode );
 }
 
-void Akregator::MainWidget::ensureArticleTabVisible()
-{
-    m_tabWidget->setCurrentWidget( m_mainFrame );
-}
-
 void Akregator::MainWidget::slotMoveCurrentNodeUp()
 {
     TreeNode* current = m_selectionController->selectedSubscription();
@@ -673,7 +625,7 @@
 {
     Folder* group = 0;
     if ( !m_selectionController->selectedSubscription() )
-        group = m_feedList->rootNode(); // all feeds
+        group = m_feedList->allFeedsFolder();
     else
     {
         if ( m_selectionController->selectedSubscription()->isGroup())
@@ -693,7 +645,7 @@
     CreateFeedCommand* cmd( new CreateFeedCommand( this ) );
     cmd->setParentWidget( this );
     cmd->setPosition( parent, after );
-    cmd->setRootFolder( m_feedList->rootNode() );
+    cmd->setRootFolder( m_feedList->allFeedsFolder() );
     cmd->setAutoExecute( autoExec );
     cmd->setUrl( url );
     cmd->setSubscriptionListView( m_feedListView );
@@ -705,7 +657,7 @@
     CreateFolderCommand* cmd = new CreateFolderCommand( this );
     cmd->setParentWidget( this );
     cmd->setSelectedSubscription( m_selectionController->selectedSubscription() );
-    cmd->setRootFolder( m_feedList->rootNode() );
+    cmd->setRootFolder( m_feedList->allFeedsFolder() );
     cmd->setSubscriptionListView( m_feedListView );
     cmd->start();
 }
@@ -715,7 +667,7 @@
     TreeNode* selectedNode = m_selectionController->selectedSubscription();
 
     // don't delete root element! (safety valve)
-    if (!selectedNode || selectedNode == m_feedList->rootNode())
+    if (!selectedNode || selectedNode == m_feedList->allFeedsFolder())
         return;
 
     DeleteSubscriptionCommand* cmd = new DeleteSubscriptionCommand( this );
@@ -738,7 +690,6 @@
 
 void Akregator::MainWidget::slotNextUnreadArticle()
 {
-    ensureArticleTabVisible();
     if (m_viewMode == CombinedView)
     {
         m_feedListView->slotNextUnreadFeed();
@@ -753,7 +704,6 @@
 
 void Akregator::MainWidget::slotPrevUnreadArticle()
 {
-    ensureArticleTabVisible();
     if (m_viewMode == CombinedView)
     {
         m_feedListView->slotPrevUnreadFeed();
@@ -768,7 +718,7 @@
 
 void Akregator::MainWidget::slotMarkAllFeedsRead()
 {
-    KJob* job = m_feedList->rootNode()->createMarkAsReadJob();
+    KJob* job = m_feedList->createMarkAsReadJob();
     connect(job, SIGNAL(finished(KJob*)), m_selectionController, SLOT(forceFilterUpdate()) );
     job->start();
 }
@@ -784,7 +734,7 @@
 
 void Akregator::MainWidget::slotSetTotalUnread()
 {
-    emit signalUnreadCountChanged( m_feedList ? m_feedList->rootNode()->unread() : 0 );
+    emit signalUnreadCountChanged( m_feedList ? m_feedList->unread() : 0 );
 }
 
 void Akregator::MainWidget::slotDoIntervalFetches()
@@ -794,7 +744,7 @@
     const Networking::Status status = Solid::Networking::status();
     if ( status != Networking::Connected && status != Networking::Unknown )
         return;
-    m_feedList->rootNode()->slotAddToFetchQueue(Kernel::self()->fetchQueue(), true);
+    m_feedList->addToFetchQueue(Kernel::self()->fetchQueue(), true);
 }
 
 void Akregator::MainWidget::slotFetchCurrentFeed()
@@ -806,7 +756,8 @@
 
 void Akregator::MainWidget::slotFetchAllFeeds()
 {
-    m_feedList->rootNode()->slotAddToFetchQueue(Kernel::self()->fetchQueue());
+    if ( m_feedList )
+        m_feedList->addToFetchQueue( Kernel::self()->fetchQueue() );
 }
 
 void Akregator::MainWidget::slotFetchingStarted()
@@ -1000,7 +951,7 @@
             msg = i18n("<qt>Are you sure you want to delete article <b>%1</b>?</qt>", Qt::escape(articles.first().title()));
             break;
         default:
-            msg = i18n("<qt>Are you sure you want to delete the %1 selected articles?</qt>", articles.count());
+            msg = i18np("<qt>Are you sure you want to delete the selected article?</qt>", "<qt>Are you sure you want to delete the %1 selected articles?</qt>", articles.count());
     }
 
     if ( KMessageBox::warningContinueCancel( this,
@@ -1088,10 +1039,7 @@
         if (m_viewMode != CombinedView)
         {
             // in non-combined view, read selected articles
-#ifdef __GNUC__
-#warning "kde4:readd speechclient";
-#endif
-            //SpeechClient::self()->slotSpeak(m_selectionController->selectedArticles());
+            SpeechClient::self()->slotSpeak(m_selectionController->selectedArticles());
             // TODO: if article viewer has a selection, read only the selected text?
         }
         else
@@ -1147,16 +1095,15 @@
     // Reopen tabs
     QStringList childList = config.readEntry( QString::fromLatin1( "Children" ),
         QStringList() );
-    foreach(QString framePrefix, childList)
+    Q_FOREACH( const QString& framePrefix, childList )
     {
-        BrowserFrame* frame = new BrowserFrame(m_tabWidget);
-        framePrefix.append( QLatin1Char( '_' ) );
-        frame->loadConfig( config, framePrefix );
+        BrowserFrame* const frame = new BrowserFrame(m_tabWidget);
+        frame->loadConfig( config, framePrefix + QLatin1Char( '_' ) );
 
         connect( m_part, SIGNAL(signalSettingsChanged()), frame, SLOT(slotPaletteOrFontChanged()));
 
         Kernel::self()->frameManager()->slotAddFrame(frame);
-        
+
     }
 }
 
diff -Naur akregator-orig/src/mainwidget.h akregator/src/mainwidget.h
--- akregator-orig/src/mainwidget.h	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/mainwidget.h	2009-06-18 11:58:51.902621085 +0300
@@ -36,6 +36,8 @@
 #include <QPointer>
 #include <QWidget>
 
+#include <boost/shared_ptr.hpp>
+
 class KConfig;
 class KFileItem;
 class K3ListView;
@@ -83,20 +85,15 @@
 
         /** Adds the feeds in @c doc to the "Imported Folder"
         @param doc the DOM tree (OPML) of the feeds to import */
-        bool importFeeds(const QDomDocument& doc);
-
-        /** Parse OPML presentation of feeds and read in articles archive, if present.
-         * The current feed list is replaced by the parsed one
-         *
-         * @param doc QDomDocument generated from OPML
-         **/
-        bool loadFeeds(const QDomDocument& doc);
+        void importFeedList( const QDomDocument& doc );
 
         /**
          * @return the displayed Feed List in OPML format
          */
         QDomDocument feedListToOPML();
 
+        void setFeedList( const boost::shared_ptr<FeedList>& feedList );
+
         /**
          * Add a feed to a group.
          * @param url The URL of the feed to add.
@@ -117,6 +114,7 @@
 
         ViewMode viewMode() const { return m_viewMode; }
 
+
     signals:
         /** emitted when the unread count of "All Feeds" was changed */
         void signalUnreadCountChanged(int);
@@ -138,8 +136,6 @@
         /** the article selection has changed */
         void slotArticleSelected(const Akregator::Article&);
 
-        void ensureArticleTabVisible();
-
         /** emits @ref signalUnreadCountChanged(int) */
         void slotSetTotalUnread();
 
@@ -233,11 +229,10 @@
         void slotFetchingStopped();
 
     private:
-        void deleteExpiredArticles( FeedList* feedList );
+        void deleteExpiredArticles( const boost::shared_ptr<FeedList>& feedList );
 
-        void setFeedList( FeedList* feedList );
         AbstractSelectionController* m_selectionController;
-        QPointer<FeedList> m_feedList;
+        boost::shared_ptr<FeedList> m_feedList;
 
         SubscriptionListView* m_feedListView;
         ArticleListView* m_articleListView;
diff -Naur akregator-orig/src/mainwindow.cpp akregator/src/mainwindow.cpp
--- akregator-orig/src/mainwindow.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/mainwindow.cpp	2009-06-18 11:58:51.903746150 +0300
@@ -44,6 +44,7 @@
 #include <KStandardAction>
 #include <KToolBar>
 #include <KStandardDirs>
+#include <KTemporaryFile>
 
 using namespace Akregator;
 
@@ -66,7 +67,6 @@
     // set the shell's ui resource file
     setXMLFile("akregator_shell.rc");
 
-    KStandardAction::configureNotifications(m_part, SLOT(showKNotifyOptions()), actionCollection()); // options_configure_notifications
     KStandardAction::keyBindings(this, SLOT(optionsConfigureKeys()), actionCollection()); // options_configure_keybinding
     KStandardAction::configureToolbars(this, SLOT(optionsConfigureToolbars()), actionCollection()); // options_configure_toolbars
 
@@ -94,7 +94,8 @@
     // this routine will find and load our Part.  it finds the Part by
     // name which is a bad idea usually.. but it's alright in this
     // case since our Part is made for this Shell
-    KPluginFactory *factory = KPluginLoader("akregatorpart").factory();
+    KPluginLoader loader("akregatorpart");
+    KPluginFactory* const factory = loader.factory();
     if (!factory) {
         KMessageBox::error(this, i18n("Could not find the Akregator part; please check your installation."));
         return false;
@@ -210,18 +211,21 @@
         return true;
     }
 
-#ifdef __GNUC__
-#warning takeScreenShot has to be reimplemented or removed
-#endif
-#if 0
-    QPixmap shot = TrayIcon::getInstance()->takeScreenshot();
-
-    // Associate source to image and show the dialog:
-    Q3MimeSourceFactory::defaultFactory()->setPixmap("systray_shot", shot);
-    KMessageBox::information(this, i18n( "<qt><p>Closing the main window will keep Akregator running in the system tray. Use 'Quit' from the 'File' menu to quit the application.</p><p><center><img source=\"systray_shot\" /></center></p></qt>" ), i18n( "Docking in System Tray" ), "hideOnCloseInfo");
-#endif
-    KMessageBox::information( this, i18n( "<qt><p>Closing the main window will keep Akregator running in the system tray. Use 'Quit' from the 'File' menu to quit the application.</p></qt>" ), i18n( "Docking in System Tray" ), "hideOnCloseInfo" );
-    hide();
+    const QPixmap shot = TrayIcon::getInstance()->takeScreenshot();
+    KTemporaryFile tmp;
+    QString tmpFileName;
+    if ( tmp.open() ) {
+        tmpFileName = tmp.fileName();
+        shot.save( &tmp, "PNG" );
+        tmp.close();
+    }
+
+    const QString imgTag = !tmpFileName.isEmpty() ? QString::fromLatin1( "<img src=\"%1\"/>" ).arg( tmpFileName ) : QString();
+
+    QPointer<QObject> that( this );
+    KMessageBox::information(this, i18n( "<qt><p>Closing the main window will keep Akregator running in the system tray. Use 'Quit' from the 'File' menu to quit the application.</p><p><center>%1</center></p></qt>", imgTag ), i18n( "Docking in System Tray" ), "hideOnCloseInfo");
+    if ( that )
+        hide();
     return false;
 }
 
diff -Naur akregator-orig/src/notificationmanager.cpp akregator/src/notificationmanager.cpp
--- akregator-orig/src/notificationmanager.cpp	2009-04-30 12:12:21.000000000 +0300
+++ akregator/src/notificationmanager.cpp	2009-06-18 11:58:51.907746085 +0300
@@ -22,6 +22,9 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include "notificationmanager.h"
+#include "feed.h"
+
 #include <klocale.h>
 #include <knotification.h>
 #include <k3staticdeleter.h>
@@ -31,8 +34,6 @@
 #include <QTimer>
 #include <QList>
 
-#include "feed.h"
-#include "notificationmanager.h"
 
 namespace Akregator {
 
diff -Naur akregator-orig/src/old/feeditem.cpp akregator/src/old/feeditem.cpp
--- akregator-orig/src/old/feeditem.cpp	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/old/feeditem.cpp	1970-01-01 02:00:00.000000000 +0200
@@ -1,103 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Frank Osterfeld <osterfeld@kde.org>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-
-#include "actionmanager.h"
-#include "feed.h"
-#include "feeditem.h"
-
-#include <kaction.h>
-#include <kdebug.h>
-#include <kiconloader.h>
-
-#include <QPixmap>
-
-#include <QMenu>
-
-namespace Akregator {
-
-FeedItem::FeedItem(FolderItem* parent, Feed* node) : TreeNodeItem(parent, node)
-{
-    initialize(node);
-}
-
-FeedItem::FeedItem(K3ListView* parent, Feed* node) : TreeNodeItem(parent, node)
-{
-    initialize(node);
-}
-
-FeedItem::FeedItem(K3ListView* parent, TreeNodeItem* after, Feed* node) : TreeNodeItem(parent, after, node)
-{
-    initialize(node);
-}
-
-
-FeedItem::FeedItem(FolderItem* parent, TreeNodeItem* after, Feed* node) : TreeNodeItem(parent, after, node)
-{
-    initialize(node);
-}
-
-FeedItem::~FeedItem()
-{
-}
-
-Feed* FeedItem::node() 
-{ 
-    return static_cast<Feed*> (m_node); 
-}
-
-void FeedItem::nodeChanged()
-{
-    //setPixmap( 0, node()->icon() );
-    TreeNodeItem::nodeChanged();
-}
-
-QPixmap FeedItem::errorPixmap()
-{
-    return KIconLoader::global()->loadIcon("error", KIconLoader::Small);
-}
-
-QPixmap FeedItem::defaultPixmap()
-{
-    return KIconLoader::global()->loadIcon("txt", KIconLoader::Small);
-}
-
-void FeedItem::initialize(Feed* node)
-{
-    setExpandable(false);
-    if (node)
-    {
-        setText(0, node->title());
-        //setPixmap( 0, node->icon() );
-    }
-}
-
-void FeedItem::showContextMenu(const QPoint& p)
-{
-    QWidget* w = ActionManager::getInstance()->container("feeds_popup");
-    if (w)
-        static_cast<QMenu *>(w)->exec(p);
-}
-
-} // namespace Akregator
-
diff -Naur akregator-orig/src/old/feeditem.h akregator/src/old/feeditem.h
--- akregator-orig/src/old/feeditem.h	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/old/feeditem.h	1970-01-01 02:00:00.000000000 +0200
@@ -1,65 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Frank Osterfeld <osterfeld@kde.org>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-
-#ifndef AKREGATOR_FEEDITEM_H
-#define AKREGATOR_FEEDITEM_H
-
-#include "treenodeitem.h"
-
-class QPixmap;
-
-namespace Akregator 
-{
-
-class Feed;
-class FolderItem;
-        
-/**
-* the item class corresponding to a Feed
-*/
-class FeedItem : public TreeNodeItem 
-{
- public:
-    
-    FeedItem(FolderItem* parent, Feed* node);
-    FeedItem(FolderItem* parent, TreeNodeItem* after, Feed* node);
-    FeedItem(K3ListView* parent, Feed* node);
-    FeedItem(K3ListView* parent, TreeNodeItem* after, Feed* node);
-
-    virtual ~FeedItem();
-    virtual Feed* node();
-    virtual void nodeChanged();
-    virtual void showContextMenu(const QPoint& p);
-
-    static QPixmap errorPixmap();
-    static QPixmap defaultPixmap();
-
-private:
-    void initialize(Feed* node);
-    
-};
-
-} // namespace Akregator
-
-#endif // AKREGATOR_FEEDITEM_H
diff -Naur akregator-orig/src/old/feedlistview.cpp akregator/src/old/feedlistview.cpp
--- akregator-orig/src/old/feedlistview.cpp	2008-01-15 03:57:29.000000000 +0200
+++ akregator/src/old/feedlistview.cpp	1970-01-01 02:00:00.000000000 +0200
@@ -1,950 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Stanislav Karchebny <Stanislav.Karchebny@kdemail.net>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-
-#include "folder.h"
-#include "folderitem.h"
-#include "feedlistview.h"
-#include "feed.h"
-#include "feeditem.h"
-#include "feedlist.h"
-#include "treenode.h"
-#include "treenodeitem.h"
-#include "treenodevisitor.h"
-
-#include <kdebug.h>
-#include <kiconeffect.h>
-#include <kiconloader.h>
-#include <klocale.h>
-#include <k3multipledrag.h>
-#include <kstringhandler.h>
-#include <k3urldrag.h>
-
-#include <QDragMoveEvent>
-#include <QDropEvent>
-#include <QHash>
-#include <QList>
-#include <QPainter>
-#include <QPixmap>
-#include <QTimer>
-
-namespace Akregator {
-
-class FeedListView::FeedListViewPrivate
-{
-    public:
-/** used for finding the item belonging to a node */
-    QHash<TreeNode*, TreeNodeItem*> itemDict;
-    FeedList* nodeList;
-
-    // Drag and Drop variables
-    Q3ListViewItem *parent;
-    Q3ListViewItem *afterme;
-    QTimer autoopentimer;
-    ConnectNodeVisitor* connectNodeVisitor;
-    DisconnectNodeVisitor* disconnectNodeVisitor;
-    CreateItemVisitor* createItemVisitor;
-    DeleteItemVisitor* deleteItemVisitor;
-};
-
-class FeedListView::ConnectNodeVisitor : public TreeNodeVisitor
-{
-    public:
-        ConnectNodeVisitor(FeedListView* view) : m_view(view) {}
-
-        virtual bool visitTreeNode(TreeNode* node)
-        {
-            connect(node, SIGNAL(signalDestroyed(Akregator::TreeNode*)), m_view, SLOT(slotNodeDestroyed(Akregator::TreeNode*) ));
-            connect(node, SIGNAL(signalChanged(Akregator::TreeNode*)), m_view, SLOT(slotNodeChanged(Akregator::TreeNode*) ));
-            return true;
-        }
-
-        virtual bool visitFolder(Folder* node)
-        {
-            visitTreeNode(node);
-            connect(node, SIGNAL(signalChildAdded(Akregator::TreeNode*)), m_view, SLOT(slotNodeAdded(Akregator::TreeNode*) ));
-            connect(node, SIGNAL(signalChildRemoved(Akregator::Folder*, Akregator::TreeNode*)), m_view, SLOT(slotNodeRemoved(Akregator::Folder*, Akregator::TreeNode*) ));
-            return true;
-        }
-        
-        virtual bool visitFeed(Feed* node)
-        {
-            visitTreeNode(node);
-            
-            connect(node, SIGNAL(fetchStarted(Akregator::Feed*)), m_view, SLOT(slotFeedFetchStarted(Akregator::Feed*)));
-            connect(node, SIGNAL(fetchAborted(Akregator::Feed*)), m_view, SLOT(slotFeedFetchAborted(Akregator::Feed*)));
-            connect(node, SIGNAL(fetchError(Akregator::Feed*)), m_view, SLOT(slotFeedFetchError(Akregator::Feed*)));
-            connect(node, SIGNAL(fetched(Akregator::Feed*)), m_view, SLOT(slotFeedFetchCompleted(Akregator::Feed*)));
-            return true;
-        }
-    private:
-
-        FeedListView* m_view;
-    
-};
-
-class FeedListView::DisconnectNodeVisitor : public TreeNodeVisitor
-{
-    public:
-        DisconnectNodeVisitor(FeedListView* view) : m_view(view) {}
-
-        virtual bool visitFolder(Folder* node)
-        {
-            disconnect(node, SIGNAL(signalChildAdded(Akregator::TreeNode*)), m_view, SLOT(slotNodeAdded(Akregator::TreeNode*) ));
-            disconnect(node, SIGNAL(signalChildRemoved(Akregator::Folder*, Akregator::TreeNode*)), m_view, SLOT(slotNodeRemoved(Akregator::Folder*, Akregator::TreeNode*) ));
-            
-            disconnect(node, SIGNAL(signalDestroyed(Akregator::TreeNode*)), m_view, SLOT(slotNodeDestroyed(Akregator::TreeNode*) ));
-            disconnect(node, SIGNAL(signalChanged(Akregator::TreeNode*)), m_view, SLOT(slotNodeChanged(Akregator::TreeNode*) ));
-            return true;
-        }
-        
-        virtual bool visitFeed(Feed* node)
-        {
-
-            disconnect(node, SIGNAL(signalDestroyed(Akregator::TreeNode*)), m_view, SLOT(slotNodeDestroyed(Akregator::TreeNode*) ));
-            disconnect(node, SIGNAL(signalChanged(Akregator::TreeNode*)), m_view, SLOT(slotNodeChanged(Akregator::TreeNode*) ));
-            disconnect(node, SIGNAL(fetchStarted(Akregator::Feed*)), m_view, SLOT(slotFeedFetchStarted(Akregator::Feed*)));
-            disconnect(node, SIGNAL(fetchAborted(Akregator::Feed*)), m_view, SLOT(slotFeedFetchAborted(Akregator::Feed*)));
-            disconnect(node, SIGNAL(fetchError(Akregator::Feed*)), m_view, SLOT(slotFeedFetchError(Akregator::Feed*)));
-            disconnect(node, SIGNAL(fetched(Akregator::Feed*)), m_view, SLOT(slotFeedFetchCompleted(Akregator::Feed*)));
-            return true;
-        }
-    private:
-
-        FeedListView* m_view;
-};
-
-class FeedListView::DeleteItemVisitor : public TreeNodeVisitor
-{
-    public:
-        
-        DeleteItemVisitor(FeedListView* view) : m_view(view) {}
-        
-        virtual bool visitTreeNode(TreeNode* node)
-        {
-            TreeNodeItem* item = m_view->d->itemDict.take(node);
-    
-            if (!item)
-                return true;
-    
-            if ( m_selectNeighbour && item->isSelected() )
-            {
-                if (item->itemBelow())
-                    m_view->setSelected(item->itemBelow(), true);
-                else if (item->itemAbove())
-                    m_view->setSelected(item->itemAbove(), true);
-                else
-                    m_view->setSelected(item, false);
-            }
-            
-            m_view->disconnectFromNode(node);
-            delete item;
-            return true;
-        
-        }
-        
-        virtual bool visitFolder(Folder* node)
-        {
-            // delete child items recursively before deleting parent
-            QList<TreeNode*> children = node->children();
-            for (QList<TreeNode*>::ConstIterator it =  children.begin(); it != children.end(); ++it )
-                visit(*it);
-            
-            visitTreeNode(node);
-            
-            return true;
-        }
-        
-        void deleteItem(TreeNode* node, bool selectNeighbour)
-        {
-            m_selectNeighbour = selectNeighbour;
-            visit(node);
-        }
-        
-    private:
-        FeedListView* m_view;
-        bool m_selectNeighbour;
-};
-
-
-class FeedListView::CreateItemVisitor : public TreeNodeVisitor
-{
-    public:
-        CreateItemVisitor(FeedListView* view) : m_view(view) {}
-
-        virtual bool visitFolder(Folder* node)
-        {
-            if (m_view->findNodeItem(node))
-                return true;
-
-            FolderItem* item = 0;
-            TreeNode* prev = node->prevSibling();
-            FolderItem* parentItem = static_cast<FolderItem*>(m_view->findNodeItem(node->parent()));
-            if (parentItem)
-            {
-                if (prev)
-                {
-                    item = new FolderItem( parentItem, m_view->findNodeItem(prev), node);
-                }
-                else
-                    item = new FolderItem(parentItem, node);
-            }
-            else
-            {
-                if (prev)
-                {
-                    item = new FolderItem(m_view, m_view->findNodeItem(prev), node);
-                }
-                else
-                    item = new FolderItem(m_view, node);
-            }
-            m_view->d->itemDict.insert(node, item);
-            QList<TreeNode*> children = node->children();
-
-            // add children recursively
-            for (QList<TreeNode*>::ConstIterator it =  children.begin(); it != children.end(); ++it )
-                visit(*it);
-
-            m_view->connectToNode(node);
-            return true;
-        }
-        
-        virtual bool visitFeed(Feed* node)
-        {
-            if (m_view->findNodeItem(node))
-                return true;
-
-            FeedItem* item = 0;
-            TreeNode* prev = node->prevSibling();
-            FolderItem* parentItem = static_cast<FolderItem*>(m_view->findNodeItem(node->parent()));
-            
-            if (parentItem)
-            {
-                if (prev)
-                {
-                    item = new FeedItem( parentItem, m_view->findNodeItem(prev), node);
-                }
-                else
-                    item = new FeedItem( parentItem, node);
-            }
-            else
-            {
-                if (prev)
-                {
-                    item = new FeedItem(m_view, m_view->findNodeItem(prev), node);
-                }
-                else
-                    item = new FeedItem(m_view, node);
-            }
-
-            item->nodeChanged();     
-            m_view->d->itemDict.insert(node, item);
-            m_view->connectToNode(node);
-            return true;
-        }
-        
-    private:
-        FeedListView* m_view;
-};
-
-FeedListView::FeedListView( QWidget *parent, const char *name)
-        : K3ListView(parent), d(new FeedListViewPrivate)
-{
-    setObjectName(name);
-    d->connectNodeVisitor = new ConnectNodeVisitor(this),
-    d->disconnectNodeVisitor = new DisconnectNodeVisitor(this);
-    d->createItemVisitor = new CreateItemVisitor(this);
-    d->deleteItemVisitor = new DeleteItemVisitor(this);
-    
-    setMinimumSize(150, 150);
-    addColumn(i18n("Feeds"));
-    setRootIsDecorated(false);
-    setItemsRenameable(false); // NOTE: setting this this to true collides with setRenameEnabled() in items and breaks in-place renaming in strange ways. Do not enable!
-    setItemMargin(2);
-
-    setFullWidth(true);
-    setSorting(-1);
-    setDragAutoScroll(true);
-    setDropVisualizer(true);
-    //setDropHighlighter(false);
-
-    setDragEnabled(true);
-    setAcceptDrops(true);
-    setItemsMovable(true);
-    
-    connect( this, SIGNAL(dropped(QDropEvent*, Q3ListViewItem*)), this, SLOT(slotDropped(QDropEvent*, Q3ListViewItem*)) );
-    connect( this, SIGNAL(selectionChanged(Q3ListViewItem*)), this, SLOT(slotSelectionChanged(Q3ListViewItem*)) );
-    connect( this, SIGNAL(itemRenamed(Q3ListViewItem*, int, const QString&)), this, SLOT(slotItemRenamed(Q3ListViewItem*, int, const QString&)) );
-    connect( this, SIGNAL(contextMenu(K3ListView*, Q3ListViewItem*, const QPoint&)), this, SLOT(slotContextMenu(K3ListView*, Q3ListViewItem*, const QPoint&)) );
-    connect( &(d->autoopentimer), SIGNAL( timeout() ), this, SLOT( openFolder() ) );
-
-    clear();
-    
-    this->setWhatsThis( i18n("<h2>Feeds tree</h2>"
-        "Here you can browse tree of feeds. "
-        "You can also add feeds or feed groups (folders) "
-        "using right-click menu, or reorganize them using "
-        "drag and drop."));
-    setUpdatesEnabled(true);
-}
-
-FeedListView::~FeedListView()
-{
-    delete d->connectNodeVisitor;
-    delete d->disconnectNodeVisitor;
-    delete d->createItemVisitor;
-    delete d->deleteItemVisitor;
-    delete d;
-    d = 0;
-}
-
-void FeedListView::setFeedList(FeedList* nodeList)
-{
-    if (nodeList == d->nodeList)
-         return;
-
-    clear();
-
-    disconnectFromFeedList(d->nodeList);
-    
-    if (!nodeList)
-        return;
-
-    d->nodeList = nodeList;
-    connectToFeedList(nodeList);
-  
-    
-    Folder* rootNode = nodeList->rootNode();
-    if (!rootNode)
-        return;
-
-    slotNodeAdded(rootNode);
-    slotRootNodeChanged(rootNode);
-}
-
-void FeedListView::takeNode(Q3ListViewItem* item)
-{
-    if (item->parent())
-        item->parent()->takeItem(item);
-    else
-        takeItem(item);
-}
-
-void FeedListView::insertNode(Q3ListViewItem* parent, Q3ListViewItem* item, Q3ListViewItem* after)
-{
-    if (parent)
-        parent->insertItem(item);
-    else
-        insertItem(item);
-    if (after)
-        item->moveItem(after);
-}
-
-Folder* FeedListView::rootNode()
-{
-    return d->nodeList ? d->nodeList->rootNode() : 0;
-}
-
-TreeNode* FeedListView::selectedNode()
-{
-    TreeNodeItem* item = dynamic_cast<TreeNodeItem*> (selectedItem());
-    
-    return ( item ? item->node() : 0) ;
-}
-
-void FeedListView::setSelectedNode(TreeNode* node)
-{
-    TreeNodeItem* item = findNodeItem(node);
-    if ( node && item )
-        setSelected(item, true);
-}
-
-TreeNode* FeedListView::findNodeByTitle(const QString& title)
-{
-    TreeNodeItem* item = dynamic_cast<TreeNodeItem*>(findItemByTitle(title, 0));
-    if (!item)
-        return 0;
-    else 
-        return item->node();
-}
-
-TreeNodeItem* FeedListView::findNodeItem(TreeNode* node)
-{
-    return d->itemDict[node];
-}
-
-TreeNodeItem* FeedListView::findItemByTitle(const QString& text, int column, ComparisonFlags compare) const
-{ 
-    return dynamic_cast<TreeNodeItem*> (K3ListView::findItem(text, column, compare)); 
-}
-
-void FeedListView::ensureNodeVisible(TreeNode* node)
-{
-    ensureItemVisible(findNodeItem(node));
-}
-
-void FeedListView::startNodeRenaming(TreeNode* node)
-{
-    TreeNodeItem* item = findNodeItem(node);
-    if (item)
-    {   
-        item->startRename(0);
-    }
-}
-
-void FeedListView::clear()
-{
-    foreach(TreeNode *node, d->itemDict.keys())
-        disconnectFromNode(node);
-    d->itemDict.clear();
-    d->nodeList = 0;
-    
-    K3ListView::clear();
-}
-
-void FeedListView::drawContentsOffset( QPainter * p, int ox, int oy,
-                                       int cx, int cy, int cw, int ch )
-{
-    bool oldUpdatesEnabled = updatesEnabled();
-    setUpdatesEnabled(false);
-    K3ListView::drawContentsOffset( p, ox, oy, cx, cy, cw, ch );
-    setUpdatesEnabled(oldUpdatesEnabled);
-}
-
-void FeedListView::slotDropped( QDropEvent *e, Q3ListViewItem*
-/*after*/)
-{
-	d->autoopentimer.stop();
-
-    if (e->source() != viewport())
-    {
-        openFolder();
-        const QMimeData *md = e->mimeData();
-        if (KUrl::List::canDecode(md))
-        {
-            FolderItem* parent = dynamic_cast<FolderItem*> (d->parent);
-            TreeNodeItem* afterMe = 0;
-
-            if(d->afterme)
-                afterMe = dynamic_cast<TreeNodeItem*> (d->afterme);
-        
-            KUrl::List urls = KUrl::List::fromMimeData( md );
-            e->accept();
-            emit signalDropped( urls, afterMe ? afterMe->node() : 0, parent ? parent->node() : 0);
-        }
-    }
-    else
-    {
-    }
-}
-
-void FeedListView::movableDropEvent(Q3ListViewItem* /*parent*/, Q3ListViewItem* /*afterme*/)
-{
-	d->autoopentimer.stop();
-    if (d->parent)
-    {    
-        openFolder();
-
-        Folder* parentNode = (dynamic_cast<FolderItem*> (d->parent))->node();
-        TreeNode* afterMeNode = 0; 
-        TreeNode* current = selectedNode();
-
-        if (d->afterme)
-            afterMeNode = (dynamic_cast<TreeNodeItem*> (d->afterme))->node();
-
-        current->parent()->removeChild(current);
-        parentNode->insertChild(current, afterMeNode);
-        K3ListView::movableDropEvent(d->parent, d->afterme);
-    }    
-}
-
-
-void FeedListView::contentsDragMoveEvent(QDragMoveEvent* event)
-{
-    QPoint vp = contentsToViewport(event->pos());
-    Q3ListViewItem *i = itemAt(vp);
-
-    Q3ListViewItem *qiparent;
-    Q3ListViewItem *qiafterme;
-    findDrop( event->pos(), qiparent, qiafterme );
-
-    if (event->source() == viewport()) {
-        // disable any drops where the result would be top level nodes 
-        if (i && !i->parent())
-        {
-            event->ignore();
-            d->autoopentimer.stop();
-            return;
-        }
-
-        // prevent dragging nodes from All Feeds to My Tags or vice versa
-        Q3ListViewItem* root1 = i;
-        while (root1 && root1->parent())
-            root1 = root1->parent();
-
-        Q3ListViewItem* root2 = selectedItem();
-        while (root2 && root2->parent())
-            root2 = root2->parent();
-
-        if (root1 != root2)
-        {
-            event->ignore();
-            d->autoopentimer.stop();
-            return;
-        }
-
-        // don't drop node into own subtree
-        Q3ListViewItem* p = qiparent;
-        while (p)
-            if (p == selectedItem())
-            {
-                event->ignore();
-                d->autoopentimer.stop();
-                return;
-            }
-            else
-            {
-                p = p->parent();
-            }
-
-        // disable drags onto the item itself
-        if (selectedItem() == i)
-        {
-            event->ignore();
-            d->autoopentimer.stop();
-            return;
-        }
-    }
-
-    // what the hell was this good for? -fo
-    //    if (!i || event->pos().x() > header()->cellPos(header()->mapToIndex(0)) +
-    //            treeStepSize() * (i->depth() + 1) + itemMargin() ||
-    //            event->pos().x() < header()->cellPos(header()->mapToIndex(0)))
-    //   {} else
- 
-    // do we want to move inside the old parent or do we want to move to a new parent
-    if (i && (itemAt(vp - QPoint(0,5)) == i && itemAt(vp + QPoint(0,5)) == i))
-    {
-        setDropVisualizer(false);
-        setDropHighlighter(true);
-        cleanDropVisualizer();
-
-        TreeNode *iNode = (dynamic_cast<TreeNodeItem*> (i))->node();
-        if (iNode->isGroup())
-        {
-            if (i != d->parent)
-                d->autoopentimer.start(750);
-
-            d->parent = i;
-            d->afterme = 0;
-        }
-        else
-        {
-            event->ignore();
-            d->autoopentimer.stop();
-            d->afterme = i;
-            return;
-        }
-    }
-    else
-    {
-        setDropVisualizer(true);
-        setDropHighlighter(false);
-        cleanItemHighlighter();
-        d->parent = qiparent;
-        d->afterme = qiafterme;
-        d->autoopentimer.stop();
-    }
-
-    // the rest is handled by K3ListView.
-    K3ListView::contentsDragMoveEvent(event);
-}
-
-bool FeedListView::acceptDrag(QDropEvent *e) const
-{
-    if (!acceptDrops() || !itemsMovable())
-        return false;
-
-    if (e->source() != viewport())
-    {
-        const QMimeData *md = e->mimeData();
-        return KUrl::List::canDecode(md);
-    }
-    else
-    {
-        // disable dragging of top-level nodes (All Feeds, My Tags)
-        if (selectedItem() && !selectedItem()->parent())
-            return false;
-        else
-            return true;
-    }
-
-    return true;
-}
-
-void FeedListView::slotItemUp()
-{
-    if (selectedItem() && selectedItem()->itemAbove())
-    {
-        setSelected( selectedItem()->itemAbove(), true );
-        ensureItemVisible(selectedItem());
-    }   
-}
-
-void FeedListView::slotItemDown()
-{
-    if (selectedItem() && selectedItem()->itemBelow())
-    {    
-        setSelected( selectedItem()->itemBelow(), true );
-        ensureItemVisible(selectedItem());
-    }
-}
-
-void FeedListView::slotItemBegin()
-{
-    setSelected( firstChild(), true );
-    ensureItemVisible(firstChild());
-}
-
-void FeedListView::slotItemEnd()
-{
-    Q3ListViewItem* elt = firstChild();
-    if (elt)
-        while (elt->itemBelow())
-            elt = elt->itemBelow();
-    setSelected( elt, true );
-    ensureItemVisible(elt);
-}
-
-void FeedListView::slotItemLeft()
-{
-    Q3ListViewItem* sel = selectedItem();
-    
-    if (!sel || sel == findNodeItem(rootNode()))
-        return;
-    
-    if (sel->isOpen())
-        sel->setOpen(false);
-    else
-    {
-        if (sel->parent())
-            setSelected( sel->parent(), true );
-    }
-        
-    ensureItemVisible( selectedItem() );    
-}
-
-void FeedListView::slotItemRight()
-{
-    Q3ListViewItem* sel = selectedItem();
-    if (!sel)
-    {
-        setSelected( firstChild(), true );
-        sel = firstChild();
-    }
-    if (sel->isExpandable() && !sel->isOpen())
-        sel->setOpen(true);
-    else
-    {
-        if (sel->firstChild())
-            setSelected( sel->firstChild(), true );
-    }
-    ensureItemVisible( selectedItem() );
-}
-
-void FeedListView::slotPrevFeed()
-{
-    for (Q3ListViewItemIterator it( selectedItem()); it.current(); --it )
-    {
-        TreeNodeItem* tni = dynamic_cast<TreeNodeItem*>(*it);
-        if (tni && !tni->isSelected() && !tni->node()->isGroup() )
-        {
-            setSelected(tni, true);
-            ensureItemVisible(tni);
-            return;
-        }     
-    }
-}
-    
-void FeedListView::slotNextFeed()
-{
-    for (Q3ListViewItemIterator it( selectedItem()); it.current(); ++it )
-    {
-        TreeNodeItem* tni = dynamic_cast<TreeNodeItem*>(*it);
-        if ( tni && !tni->isSelected() && !tni->node()->isGroup() )
-        {
-            setSelected(tni, true);
-            ensureItemVisible(tni);
-            return;
-        }     
-    }
-}
-
-void FeedListView::slotPrevUnreadFeed()
-{
-    if (!firstChild() || !firstChild()->firstChild())
-        return;
-    if ( !selectedItem() )
-        slotNextUnreadFeed(); 
-
-    Q3ListViewItemIterator it( selectedItem() );
-    
-    for ( ; it.current(); --it )
-    {
-        TreeNodeItem* tni = dynamic_cast<TreeNodeItem*> (it.current());
-        if (!tni)
-            break;
-        if ( !tni->isSelected() && !tni->node()->isGroup() && tni->node()->unread() > 0)
-        {
-            setSelected(tni, true);
-            ensureItemVisible(tni);
-            return;
-        }
-    }
-    // reached when there is no unread feed above the selected one
-    // => cycle: go to end of list...
-    if (rootNode()->unread() > 0)
-    {
-
-        it = Q3ListViewItemIterator(lastItem());
-    
-        for ( ; it.current(); --it)
-        {
-
-            TreeNodeItem* tni = dynamic_cast<TreeNodeItem*> (it.current());
-
-            if (!tni)
-                break;
-
-            if (!tni->isSelected() && !tni->node()->isGroup() && tni->node()->unread() > 0)
-            {
-                setSelected(tni, true);
-                ensureItemVisible(tni);
-                return;
-            }
-        }
-    }
-}
-
-void FeedListView::slotNextUnreadFeed()
-{
-    Q3ListViewItemIterator it;
-    
-    if ( !selectedItem() )
-    {
-        // if all feeds doesn't exists or is empty, return
-        if (!firstChild() || !firstChild()->firstChild())
-            return;    
-        else 
-            it = Q3ListViewItemIterator( firstChild()->firstChild());
-    }
-    else
-        it = Q3ListViewItemIterator( selectedItem() );
-    
-    for ( ; it.current(); ++it )
-    {
-        TreeNodeItem* tni = dynamic_cast<TreeNodeItem*> (it.current());
-        if (!tni)
-            break;
-        if ( !tni->isSelected() && !tni->node()->isGroup() && tni->node()->unread() > 0)
-        {
-            setSelected(tni, true);
-            ensureItemVisible(tni);
-            return;
-        }
-    }
-    // if reached, we are at the end of the list++
-    if (rootNode()->unread() > 0)
-    {
-        clearSelection();
-        slotNextUnreadFeed();
-    }
-}
-
-void FeedListView::slotSelectionChanged(Q3ListViewItem* item)
-{
- TreeNodeItem* ni = dynamic_cast<TreeNodeItem*> (item);
-    if (ni)
-        emit signalNodeSelected(ni->node());
-}
-
-void FeedListView::slotItemRenamed(Q3ListViewItem* item, int col, const QString& text)
-{
-    TreeNodeItem* ni = dynamic_cast<TreeNodeItem*> (item);
-    if ( !ni || !ni->node() )
-        return;
-    if (col == 0)
-    {
-        if (text != ni->node()->title())
-        {
-            kDebug() <<"renamed item to \"" << text <<"\"";
-            ni->node()->setTitle(text);
-        }
-    }
-}
-void FeedListView::slotContextMenu(K3ListView* list, Q3ListViewItem* item, const QPoint& p)
-{    
-    TreeNodeItem* ti = dynamic_cast<TreeNodeItem*>(item);
-    emit signalContextMenu(list, ti ? ti->node() : 0, p);
-    if (ti)
-        ti->showContextMenu(p);
-}
-
-void FeedListView::slotFeedFetchStarted(Feed* feed)
-{
-#if 0
-    // Disable icon to show it is fetching.
-    if (!feed->favicon().isNull())
-    {
-        TreeNodeItem* item = findNodeItem(feed);
-        KIconEffect iconEffect;
-        QPixmap tempIcon = iconEffect.apply(feed->favicon(), KIconLoader::Small, KIconLoader::DisabledState);
-        item->setPixmap(0, tempIcon);
-    }
-#endif
-}
-
-void FeedListView::slotFeedFetchAborted(Feed* feed)
-{
-    TreeNodeItem* item = findNodeItem(feed);
-    if (item)
-        item->nodeChanged();
-}
-
-void FeedListView::slotFeedFetchError(Feed* feed)
-{
-    TreeNodeItem* item = findNodeItem(feed);
-    if (item)
-        item->nodeChanged();
-}
-
-void FeedListView::slotFeedFetchCompleted(Feed* feed)
-{
-    TreeNodeItem* item = findNodeItem(feed);
-    if (item)
-        item->nodeChanged();
-}
-      
-void FeedListView::slotNodeAdded(TreeNode* node)
-{
-    if (node)
-        d->createItemVisitor->visit(node);
-}
-
-void FeedListView::slotNodeRemoved(Folder* /*parent*/, TreeNode* node)
-{
-    if (node)
-        d->deleteItemVisitor->deleteItem(node, false); 
-}
-
-void FeedListView::connectToNode(TreeNode* node)
-{
-    if (node)
-        d->connectNodeVisitor->visit(node);
-}
-
-void FeedListView::connectToFeedList(FeedList* list)
-{
-    if (!list)
-        return;
-    
-    connect(list, SIGNAL(signalDestroyed(Akregator::FeedList*)), this, SLOT(slotFeedListDestroyed(Akregator::FeedList*)) );
-    connect(list->rootNode(), SIGNAL(signalChanged(Akregator::TreeNode*)), this, SLOT(slotRootNodeChanged(Akregator::TreeNode*)));
-}
-
-void FeedListView::disconnectFromFeedList(FeedList* list)
-{
-    if (!list)
-        return;
-    
-    disconnect(list, SIGNAL(signalDestroyed(Akregator::FeedList*)), this, SLOT(slotFeedListDestroyed(Akregator::FeedList*)) );
-    disconnect(list->rootNode(), SIGNAL(signalChanged(Akregator::TreeNode*)), this, SLOT(slotRootNodeChanged(Akregator::TreeNode*)));
-}
-
-void FeedListView::disconnectFromNode(TreeNode* node)
-{
-    if (node)
-        d->disconnectNodeVisitor->visit(node);
-}
-
-void FeedListView::slotFeedListDestroyed(FeedList* list)
-{
-    if (list != d->nodeList)
-        return;
-
-    setFeedList(0);
-}
-
-void FeedListView::slotNodeDestroyed(TreeNode* node)
-{
-    if (node)
-        d->deleteItemVisitor->deleteItem(node, true);
-}
-
-void FeedListView::slotRootNodeChanged(TreeNode* rootNode)
-{
-    emit signalRootNodeChanged(this, rootNode);
-}
-
-void FeedListView::slotNodeChanged(TreeNode* node)
-{
-    TreeNodeItem* item = findNodeItem(node);
-    if (item)
-    {    
-        item->nodeChanged();
-        triggerUpdate();
-    }    
-}
-
-#ifdef __GNUC__
-#warning Port to new drag'n'drop way of using QMimeData and QDrop instead of drop objects
-#endif
-Q3DragObject *FeedListView::dragObject()
-{
-    K3MultipleDrag *md = new K3MultipleDrag(viewport());
-    Q3DragObject *obj = K3ListView::dragObject();
-    if (obj) {
-        md->addDragObject(obj);
-    }
-    TreeNodeItem *i = dynamic_cast<TreeNodeItem*>(currentItem());
-    if (i) {
-        md->setPixmap(*(i->pixmap(0)));
-        FeedItem *fi = dynamic_cast<FeedItem*>(i);
-        if (fi) {
-            md->addDragObject(new K3URLDrag(KUrl(fi->node()->xmlUrl()), 0L));
-        }
-    }
-    return md;
-}
-
-void FeedListView::openFolder() {
-    d->autoopentimer.stop();
-    if (d->parent && !d->parent->isOpen())
-    {
-        d->parent->setOpen(true);
-    }
-}
-
-} // namespace Akregator
-
-#include "feedlistview.moc"
diff -Naur akregator-orig/src/old/feedlistview.h akregator/src/old/feedlistview.h
--- akregator-orig/src/old/feedlistview.h	2008-01-15 03:57:29.000000000 +0200
+++ akregator/src/old/feedlistview.h	1970-01-01 02:00:00.000000000 +0200
@@ -1,191 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Stanislav Karchebny <Stanislav.Karchebny@kdemail.net>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-#ifndef AKREGATOR_FEEDLISTVIEW_H
-#define AKREGATOR_FEEDLISTVIEW_H
-
-#include <k3listview.h>
-#include <kurl.h>
-//Added by qt3to4:
-#include <QDragMoveEvent>
-#include <QDropEvent>
-
-namespace Akregator
-{
-class Feed;
-class Folder;
-class FeedList;
-class TreeNode;
-class TreeNodeItem;
-
-class FeedListView : public K3ListView
-{
-Q_OBJECT
-public:
-    explicit FeedListView( QWidget *parent = 0, const char *name = 0 );
-    virtual ~FeedListView();
-
-    /** sets the feed list to show. Disconnects from the old feed list, if there is any. */
-    void setFeedList(FeedList* nodeList);
-
-    /** Returns root node ("All Feeds").
-        * @return root node
-        */
-    Folder* rootNode();
-
-    /** Returns the currently selected node, @c null when no one is selected.
-        @return selected node
-        */
-    TreeNode* selectedNode();
-
-    /** selects @c node, if it exists
-        * @param node the node to select
-        */
-    void setSelectedNode(TreeNode* node);
-
-    /** Find first node with title @c title
-        returns 0 if no node was found
-    @param title
-    @return node
-        */
-    TreeNode* findNodeByTitle(const QString& title);
-
-    /** ensures that @c node is visible. */
-    void ensureNodeVisible(TreeNode* node);
-
-    /** activates in-place renaming for the item of @c node */
-    void startNodeRenaming(TreeNode* node);
-
-
-    /** reimplemented: clears the view and creates the root node ("All Feeds") */
-    virtual void clear();
-
-public slots:
-
-    /** go one item up */
-    void slotItemUp();
-    /** go one item down */
-    void slotItemDown();
-    /** select the first item in the list */
-    void slotItemBegin();
-    /** select last item in the list */
-    void slotItemEnd();
-    /** go to parent item */
-    void slotItemLeft();
-    /** go to first child */
-    void slotItemRight();
-
-    void slotPrevFeed();
-    void slotNextFeed();
-    void slotPrevUnreadFeed();
-    void slotNextUnreadFeed();
-
-signals:
-    void signalDropped(KUrl::List &, Akregator::TreeNode*, Akregator::Folder*);
-    void signalNodeSelected(Akregator::TreeNode*);
-    void signalRootNodeChanged(Akregator::FeedListView*, Akregator::TreeNode*);
-    void signalContextMenu(K3ListView*, Akregator::TreeNode*, const QPoint&);
-
-protected:
-
-    /** Find item belonging to tree node @c node, @c null when node is not in tree
-    @return item representing node
-    @param node a tree node */
-
-    TreeNodeItem* findNodeItem(TreeNode* node);
-
-    /** reimplemented to return TreeNodeItem* */
-    virtual TreeNodeItem* findItemByTitle(const QString& text, int column, ComparisonFlags compare = ExactMatch | Qt::CaseSensitive ) const;
-
-    /** observe @c node: connect status change signals of @c node to slots */
-    virtual void connectToNode(TreeNode* node);
-
-    /** stop observing @c node: disconnect from status change signals of @c node */
-    virtual void disconnectFromNode(TreeNode* node);
-
-    virtual void connectToFeedList(FeedList* list);
-    virtual void disconnectFromFeedList(FeedList* list);
-
-    virtual void drawContentsOffset( QPainter * p, int ox, int oy,
-                                        int cx, int cy, int cw, int ch );
-    virtual void contentsDragMoveEvent(QDragMoveEvent* event);
-    virtual bool acceptDrag(QDropEvent *event) const;
-    virtual void movableDropEvent(Q3ListViewItem* parent, Q3ListViewItem* afterme);
-
-    void takeNode(Q3ListViewItem* item);
-    void insertNode(Q3ListViewItem* parent, Q3ListViewItem* item, Q3ListViewItem* after);
-
-    virtual Q3DragObject *dragObject();
-
-
-protected slots:
-
-
-    void slotDropped(QDropEvent *e, Q3ListViewItem* after);
-    void slotRootNodeChanged(Akregator::TreeNode*);
-    virtual void slotSelectionChanged(Q3ListViewItem* item);
-    virtual void slotContextMenu(K3ListView* list, Q3ListViewItem* item, const QPoint& p);
-    virtual void slotItemRenamed(Q3ListViewItem* item, int col, const QString& text);
-    virtual void slotFeedFetchStarted(Akregator::Feed* feed);
-    virtual void slotFeedFetchAborted(Akregator::Feed* feed);
-    virtual void slotFeedFetchError(Akregator::Feed* feed);
-    virtual void slotFeedFetchCompleted(Akregator::Feed* feed);
-    void openFolder();
-
-    /** called when a node is added to the tree. If no item for the node exists, it will be created */
-    virtual void slotNodeAdded(Akregator::TreeNode* node);
-
-    /** Called when a node in the tree is taken out of the tree (parent->removeChild())
-
-    Removes a node and its children from the tree. Note that it doesn't delete the corresponding view items (get deleted only when the node itself gets deleted) */
-    virtual void slotNodeRemoved(Akregator::Folder* parent, Akregator::TreeNode* node);
-
-    /** deletes the item belonging to the deleted node */
-    virtual void slotNodeDestroyed(Akregator::TreeNode* node);
-
-    /** update the item belonging to the node */
-    virtual void slotNodeChanged(Akregator::TreeNode* node);
-
-    virtual void slotFeedListDestroyed(Akregator::FeedList*);
-
-private:
-    friend class ConnectNodeVisitor;
-    class ConnectNodeVisitor;
-
-    friend class DisconnectNodeVisitor;
-    class DisconnectNodeVisitor;
-
-    friend class CreateItemVisitor;
-    class CreateItemVisitor;
-
-    friend class DeleteItemVisitor;
-    class DeleteItemVisitor;
-    
-    class FeedListViewPrivate;
-    FeedListViewPrivate* d;
-};
-
-
-} // namespace Akregator
-
-#endif // AKREGATOR_FEEDLISTVIEW_H
diff -Naur akregator-orig/src/old/folderitem.cpp akregator/src/old/folderitem.cpp
--- akregator-orig/src/old/folderitem.cpp	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/old/folderitem.cpp	1970-01-01 02:00:00.000000000 +0200
@@ -1,86 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Frank Osterfeld <osterfeld@kde.org>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-
-#include "actionmanager.h"
-#include "folder.h"
-#include "folderitem.h"
-#include "treenode.h"
-
-#include <QMenu>
-#include <kaction.h>
-#include <kiconloader.h>
-
-namespace Akregator {
-
-FolderItem::FolderItem(FolderItem* parent, Folder* node) : TreeNodeItem(parent, node)
-{
-    initialize(node);
-}
-
-FolderItem::FolderItem(FolderItem* parent, TreeNodeItem* after, Folder* node) : TreeNodeItem(parent, after, node)
-{
-    initialize(node);
-}
-
-FolderItem::FolderItem(K3ListView* parent, Folder* node) : TreeNodeItem(parent, node)
-{
-    initialize(node);
-}
-
-FolderItem::FolderItem(K3ListView* parent, TreeNodeItem* after, Folder* node) : TreeNodeItem(parent, after, node)
-{
-    initialize(node);
-}
-
-void FolderItem::initialize(Folder* node)
-{
-    setOpen(node && node->isOpen());
-    setPixmap ( 0, KIconLoader::global()->loadIcon("folder", KIconLoader::Small) );
-    if (node)
-        setText(0, node->title());
-}
-
-Folder* FolderItem::node() 
-{ 
-    return static_cast<Folder*> (m_node); 
-}
-
-void FolderItem::setOpen(bool open)
-{
-    node()->setOpen(open);
-    K3ListViewItem::setOpen(open);
-}
-
-FolderItem::~FolderItem()
-{}
-
-
-void FolderItem::showContextMenu(const QPoint& p)
-{
-    QWidget* w = ActionManager::getInstance()->container("feedgroup_popup");
-    if (w)
-        static_cast<QMenu *>(w)->exec(p);
-}
-
-} // namespace Akregator
diff -Naur akregator-orig/src/old/folderitem.h akregator/src/old/folderitem.h
--- akregator-orig/src/old/folderitem.h	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/old/folderitem.h	1970-01-01 02:00:00.000000000 +0200
@@ -1,59 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Frank Osterfeld <osterfeld@kde.org>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-#ifndef AKREGATOR_FOLDERITEM_H
-#define AKREGATOR_FOLDERITEM_H
-
-#include "folder.h"
-#include "treenode.h"
-#include "treenodeitem.h"
-
-class QPoint;
-
-namespace Akregator 
-{
-
-class Folder;
-
-class FolderItem : public TreeNodeItem
-{
-
-public:
-    FolderItem(FolderItem* parent, Folder* node);
-    FolderItem(FolderItem* parent, TreeNodeItem* after, Folder* node);
-    FolderItem(K3ListView* parent, Folder* node);
-    FolderItem(K3ListView* parent, TreeNodeItem* after, Folder* node);
-    virtual ~FolderItem();
-    
-    virtual Folder* node();
-    
-    virtual void setOpen(bool open);
-    virtual void showContextMenu(const QPoint& p);
-
-private:
-    void initialize(Folder* node);
-};
-
-} // namespace Akregator
-
-#endif // AKREGATOR_FOLDERITEM_H
diff -Naur akregator-orig/src/old/treenodeitem.cpp akregator/src/old/treenodeitem.cpp
--- akregator-orig/src/old/treenodeitem.cpp	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/old/treenodeitem.cpp	1970-01-01 02:00:00.000000000 +0200
@@ -1,165 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Frank Osterfeld <osterfeld@kde.org>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-
-#include "folderitem.h"
-#include "treenode.h"
-#include "treenodeitem.h"
-
-#include <kdebug.h>
-
-#include <QFont>
-#include <QPainter>
-#include <QPixmap>
-#include <QString>
-
-
-namespace Akregator {
-
-TreeNodeItem::TreeNodeItem(FolderItem* parent, TreeNode* node)
-    : K3ListViewItem(parent), m_node(node)
-{
-    initialize(node);
-}
-
-TreeNodeItem::TreeNodeItem(K3ListView* parent, TreeNode* node)
-    : K3ListViewItem(parent), m_node(node)
-{
-    initialize(node);
-}
-
-TreeNodeItem::TreeNodeItem(K3ListView* parent, TreeNodeItem* after, TreeNode* node) : K3ListViewItem(parent, after), m_node(node)
-{
-    initialize(node);
-}
-
-TreeNodeItem::TreeNodeItem(FolderItem* parent, TreeNodeItem* after, TreeNode* node)
-    : K3ListViewItem(parent, after), m_node(node)
-{
-    initialize(node);
-}
-
-void TreeNodeItem::initialize(TreeNode* node)
-{
-    setRenameEnabled(0, true);
-    if (node)
-        setText(0, node->title() );
-}
-
-TreeNodeItem::~TreeNodeItem()
-{}
-
-QString TreeNodeItem::toolTip() const
-{
-    return QString();
-}
-
-TreeNode* TreeNodeItem::node()
-{
-    return m_node;
-}
-
-void TreeNodeItem::nodeChanged()
-{
-//    kDebug() <<"enter TreeNodeItem::nodeChanged item" << text(0);
-    if (!node())
-        return;
-    if (text(0) != node()->title())
-        setText(0, node()->title());
-//    kDebug() <<"leave TreeNodeItem::nodeChanged item" << text(0);
-}
-
-TreeNodeItem* TreeNodeItem::firstChild() const
-{
-    return static_cast<TreeNodeItem*>(K3ListViewItem::firstChild());
-}
-
-TreeNodeItem* TreeNodeItem::nextSibling() const
-{
-    return static_cast<TreeNodeItem*>(K3ListViewItem::nextSibling());
-}
-
-FolderItem* TreeNodeItem::parent() const
-{
-    return static_cast<FolderItem*>(K3ListViewItem::parent());
-}
-
-
-// TODO: reverse for reverse layout
-void TreeNodeItem::paintCell( QPainter * p, const QColorGroup & cg,
-                               int column, int width, int align )
-
-{
-    int u = node() ? node()->unread() : 0;
-
-    if (u <= 0)
-    {
-        K3ListViewItem::paintCell(p,cg,column,width,align);
-        return;
-    }
-
-    // from kfoldertree
-    QString oldText = text(column);
-    setText( column, " " );
-
-    // draw bg
-    K3ListViewItem::paintCell(p,cg,column,width,align);
-
-    setText( column, oldText);
-
-    // draw fg
-    QFont f = p->font();
-    f.setWeight(QFont::Bold);
-    p->setFont(f);
-
-    QFontMetrics fm( p->fontMetrics() );
-    Q3ListView *lv = listView();
-    int x = lv ? lv->itemMargin() : 1;
-    int m=x;
-    const QPixmap *icon = pixmap( column );
-    QRect br;
-
-    if (icon)
-        x += icon->width() + m;
-
-    QString txt = " (" + QString::number(u) + ')';
-    int txtW=fm.width( txt );
-
-    if (fm.width( oldText ) + txtW + x > width)
-        oldText = fm.elidedText(oldText, Qt::ElideRight, width - txtW - x);
-
-    p->drawText( x, 0, width-m-x, height(), align | Qt::AlignVCenter, oldText, &br );
-
-    if ( !isSelected() )
-        p->setPen( Qt::blue ); // TODO: configurable
-
-    p->drawText( br.right(), 0, width-m-br.right(), height(),
-                 align | Qt::AlignVCenter, txt );
-
-    /*if ( isSelected() )
-    p->setPen( cg.highlightedText() );
-    else
-    p->setPen( cg.text() );*/
-}
-
-} // namespace Akregator
diff -Naur akregator-orig/src/old/treenodeitem.h akregator/src/old/treenodeitem.h
--- akregator-orig/src/old/treenodeitem.h	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/old/treenodeitem.h	1970-01-01 02:00:00.000000000 +0200
@@ -1,75 +0,0 @@
-/*
-    This file is part of Akregator.
-
-    Copyright (C) 2004 Frank Osterfeld <osterfeld@kde.org>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-
-#ifndef AKREGATOR_TREENODEITEM_H
-#define AKREGATOR_TREENODEITEM_H
-
-#include <k3listview.h>
-
-class QPoint;
-class QString;
-
-namespace Akregator {
-
-class FolderItem;
-class TreeNode;
-
-/**
-    abstract base class for all items in the feeds tree
-*/
-class TreeNodeItem : public K3ListViewItem
-{
-    
-public:
-     
-    TreeNodeItem(FolderItem* parent, TreeNode* node);
-    TreeNodeItem(FolderItem* parent, TreeNodeItem* after, TreeNode* node);
-    TreeNodeItem(K3ListView* parent, TreeNode* node);
-    TreeNodeItem(K3ListView* parent, TreeNodeItem* after, TreeNode* node);
-    virtual ~TreeNodeItem();
-    virtual TreeNode* node();
-    
-    virtual void nodeChanged();
-
-    virtual QString toolTip() const;
-    virtual TreeNodeItem* firstChild() const;
-    virtual TreeNodeItem* nextSibling() const;
-    virtual FolderItem* parent() const;
-
-    virtual void showContextMenu(const QPoint& p) = 0;
-
-    protected:
-    
-    TreeNode* m_node;
-    
-    virtual void paintCell( QPainter * p, const QColorGroup & cg, int column, int width, int align );
-
-    private:
-
-    void initialize(TreeNode* node);
-};
-
-} // namespace Akregator
-
-#endif // AKREGATOR_TREENODEITEM_H
diff -Naur akregator-orig/src/pageviewer.cpp akregator/src/pageviewer.cpp
--- akregator-orig/src/pageviewer.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/pageviewer.cpp	2009-06-18 11:58:51.905745944 +0300
@@ -24,9 +24,9 @@
 */
 
 #include "akregatorconfig.h"
+#include "pageviewer.h"
 #include "browserrun.h"
 #include "feediconmanager.h"
-#include "pageviewer.h"
 #include "viewer.h"
 
 #include <kaction.h>
diff -Naur akregator-orig/src/pluginmanager.cpp akregator/src/pluginmanager.cpp
--- akregator-orig/src/pluginmanager.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/pluginmanager.cpp	2009-06-18 11:58:51.905745944 +0300
@@ -13,8 +13,8 @@
  *                                                                         *
  ***************************************************************************/
 
-#include "plugin.h"
 #include "pluginmanager.h"
+#include "plugin.h"
 
 #include <vector>
 #include <QFile>
@@ -83,32 +83,18 @@
 {
     kDebug() <<"Trying to load:" << service->library();
 
-    //get the library loader instance
-    KLibLoader *loader = KLibLoader::self();
-    //try to load the specified library
-    KLibrary *lib = loader->library( QFile::encodeName( service->library() ), QLibrary::ExportExternalSymbolsHint );
-
-    if ( !lib ) {
-        KMessageBox::error( 0, i18n( "<p>KLibLoader could not load the plugin:<br/><i>%1</i></p>"
-                                     "<p>Error message:<br/><i>%2</i></p>" ,
-                                 service->library() ,
-                                 loader->lastErrorMessage() ) );
+    KPluginLoader loader( *service );
+    KPluginFactory* factory = loader.factory();
+    if ( !factory ) {
+        kWarning() << QString( " Could not create plugin factory for: %1\n"
+                                " Error message: %2" ).arg( service->library(), loader.errorString() );
         return 0;
     }
-    //look up address of init function and cast it to pointer-to-function
-    Plugin* (*create_plugin)() = ( Plugin* (*)() ) lib->resolveFunction( "create_plugin" );
-
-    if ( !create_plugin ) {
-        kWarning() <<"create_plugin == NULL";
-        return 0;
-    }
-    //create plugin on the heap
-    Plugin* plugin = create_plugin();
+    Plugin* const plugin = factory->create<Plugin>();
 
     //put plugin into store
     StoreItem item;
     item.plugin = plugin;
-    item.library = lib;
     item.service = service;
     m_store.push_back( item );
 
@@ -120,17 +106,25 @@
 void
 PluginManager::unload( Plugin* plugin )
 {
+#ifdef TEMPORARILY_REMOVED
     vector<StoreItem>::iterator iter = lookupPlugin( plugin );
 
     if ( iter != m_store.end() ) {
         delete (*iter).plugin;
         kDebug() <<"Unloading library:"<< (*iter).service->library();
+        //PENDING(kdab,frank) Review
         (*iter).library->unload();
 
+
         m_store.erase( iter );
     }
     else
         kWarning() <<"Could not unload plugin (not found in store).";
+#else //TEMPORARILY_REMOVED
+    Q_UNUSED( plugin )
+    kWarning() <<"PluginManager::unload temporarily disabled";
+#endif //TEMPORARILY_REMOVED
+
 }
 
 
diff -Naur akregator-orig/src/pluginmanager.h akregator/src/pluginmanager.h
--- akregator-orig/src/pluginmanager.h	2008-05-21 11:33:37.000000000 +0300
+++ akregator/src/pluginmanager.h	2009-06-18 11:58:51.899620796 +0300
@@ -100,7 +100,6 @@
     private:
         struct StoreItem {
             Akregator::Plugin* plugin;
-            KLibrary* library;
             KService::Ptr service;
         };
 
diff -Naur akregator-orig/src/progressmanager.cpp akregator/src/progressmanager.cpp
--- akregator-orig/src/progressmanager.cpp	2008-03-06 11:52:45.000000000 +0200
+++ akregator/src/progressmanager.cpp	2009-06-18 11:58:51.898620837 +0300
@@ -22,6 +22,10 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include "progressmanager.h"
+#include "feed.h"
+#include "treenode.h"
+
 #include <QHash>
 #include <QList>
 
@@ -30,23 +34,17 @@
 
 #include <libkdepim/progressmanager.h>
 
-#include "feedlist.h"
-#include "feed.h"
-#include "treenode.h"
-
-#include "progressmanager.h"
-
-//#include <kdebug.h>
+using namespace boost;
 
 namespace Akregator {
 
 class ProgressManager::ProgressManagerPrivate
 {
     public:
-        ProgressManagerPrivate() : feedList( 0 ) {}
-        FeedList* feedList;
+        ProgressManagerPrivate() : feedList() {}
+        shared_ptr<FeedList> feedList;
         QHash<Feed*, ProgressItemHandler*> handlers;
-    
+
 };
 
 static K3StaticDeleter<ProgressManager> progressmanagersd;
@@ -65,11 +63,11 @@
 
 ProgressManager::~ProgressManager()
 {
-    delete d; 
+    delete d;
     d = 0;
 }
 
-void ProgressManager::setFeedList(FeedList* feedList)
+void ProgressManager::setFeedList(const shared_ptr<FeedList>& feedList)
 {
     if ( feedList == d->feedList )
         return;
@@ -82,27 +80,27 @@
     }
 
     d->feedList = feedList;
-    
+
     if ( d->feedList )
     {
         QVector<Feed*> list = feedList->feeds();
-    
+
         foreach( TreeNode* i, list )
             slotNodeAdded( i );
-        connect(feedList, SIGNAL(signalNodeAdded(Akregator::TreeNode*)), this, SLOT(slotNodeAdded(Akregator::TreeNode*)));
-        connect(feedList, SIGNAL(signalNodeRemoved(Akregator::TreeNode*)), this, SLOT(slotNodeRemoved(Akregator::TreeNode*)));
+        connect(feedList.get(), SIGNAL(signalNodeAdded(Akregator::TreeNode*)), this, SLOT(slotNodeAdded(Akregator::TreeNode*)));
+        connect(feedList.get(), SIGNAL(signalNodeRemoved(Akregator::TreeNode*)), this, SLOT(slotNodeRemoved(Akregator::TreeNode*)));
     }
 }
-     
+
 void ProgressManager::slotNodeAdded(TreeNode* node)
 {
     Feed* const feed = qobject_cast<Feed*>(node);
     if (!feed)
         return;
-    
+
     if ( d->handlers.contains( feed ) )
         return;
-    
+
     d->handlers[feed] = new ProgressItemHandler(feed);
     connect(feed, SIGNAL(signalDestroyed(Akregator::TreeNode*)), this, SLOT(slotNodeDestroyed(Akregator::TreeNode*)));
 }
@@ -140,7 +138,7 @@
 {
     d->feed = feed;
     d->progressItem = 0;
-    
+
     connect(feed, SIGNAL(fetchStarted(Akregator::Feed*)), this, SLOT(slotFetchStarted()));
     connect(feed, SIGNAL(fetched(Akregator::Feed*)), this, SLOT(slotFetchCompleted()));
     connect(feed, SIGNAL(fetchError(Akregator::Feed*)), this, SLOT(slotFetchError()));
@@ -155,7 +153,7 @@
         d->progressItem = 0;
     }
 
-    delete d; 
+    delete d;
     d = 0;
 }
 
@@ -166,7 +164,7 @@
         d->progressItem->setComplete();
         d->progressItem = 0;
     }
-    
+
     d->progressItem = KPIM::ProgressManager::createProgressItem(KPIM::ProgressManager::getUniqueID(), d->feed->title(), QString(), true);
 
     connect(d->progressItem, SIGNAL(progressItemCanceled(KPIM::ProgressItem*)), d->feed, SLOT(slotAbortFetch()));
diff -Naur akregator-orig/src/progressmanager.h akregator/src/progressmanager.h
--- akregator-orig/src/progressmanager.h	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/progressmanager.h	2009-06-18 11:58:51.905745944 +0300
@@ -25,6 +25,10 @@
 #ifndef AKREGATOR_PROGRESSMANAGER_H
 #define AKREGATOR_PROGRESSMANAGER_H
 
+#include "feedlist.h"
+#include <QObject>
+#include <boost/shared_ptr.hpp>
+
 namespace Akregator
 {
 
@@ -38,14 +42,14 @@
 {
     Q_OBJECT
     public:
-        
+
         static ProgressManager* self();
 
         ProgressManager();
         ~ProgressManager();
 
         /** sets the feed list to be managed */
-        void setFeedList(FeedList* feedList);
+        void setFeedList( const boost::shared_ptr<FeedList>& feedList);
 
     protected slots:
 
@@ -57,7 +61,7 @@
 
         static ProgressManager* m_self;
 
-        class ProgressManagerPrivate; 
+        class ProgressManagerPrivate;
         ProgressManagerPrivate* d;
 };
 
@@ -77,7 +81,7 @@
         void slotFetchCompleted();
         void slotFetchAborted();
         void slotFetchError();
-        
+
     private:
         class ProgressItemHandlerPrivate;
         ProgressItemHandlerPrivate* d;
diff -Naur akregator-orig/src/searchbar.cpp akregator/src/searchbar.cpp
--- akregator-orig/src/searchbar.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/searchbar.cpp	2009-06-18 11:58:51.905745944 +0300
@@ -23,9 +23,9 @@
 */
 
 #include "akregatorconfig.h"
+#include "searchbar.h"
 #include "articlematcher.h"
 #include "article.h"
-#include "searchbar.h"
 
 #include <kcombobox.h>
 #include <kiconloader.h>
diff -Naur akregator-orig/src/selectioncontroller.cpp akregator/src/selectioncontroller.cpp
--- akregator-orig/src/selectioncontroller.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/selectioncontroller.cpp	2009-06-18 11:58:51.902621085 +0300
@@ -26,6 +26,7 @@
 
 #include "actionmanager.h"
 #include "article.h"
+#include "articlejobs.h"
 #include "articlemodel.h"
 #include "feedlist.h"
 #include "subscriptionlistmodel.h"
@@ -38,20 +39,21 @@
 #include <QMenu>
 #include <QTimer>
 
+using namespace boost;
 using namespace Akregator;
 
 namespace {
-    static Akregator::Article articleForIndex( const QModelIndex& index, Akregator::FeedList* feedList )
+    static Akregator::Article articleForIndex( const QModelIndex& index, FeedList* feedList )
     {
         if ( !index.isValid() )
             return Akregator::Article();
 
-        const QString guid = index.data( Akregator::ArticleModel::GuidRole ).toString();
-        const QString feedId = index.data( Akregator::ArticleModel::FeedIdRole ).toString();
+        const QString guid = index.data( ArticleModel::GuidRole ).toString();
+        const QString feedId = index.data( ArticleModel::FeedIdRole ).toString();
         return feedList->findArticle( feedId, guid );
     }
 
-    static QList<Akregator::Article> articlesForIndexes( const QModelIndexList& indexes, Akregator::FeedList* feedList )
+    static QList<Akregator::Article> articlesForIndexes( const QModelIndexList& indexes, FeedList* feedList )
     {
         QList<Akregator::Article> articles;
         Q_FOREACH ( const QModelIndex& i, indexes )
@@ -73,41 +75,57 @@
 
 Akregator::SelectionController::SelectionController( QObject* parent )
     : AbstractSelectionController( parent ),
-    m_feedList( 0 ),
-    m_feedSelector( 0 ),
+    m_feedList(),
+    m_feedSelector(),
     m_articleLister( 0 ),
     m_singleDisplay( 0 ),
-    m_subscriptionModel ( 0 ),
+    m_subscriptionModel ( new SubscriptionListModel( shared_ptr<FeedList>(), this ) ),
     m_folderExpansionHandler( 0 ),
     m_articleModel( 0 ),
-    m_selectedSubscription( 0 )
+    m_selectedSubscription()
 {
-    m_articleFetchTimer = new QTimer( this );
-    connect( m_articleFetchTimer, SIGNAL( timeout() ),
-             this, SLOT( articleHeadersAvailable() ) );
-
 }
 
 
 void Akregator::SelectionController::setFeedSelector( QAbstractItemView* feedSelector )
 {
-    if ( m_feedSelector )
-    {
-        m_feedSelector->disconnect( this );
+    if ( m_feedSelector == feedSelector )
+        return;
 
-        if ( m_feedSelector->selectionModel() )
-            m_feedSelector->selectionModel()->disconnect( this );
+    if ( m_feedSelector ) {
+        m_feedSelector->disconnect( this );
+        m_feedSelector->selectionModel()->disconnect( this );
     }
+
     m_feedSelector = feedSelector;
-    setUp();
+
+    if ( !m_feedSelector )
+        return;
+
+    m_feedSelector->setModel( m_subscriptionModel );
+
+    connect( m_feedSelector, SIGNAL(customContextMenuRequested(QPoint)),
+             this, SLOT(subscriptionContextMenuRequested(QPoint)) );
+    connect( m_feedSelector->selectionModel(), SIGNAL(currentChanged(QModelIndex,QModelIndex)),
+             this, SLOT(selectedSubscriptionChanged(QModelIndex)) );
+
 }
 
 void Akregator::SelectionController::setArticleLister( Akregator::ArticleLister* lister )
 {
+    if ( m_articleLister == lister )
+        return;
+
     if ( m_articleLister )
         m_articleLister->articleSelectionModel()->disconnect( this );
+    if ( m_articleLister && m_articleLister->itemView() )
+        m_articleLister->itemView()->disconnect( this );
+
     m_articleLister = lister;
-    setUp();
+
+    if ( m_articleLister && m_articleLister->itemView() )
+        connect( m_articleLister->itemView(), SIGNAL(doubleClicked(QModelIndex)),
+                 this, SLOT(articleIndexDoubleClicked(QModelIndex))  );
 }
 
 void Akregator::SelectionController::setSingleArticleDisplay( Akregator::SingleArticleDisplay* display )
@@ -117,81 +135,91 @@
 
 Akregator::Article Akregator::SelectionController::currentArticle() const
 {
-    return ::articleForIndex( m_articleLister->articleSelectionModel()->currentIndex(), m_feedList );
+    return ::articleForIndex( m_articleLister->articleSelectionModel()->currentIndex(), m_feedList.get() );
 }
 
 QList<Akregator::Article> Akregator::SelectionController::selectedArticles() const
 {
-    return ::articlesForIndexes( m_articleLister->articleSelectionModel()->selectedRows(), m_feedList );
+    return ::articlesForIndexes( m_articleLister->articleSelectionModel()->selectedRows(), m_feedList.get() );
 }
 
 Akregator::TreeNode* Akregator::SelectionController::selectedSubscription() const
 {
-    return ::subscriptionForIndex( m_feedSelector->selectionModel()->currentIndex(), m_feedList );
+    return ::subscriptionForIndex( m_feedSelector->selectionModel()->currentIndex(), m_feedList.get() );
 }
 
-void Akregator::SelectionController::setFeedList( Akregator::FeedList* list )
+void Akregator::SelectionController::setFeedList( const shared_ptr<FeedList>& list )
 {
+    if ( m_feedList == list )
+        return;
+
     m_feedList = list;
-    setUp();
+    std::auto_ptr<SubscriptionListModel> oldModel( m_subscriptionModel );
+    m_subscriptionModel = new SubscriptionListModel( m_feedList, this );
+
+    if ( m_folderExpansionHandler ) {
+        m_folderExpansionHandler->setFeedList( m_feedList );
+        m_folderExpansionHandler->setModel( m_subscriptionModel );
+    }
+
+    if ( m_feedSelector ) {
+        m_feedSelector->setModel( m_subscriptionModel );
+        disconnect( m_feedSelector->selectionModel(), SIGNAL(currentChanged(QModelIndex,QModelIndex)),
+                    this, SLOT(selectedSubscriptionChanged(QModelIndex)) );
+        connect( m_feedSelector->selectionModel(), SIGNAL(currentChanged(QModelIndex,QModelIndex)),
+                 this, SLOT(selectedSubscriptionChanged(QModelIndex)) );
+    }
 }
 
 void Akregator::SelectionController::setFolderExpansionHandler( Akregator::FolderExpansionHandler* handler )
 {
+    if ( handler == m_folderExpansionHandler )
+        return;
     m_folderExpansionHandler = handler;
-    if ( !handler )
+    if ( !m_folderExpansionHandler )
         return;
     handler->setFeedList( m_feedList );
     handler->setModel( m_subscriptionModel );
 }
 
-void Akregator::SelectionController::setUp()
+void Akregator::SelectionController::articleHeadersAvailable( KJob* job )
 {
-    if ( !m_feedList || !m_feedSelector || !m_articleLister )
-        return;
+    assert( job );
+    assert( job == m_listJob );
 
-    m_subscriptionModel = new SubscriptionListModel( m_feedList, this );
-    if ( m_folderExpansionHandler )
-    {
-        m_folderExpansionHandler->setFeedList( m_feedList );
-        m_folderExpansionHandler->setModel( m_subscriptionModel );
+
+    if ( job->error() ) {
+        kWarning() << job->errorText();
+        return;
     }
-    m_feedSelector->setModel( m_subscriptionModel );
+    TreeNode* const node = m_listJob->node();
 
-    // setUp might be called more than once, so disconnect first
-    //connect exactly once:
-    disconnect( m_feedSelector->selectionModel(), SIGNAL( currentChanged( QModelIndex, QModelIndex ) ),
-             this, SLOT( selectedSubscriptionChanged( QModelIndex ) ) );
-    connect( m_feedSelector->selectionModel(), SIGNAL( currentChanged( QModelIndex, QModelIndex ) ),
-             this, SLOT( selectedSubscriptionChanged( QModelIndex ) ) );
-
-    //connect exactly once:
-    disconnect( m_feedSelector, SIGNAL( customContextMenuRequested( QPoint ) ),
-             this, SLOT( subscriptionContextMenuRequested( QPoint ) ) );
-    connect( m_feedSelector, SIGNAL( customContextMenuRequested( QPoint ) ),
-             this, SLOT( subscriptionContextMenuRequested( QPoint ) ) );
+    assert( node ); // if there was no error, the node must still exist
+    assert( node == m_selectedSubscription ); //...and equal the previously selected node
 
-    if ( m_articleLister->itemView() )
-    {
-        //connect exactly once:
-        disconnect( m_articleLister->itemView(), SIGNAL( doubleClicked( QModelIndex ) ), this, SLOT( articleIndexDoubleClicked( QModelIndex ) )  );
-        connect( m_articleLister->itemView(), SIGNAL( doubleClicked( QModelIndex ) ), this, SLOT( articleIndexDoubleClicked( QModelIndex ) )  );
-    }
-}
+    ArticleModel* const newModel = new ArticleModel( m_listJob->articles() );
 
-void Akregator::SelectionController::articleHeadersAvailable()
-{
-    ArticleModel* const newModel = new ArticleModel( m_selectedSubscription, this );
-    m_articleLister->setIsAggregation( m_selectedSubscription->isAggregation() );
+    connect( node, SIGNAL( destroyed() ),
+             newModel, SLOT( clear() ) );
+    connect( node, SIGNAL( signalArticlesAdded( Akregator::TreeNode*, QList<Akregator::Article> ) ),
+            newModel, SLOT( articlesAdded( Akregator::TreeNode*, QList<Akregator::Article> ) ) );
+    connect( node, SIGNAL( signalArticlesRemoved( Akregator::TreeNode*, QList<Akregator::Article> ) ),
+             newModel, SLOT( articlesRemoved( Akregator::TreeNode*, QList<Akregator::Article> ) ) );
+    connect( node, SIGNAL( signalArticlesUpdated( Akregator::TreeNode*, QList<Akregator::Article> ) ),
+             newModel, SLOT( articlesUpdated( Akregator::TreeNode*, QList<Akregator::Article> ) ) );
+
+    m_articleLister->setIsAggregation( node->isAggregation() );
     m_articleLister->setArticleModel( newModel );
-    delete m_articleModel;
+    delete m_articleModel; //order is important: do not delete the old model before the new model is set in the view
     m_articleModel = newModel;
 
-    connect( m_articleLister->articleSelectionModel(), SIGNAL( selectionChanged( QItemSelection, QItemSelection ) ),
-             this, SLOT( articleSelectionChanged() ) );
+    disconnect( m_articleLister->articleSelectionModel(), SIGNAL(selectionChanged(QItemSelection, QItemSelection)),
+                this, SLOT(articleSelectionChanged()) );
+    connect( m_articleLister->articleSelectionModel(), SIGNAL(selectionChanged(QItemSelection, QItemSelection)),
+             this, SLOT(articleSelectionChanged()) );
 
-    if ( m_selectedSubscription )
-        m_articleLister->setScrollBarPositions( m_selectedSubscription->listViewScrollBarPositions() );
+    if ( node )
+        m_articleLister->setScrollBarPositions( node->listViewScrollBarPositions() );
 }
 
 
@@ -209,19 +237,23 @@
     // using a timer here internally to simulate async data fetching (which is still synchronous),
     // to ensure the UI copes with async behavior later on
 
-    if ( m_articleFetchTimer->isActive() )
-        m_articleFetchTimer->stop(); // to come: kill running list job
+    delete m_listJob;
+
+    if ( !m_selectedSubscription )
+        return;
 
-    m_articleFetchTimer->setInterval( KRandom::random() % 400 );
-    m_articleFetchTimer->setSingleShot( true );
-    m_articleFetchTimer->start();
+    ArticleListJob* const job( new ArticleListJob( m_selectedSubscription ) );
+    connect( job, SIGNAL(finished(KJob*)),
+             this, SLOT(articleHeadersAvailable(KJob*)) );
+    m_listJob = job;
+    m_listJob->start();
 
 }
 
 void Akregator::SelectionController::subscriptionContextMenuRequested( const QPoint& point )
 {
     Q_ASSERT( m_feedSelector );
-    const TreeNode* const node = ::subscriptionForIndex( m_feedSelector->indexAt( point ), m_feedList );
+    const TreeNode* const node = ::subscriptionForIndex( m_feedSelector->indexAt( point ), m_feedList.get() );
     if ( !node )
         return;
 
@@ -244,7 +276,7 @@
 
 void Akregator::SelectionController::articleIndexDoubleClicked( const QModelIndex& index )
 {
-    const Akregator::Article article = ::articleForIndex( index, m_feedList );
+    const Akregator::Article article = ::articleForIndex( index, m_feedList.get() );
     emit articleDoubleClicked( article );
 }
 
diff -Naur akregator-orig/src/selectioncontroller.h akregator/src/selectioncontroller.h
--- akregator-orig/src/selectioncontroller.h	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/selectioncontroller.h	2009-06-18 11:58:51.907746085 +0300
@@ -32,8 +32,12 @@
 class QPoint;
 class QTimer;
 
+class KJob;
+
 namespace Akregator {
 
+class ArticleListJob;
+
 class SelectionController : public AbstractSelectionController
 {
     Q_OBJECT
@@ -61,7 +65,7 @@
     Akregator::TreeNode* selectedSubscription() const;
 
     //impl
-    void setFeedList( Akregator::FeedList* list );
+    void setFeedList( const boost::shared_ptr<FeedList>& list );
 
     //impl
     void setFolderExpansionHandler( Akregator::FolderExpansionHandler* handler );
@@ -74,29 +78,25 @@
     //impl
     void forceFilterUpdate();
 
-private:
-
-    void setUp();
-
 private Q_SLOTS:
 
     void selectedSubscriptionChanged( const QModelIndex& index );
     void articleSelectionChanged();
     void articleIndexDoubleClicked( const QModelIndex& index );
     void subscriptionContextMenuRequested( const QPoint& point );
-    void articleHeadersAvailable();
+    void articleHeadersAvailable(KJob*);
 
 private:
 
-    Akregator::FeedList* m_feedList;
-    QAbstractItemView* m_feedSelector;
+    boost::shared_ptr<FeedList> m_feedList;
+    QPointer<QAbstractItemView> m_feedSelector;
     Akregator::ArticleLister* m_articleLister;
     Akregator::SingleArticleDisplay* m_singleDisplay;
     Akregator::SubscriptionListModel* m_subscriptionModel;
     Akregator::FolderExpansionHandler* m_folderExpansionHandler;
     Akregator::ArticleModel* m_articleModel;
     QPointer<TreeNode> m_selectedSubscription;
-    QTimer* m_articleFetchTimer;
+    QPointer<ArticleListJob> m_listJob;
 };
 
 } // namespace Akregator
diff -Naur akregator-orig/src/speechclient.cpp akregator/src/speechclient.cpp
--- akregator-orig/src/speechclient.cpp	2008-03-06 11:52:45.000000000 +0200
+++ akregator/src/speechclient.cpp	2009-06-18 11:58:51.904746253 +0300
@@ -2,6 +2,7 @@
     This file is part of Akregator.
 
     Copyright (C) 2005 Frank Osterfeld <osterfeld@kde.org>
+    Copyright (C) 2009 Laurent Montel <montel@kde.org>
 
     This program is free software; you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
@@ -22,11 +23,11 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "article.h"
 #include "speechclient.h"
+#include <kstandarddirs.h>
+#include "article.h"
 #include "utils.h"
 
-#include <dcopclient.h>
 #include <kcharsets.h>
 #include <klocale.h>
 #include <kdebug.h>
@@ -34,9 +35,10 @@
 #include <ktoolinvocation.h>
 #include <kservicetypetrader.h>
 
+#include "kspeechinterface.h"
 #include <QString>
-
-namespace Akregator 
+#include <kspeech.h>
+namespace Akregator
 {
 
 class SpeechClient::SpeechClientPrivate
@@ -59,7 +61,7 @@
 }
 
 
-SpeechClient::SpeechClient() : DCOPStub("kttsd", "KSpeech"), DCOPObject("akregatorpart_kspeechsink"), QObject(), d(new SpeechClientPrivate)
+SpeechClient::SpeechClient() : QObject(), m_kspeech( 0 ), d(new SpeechClientPrivate)
 {
     d->isTextSpeechInstalled = false;
     setupSpeechSystem();
@@ -73,10 +75,11 @@
 
 void SpeechClient::slotSpeak(const QString& text, const QString& language)
 {
-    if (!isTextToSpeechInstalled() || text.isEmpty())
-        return;
-    uint jobNum = setText(text, language);
-    startText(jobNum);
+  if ( !d->isTextSpeechInstalled )
+    setupSpeechSystem();
+  if ( text.isEmpty())
+    return;
+    uint jobNum = m_kspeech->say(text,0);
     d->pendingJobs.append(jobNum);
     if (d->pendingJobs.count() == 1)
     {
@@ -89,16 +92,18 @@
 {
     if (!isTextToSpeechInstalled() || article.isNull())
         return;
-    
+
     QString speakMe;
-    speakMe += KCharsets::resolveEntities(Utils::stripTags((article).title())) 
-    + ". . . . " 
+    speakMe += KCharsets::resolveEntities(Utils::stripTags((article).title()))
+    + ". . . . "
     + KCharsets::resolveEntities(Utils::stripTags((article).description()));
     slotSpeak(speakMe, "en");
 }
 
 void SpeechClient::slotSpeak(const QList<Article>& articles)
 {
+  qDebug()<<" SpeechClient::slotSpeak(const Articlessssssssssss& article) :"<<articles.isEmpty()<<" isTextToSpeechInstalled :"<<isTextToSpeechInstalled();
+
     if (!isTextToSpeechInstalled() || articles.isEmpty())
         return;
 
@@ -108,8 +113,8 @@
     {
         if (!speakMe.isEmpty())
             speakMe += ". . . . . . " + i18n("Next Article: ");
-        speakMe += KCharsets::resolveEntities(Utils::stripTags((*it).title())) 
-        + ". . . . " 
+        speakMe += KCharsets::resolveEntities(Utils::stripTags((*it).title()))
+        + ". . . . "
         + KCharsets::resolveEntities(Utils::stripTags((*it).description()));
     }
 
@@ -120,9 +125,9 @@
 {
     if (!d->pendingJobs.isEmpty())
     {
-        for (QList<uint>::ConstIterator it = d->pendingJobs.begin(); it != d->pendingJobs.end(); ++it)
+      for (QList<uint>::ConstIterator it = d->pendingJobs.constBegin(); it != d->pendingJobs.constEnd(); ++it)
         {
-            removeText(*it);
+          //removeText(*it);
         }
 
         d->pendingJobs.clear();
@@ -131,9 +136,9 @@
     }
 }
 
-ASYNC SpeechClient::textRemoved(const DCOPCString& /*appId*/, uint jobNum)
+void SpeechClient::textRemoved(const QString &appId, int jobNum, int state )
 {
-    kDebug() <<"SpeechClient::textRemoved() called";
+  if ( state == KSpeech::jsFinished || state == KSpeech::jsDeleted )
     if (d->pendingJobs.contains(jobNum))
     {
         d->pendingJobs.removeAll(jobNum);
@@ -152,50 +157,74 @@
 
 void SpeechClient::setupSpeechSystem()
 {
-    KService::List offers = KServiceTypeTrader::self()->query("DBUS/Text-to-Speech", "Name == 'KTTSD'");
-    if (offers.isEmpty())
+  if ( KStandardDirs::findExe( "kttsd" ).isEmpty() )
+  {
+    kDebug() <<"KTTSD not installed, disable support";
+    d->isTextSpeechInstalled = false;
+  }
+  else
+  {
+    if ( QDBusConnection::sessionBus().interface()->isServiceRegistered("org.kde.kttsd") )
     {
-        kDebug() <<"KTTSD not installed, disable support";
-        d->isTextSpeechInstalled = false;
+      d->isTextSpeechInstalled = true;
     }
     else
     {
-        DCOPClient* client = dcopClient();
-        //client->attach();
-        if (client->isApplicationRegistered("kttsd")) 
-        {
-            d->isTextSpeechInstalled = true;
-        }
-        else
-        {
-            QString error;
-            if (KToolInvocation::startServiceByDesktopName("kttsd", QStringList(), &error))
-            {
-                kDebug() <<"Starting KTTSD failed with message" << error;
-                d->isTextSpeechInstalled = false;
-            }
-            else
-            {
-                d->isTextSpeechInstalled = true;
-            }
-        }
+      QString error;
+
+      if (KToolInvocation::startServiceByDesktopName("kttsd", QString(), &error) != 0)
+      {
+        kDebug() <<"Starting KTTSD failed with message" << error;
+        d->isTextSpeechInstalled = false;
+      }
+      else
+      {
+        d->isTextSpeechInstalled = true;
+      }
     }
     if (d->isTextSpeechInstalled)
     {
+      if ( !m_kspeech )
+      {
+        m_kspeech = new org::kde::KSpeech("org.kde.kttsd", "/KSpeech", QDBusConnection::sessionBus());
+        m_kspeech->setParent(this);
+        m_kspeech->setApplicationName("Akregator Speech Text");
+        connect(m_kspeech, SIGNAL(jobStateChanged(const QString&, int, int)),
+                    this, SLOT(textRemoved(const QString&, int, int)));
+        connect( QDBusConnection::sessionBus().interface(), SIGNAL( serviceUnregistered( const QString & ) ), this, SLOT( slotServiceUnregistered( const QString & ) ) );
+        connect( QDBusConnection::sessionBus().interface(), SIGNAL( serviceOwnerChanged( const QString &, const QString &, const QString & ) ), this, SLOT( slotServiceOwnerChanged( const QString &, const QString &, const QString & ) ) );
 
-        bool c = connectDCOPSignal("kttsd", "KSpeech",
-                "textRemoved(QCString, uint)",
-                "textRemoved(QCString, uint)",
-                false);
-        if (!c)
-            kDebug() <<"SpeechClient::setupSpeechSystem(): connecting signals failed";
-        c = connectDCOPSignal("kttsd", "KSpeech",
-                "textFinished(QCString, uint)",
-                "textRemoved(QCString, uint)",
-                false);
+      }
     }
+  }
 }
 
+void SpeechClient::slotServiceUnregistered( const QString &service )
+{
+  if ( service == QLatin1String( "org.kde.kttsd" ) )
+  {
+    removeSpeech();
+  }
+
+}
+
+void SpeechClient::slotServiceOwnerChanged( const QString &service, const QString &, const QString &newOwner )
+{
+  if ( service == QLatin1String( "org.kde.kttsd" ) && newOwner.isEmpty() )
+  {
+    removeSpeech();
+  }
+}
+
+void SpeechClient::removeSpeech()
+{
+  d->isTextSpeechInstalled = false;
+  disconnect( QDBusConnection::sessionBus().interface(), 0, this, 0 );
+
+  delete m_kspeech;
+  m_kspeech = 0;
+
+}
 
 } // namespace Akregator
 
diff -Naur akregator-orig/src/speechclient.h akregator/src/speechclient.h
--- akregator-orig/src/speechclient.h	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/speechclient.h	2009-06-18 11:58:51.905745944 +0300
@@ -25,9 +25,7 @@
 #ifndef AKREGATOR_SPEECHCLIENT_H
 #define AKREGATOR_SPEECHCLIENT_H
 
-#include <kspeechsink.h>
-#include "kspeech_stub.h"
-
+#include "kspeechinterface.h"
 #include <QObject>
 
 class QString;
@@ -38,7 +36,7 @@
 
 class Article;
 
-class SpeechClient : public QObject, public KSpeech_stub, virtual public KSpeechSink
+class SpeechClient : public QObject
 {
 
     Q_OBJECT
@@ -55,9 +53,12 @@
         void slotSpeak(const Akregator::Article& article);
         void slotSpeak(const QList<Akregator::Article>& articles);
         void slotAbortJobs();
+        void textRemoved(const QString &appId, int jobNum, int state);
+  private slots:
+        void slotServiceUnregistered( const QString & );
+        void slotServiceOwnerChanged( const QString &, const QString &, const QString & );
+  signals:
 
-    signals:
-      
         /** emitted when the job queue was empty before and the first job was just queued */
         void signalJobsStarted();
 
@@ -70,14 +71,12 @@
 
         SpeechClient();
         void setupSpeechSystem();
-
-        ASYNC textRemoved(const DCOPCString& appId, uint jobNum);
-
+        void removeSpeech();
     private:
-     
+        org::kde::KSpeech *m_kspeech;
         class SpeechClientPrivate;
         SpeechClientPrivate* d;
-        
+
         static SpeechClient* m_self;
 };
 
diff -Naur akregator-orig/src/subscriptionlistdelegate.cpp akregator/src/subscriptionlistdelegate.cpp
--- akregator-orig/src/subscriptionlistdelegate.cpp	1970-01-01 02:00:00.000000000 +0200
+++ akregator/src/subscriptionlistdelegate.cpp	2009-06-18 11:58:51.906745945 +0300
@@ -0,0 +1,84 @@
+/*
+    This file is part of Akregator.
+
+    Copyright (C) 2007 Frank Osterfeld <frank.osterfeld@kdemail.net>
+    Copyright (C) 2009 Jonathan Marten <jjm@keelhaul.me.uk>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "subscriptionlistdelegate.h"
+#include "subscriptionlistmodel.h"
+
+#include <KDebug>
+#include <KGlobalSettings>
+#include <KIconTheme>
+
+using namespace Akregator;
+
+
+Akregator::SubscriptionListDelegate::SubscriptionListDelegate( QWidget *parent )
+    : QStyledItemDelegate( parent )
+{
+    connect( KGlobalSettings::self(), SIGNAL( appearanceChanged() ),
+             SLOT( recalculateRowHeight() ) );
+    recalculateRowHeight();
+}
+
+
+Akregator::SubscriptionListDelegate::~SubscriptionListDelegate()
+{
+}
+
+
+QSize Akregator::SubscriptionListDelegate::sizeHint( const QStyleOptionViewItem &option,
+                                                     const QModelIndex &index ) const
+{
+    QSize size = QStyledItemDelegate::sizeHint( option, index );
+    size.setHeight( qMax( size.height(), ( m_viewIconHeight + 2 ) ) );
+							// +2 for row top/bottom margin
+    return ( size );
+}
+
+
+void Akregator::SubscriptionListDelegate::paint( QPainter *painter,
+                                                 const QStyleOptionViewItem &option,
+                                                 const QModelIndex &index ) const
+{
+    QStyleOptionViewItem newOption = option;
+    if ( index.data( SubscriptionListModel::HasUnreadRole ).toBool() )
+    {							// feed has unread articles
+        newOption.font.setBold(true);
+    }
+
+    // No need to translate the painter here - the item is vertically centered
+    // within its sizeHint rectangle.
+    QStyledItemDelegate::paint( painter, newOption, index );
+}
+
+
+void Akregator::SubscriptionListDelegate::recalculateRowHeight()
+{
+    KIconTheme *iconTheme = KIconLoader::global()->theme();
+    m_viewIconHeight = ( iconTheme != NULL ) ? iconTheme->defaultSize( KIconLoader::Small ) : 0;
+    kDebug() << "icon height" << m_viewIconHeight;
+}
+
+
+#include "subscriptionlistdelegate.moc"
diff -Naur akregator-orig/src/subscriptionlistdelegate.h akregator/src/subscriptionlistdelegate.h
--- akregator-orig/src/subscriptionlistdelegate.h	1970-01-01 02:00:00.000000000 +0200
+++ akregator/src/subscriptionlistdelegate.h	2009-06-18 11:58:51.903746150 +0300
@@ -0,0 +1,60 @@
+/*
+    This file is part of Akregator.
+
+    Copyright (C) 2007 Frank Osterfeld <osterfeld@kde.org>
+    Copyright (C) 2009 Jonathan Marten <jjm@keelhaul.me.uk>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef AKREGATOR_SUBSCRIPTIONLISTDELEGATE_H
+#define AKREGATOR_SUBSCRIPTIONLISTDELEGATE_H
+
+#include <QStyledItemDelegate>
+
+namespace Akregator {
+
+
+class SubscriptionListDelegate : public QStyledItemDelegate
+{
+    Q_OBJECT
+
+public:
+    explicit SubscriptionListDelegate(QWidget *parent = 0);
+    ~SubscriptionListDelegate();
+
+protected:
+    QSize sizeHint( const QStyleOptionViewItem &option,
+                    const QModelIndex &index ) const;
+
+    void paint( QPainter *painter,
+                const QStyleOptionViewItem &option,
+                const QModelIndex &index ) const;
+
+private slots:
+    void recalculateRowHeight();
+
+private:
+    int m_viewIconHeight;
+};
+
+
+}
+
+#endif // AKREGATOR_SUBSCRIPTIONLISTDELEGATE_H
diff -Naur akregator-orig/src/subscriptionlistjobs.cpp akregator/src/subscriptionlistjobs.cpp
--- akregator-orig/src/subscriptionlistjobs.cpp	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/subscriptionlistjobs.cpp	2009-06-18 11:58:51.899620796 +0300
@@ -32,6 +32,7 @@
 
 #include <QTimer>
 
+using namespace boost;
 using namespace Akregator;
 
 MoveSubscriptionJob::MoveSubscriptionJob( QObject* parent ) : KJob( parent ), m_id( 0 ), m_destFolderId( 0 ), m_afterId( -1 ), m_feedList( Kernel::self()->feedList() )
@@ -57,10 +58,18 @@
 
 void MoveSubscriptionJob::doMove()
 {
-    TreeNode* const node = m_feedList->findByID( m_id );
-    Folder* const destFolder = qobject_cast<Folder*>( m_feedList->findByID( m_destFolderId ) );
-    TreeNode* const after = m_feedList->findByID( m_afterId );
-    
+    const shared_ptr<FeedList> feedList = m_feedList.lock();
+
+    if ( !feedList ) {
+        setErrorText( i18n( "Feed list was deleted" ) );
+        emitResult();
+        return;
+    }
+
+    TreeNode* const node = feedList->findByID( m_id );
+    Folder* const destFolder = qobject_cast<Folder*>( feedList->findByID( m_destFolderId ) );
+    TreeNode* const after = feedList->findByID( m_afterId );
+
     if ( !node || !destFolder )
     {
         setErrorText( i18n( "Node or destination folder not found" ) );
@@ -130,8 +139,9 @@
 
 void DeleteSubscriptionJob::doDelete()
 {
-    if ( m_id > 0 )
-        delete m_feedList->findByID( m_id );
+    const shared_ptr<FeedList> feedList = m_feedList.lock();
+    if ( m_id > 0 && feedList )
+        delete feedList->findByID( m_id );
     emitResult();
 }
 
diff -Naur akregator-orig/src/subscriptionlistjobs.h akregator/src/subscriptionlistjobs.h
--- akregator-orig/src/subscriptionlistjobs.h	2008-01-29 11:18:18.000000000 +0200
+++ akregator/src/subscriptionlistjobs.h	2009-06-18 11:58:51.899620796 +0300
@@ -27,6 +27,8 @@
 
 #include <KJob>
 
+#include <boost/weak_ptr.hpp>
+
 namespace Akregator {
 
 class FeedList;
@@ -38,20 +40,20 @@
     Q_OBJECT
 public:
     explicit MoveSubscriptionJob( QObject* parent = 0 );
-    
+
     void setSubscriptionId( int id );
     void setDestination( int folder, int afterChild );
-    
+
     void start();
-    
+
 private Q_SLOTS:
     void doMove();
-    
+
 private:
     int m_id;
     int m_destFolderId;
     int m_afterId;
-    FeedList* const m_feedList;
+    boost::weak_ptr<FeedList> m_feedList;
 };
 
 class RenameSubscriptionJob : public KJob
@@ -59,19 +61,19 @@
     Q_OBJECT
 public:
     explicit RenameSubscriptionJob( QObject* parent = 0 );
-    
+
     void setSubscriptionId( int id );
     void setName( const QString& name );
-    
+
     void start();
-    
+
 private Q_SLOTS:
     void doRename();
-    
+
 private:
     int m_id;
     QString m_name;
-    FeedList* const m_feedList;
+    boost::shared_ptr<FeedList> m_feedList;
 };
 
 class DeleteSubscriptionJob : public KJob
@@ -79,17 +81,17 @@
     Q_OBJECT
 public:
     explicit DeleteSubscriptionJob( QObject* parent = 0 );
-    
+
     void setSubscriptionId( int id );
-    
+
     void start();
-    
+
 private Q_SLOTS:
     void doDelete();
-    
+
 private:
     int m_id;
-    FeedList* const m_feedList;
+    boost::weak_ptr<FeedList> m_feedList;
 };
 
 }
diff -Naur akregator-orig/src/subscriptionlistmodel.cpp akregator/src/subscriptionlistmodel.cpp
--- akregator-orig/src/subscriptionlistmodel.cpp	2009-03-26 16:43:26.000000000 +0200
+++ akregator/src/subscriptionlistmodel.cpp	2009-06-18 11:58:51.904746253 +0300
@@ -30,7 +30,6 @@
 #include "treenode.h"
 
 #include <KDebug>
-#include <KGlobalSettings>
 #include <KIconLoader>
 #include <KLocalizedString>
 
@@ -45,6 +44,7 @@
 
 #include <cassert>
 
+using namespace boost;
 using namespace Akregator;
 using namespace Syndication;
 
@@ -53,7 +53,7 @@
 
 namespace {
 
-    QString errorCodeToString( Syndication::ErrorCode err )
+    static QString errorCodeToString( Syndication::ErrorCode err )
     {
         switch ( err )
         {
@@ -76,33 +76,30 @@
         }
     }
 
-    static const Akregator::TreeNode* nodeForIndex( const QModelIndex& index, const Akregator::FeedList* feedList )
+    static const Akregator::TreeNode* nodeForIndex( const QModelIndex& index, const FeedList* feedList )
     {
         return ( !index.isValid() || !feedList ) ? 0 : feedList->findByID( index.internalId() );
     }
 }
 
-Akregator::SubscriptionListModel::SubscriptionListModel( const Akregator::FeedList* feedList, QObject* parent ) : QAbstractItemModel( parent ), m_feedList( feedList ), m_beganRemoval( false )
+Akregator::SubscriptionListModel::SubscriptionListModel( const shared_ptr<const FeedList>& feedList, QObject* parent ) : QAbstractItemModel( parent ), m_feedList( feedList ), m_beganRemoval( false )
 {
-    if ( feedList )
-    {
-        connect( feedList, SIGNAL( signalDestroyed( Akregator::FeedList* ) ),
-                 this, SLOT( feedListDestroyed( Akregator::FeedList* ) ) );
-        connect( feedList, SIGNAL( signalNodeAdded( Akregator::TreeNode* ) ),
-                 this, SLOT( subscriptionAdded( Akregator::TreeNode* ) ) );
-        connect( feedList, SIGNAL( signalAboutToRemoveNode( Akregator::TreeNode* ) ),
-                 this, SLOT( aboutToRemoveSubscription( Akregator::TreeNode* ) ) );
-        connect( feedList, SIGNAL( signalNodeRemoved( Akregator::TreeNode* ) ),
-                   this, SLOT( subscriptionRemoved( Akregator::TreeNode* ) ) );
-        connect( feedList, SIGNAL( signalNodeChanged( Akregator::TreeNode* ) ),
-                 this, SLOT( subscriptionChanged( Akregator::TreeNode* ) ) );
-        connect( feedList, SIGNAL( fetchStarted( Akregator::Feed* ) ),
-                 this, SLOT( fetchStarted( Akregator::Feed* ) ) );
-        connect( feedList, SIGNAL( fetched( Akregator::Feed* ) ),
-                 this, SLOT( fetched( Akregator::Feed* ) ) );
-        connect( feedList, SIGNAL( fetchAborted( Akregator::Feed* ) ),
-                 this, SLOT( fetchAborted( Akregator::Feed* ) ) );
-    }
+    if ( !m_feedList )
+        return;
+    connect( m_feedList.get(), SIGNAL( signalNodeAdded( Akregator::TreeNode* ) ),
+             this, SLOT( subscriptionAdded( Akregator::TreeNode* ) ) );
+    connect( m_feedList.get(), SIGNAL( signalAboutToRemoveNode( Akregator::TreeNode* ) ),
+             this, SLOT( aboutToRemoveSubscription( Akregator::TreeNode* ) ) );
+    connect( m_feedList.get(), SIGNAL( signalNodeRemoved( Akregator::TreeNode* ) ),
+               this, SLOT( subscriptionRemoved( Akregator::TreeNode* ) ) );
+    connect( m_feedList.get(), SIGNAL( signalNodeChanged( Akregator::TreeNode* ) ),
+             this, SLOT( subscriptionChanged( Akregator::TreeNode* ) ) );
+    connect( m_feedList.get(), SIGNAL( fetchStarted( Akregator::Feed* ) ),
+             this, SLOT( fetchStarted( Akregator::Feed* ) ) );
+    connect( m_feedList.get(), SIGNAL( fetched( Akregator::Feed* ) ),
+             this, SLOT( fetched( Akregator::Feed* ) ) );
+    connect( m_feedList.get(), SIGNAL( fetchAborted( Akregator::Feed* ) ),
+             this, SLOT( fetchAborted( Akregator::Feed* ) ) );
 }
 
 int Akregator::SubscriptionListModel::columnCount( const QModelIndex& ) const
@@ -115,7 +112,7 @@
     if ( !parent.isValid() )
         return 1;
 
-    const Akregator::TreeNode* const node = nodeForIndex( parent, m_feedList );
+    const Akregator::TreeNode* const node = nodeForIndex( parent, m_feedList.get() );
     return node ? node->children().count() : 0;
 }
 
@@ -129,7 +126,7 @@
     if ( !index.isValid() )
         return QVariant();
 
-    const Akregator::TreeNode* const node = nodeForIndex( index, m_feedList );
+    const Akregator::TreeNode* const node = nodeForIndex( index, m_feedList.get() );
 
     if ( !node )
         return QVariant();
@@ -149,13 +146,6 @@
                     return node->totalCount();
             }
         }
-        case Qt::FontRole:
-        {
-            QFont font = KGlobalSettings::generalFont();
-            if( node->unread() > 0 )
-                font.setBold( true );
-            return font;
-        }
         case Qt::ToolTipRole:
         {
             if ( node->isGroup() || node->isAggregation() )
@@ -203,6 +193,10 @@
             Q_ASSERT( folder );
             return folder->isOpen();
         }
+        case HasUnreadRole:
+        {
+            return node->unread()>0;
+        }
     }
 
     return QVariant();
@@ -228,7 +222,7 @@
 
 QModelIndex Akregator::SubscriptionListModel::parent( const QModelIndex& index ) const
 {
-    const Akregator::TreeNode* const node = nodeForIndex( index, m_feedList );
+    const Akregator::TreeNode* const node = nodeForIndex( index, m_feedList.get() );
 
     if ( !node || !node->parent() )
         return QModelIndex();
@@ -250,9 +244,9 @@
 QModelIndex Akregator::SubscriptionListModel::index( int row, int column, const QModelIndex& parent ) const
 {
     if ( !parent.isValid() )
-        return ( row == 0 && m_feedList ) ? createIndex( row, column , m_feedList->rootNode()->id() ) : QModelIndex();
+        return ( row == 0 && m_feedList ) ? createIndex( row, column , m_feedList->allFeedsFolder()->id() ) : QModelIndex();
 
-    const Akregator::TreeNode* const parentNode = nodeForIndex( parent, m_feedList );
+    const Akregator::TreeNode* const parentNode = nodeForIndex( parent, m_feedList.get() );
     const Akregator::TreeNode* const childNode = parentNode->childAt( row );
     return  childNode ? createIndex( row, column, childNode->id() ) : QModelIndex();
 }
@@ -272,11 +266,6 @@
     return idx;
 }
 
-void Akregator::SubscriptionListModel::feedListDestroyed( Akregator::FeedList* )
-{
-    m_feedList = 0;
-}
-
 void Akregator::SubscriptionListModel::subscriptionAdded( Akregator::TreeNode* subscription )
 {
     const Folder* const parent = subscription->parent();
@@ -360,16 +349,16 @@
     folder->setOpen( expanded );
 }
 
-Akregator::FolderExpansionHandler::FolderExpansionHandler( QObject* parent ) : QObject( parent ), m_feedList( 0 ), m_model( 0 )
+FolderExpansionHandler::FolderExpansionHandler( QObject* parent ) : QObject( parent ), m_feedList(), m_model( 0 )
 {
 }
 
-void Akregator::FolderExpansionHandler::setModel( Akregator::SubscriptionListModel* model )
+void FolderExpansionHandler::setModel( Akregator::SubscriptionListModel* model )
 {
     m_model = model;
 }
 
-void Akregator::FolderExpansionHandler::setFeedList( Akregator::FeedList* feedList )
+void FolderExpansionHandler::setFeedList( const shared_ptr<FeedList>& feedList )
 {
     m_feedList = feedList;
 }
@@ -421,7 +410,7 @@
 {
     if ( !idx.isValid() || idx.column() != TitleColumn || role != Qt::EditRole )
         return false;
-    const TreeNode* const node = nodeForIndex( idx, m_feedList );
+    const TreeNode* const node = nodeForIndex( idx, m_feedList.get() );
     if ( !node )
         return false;
     RenameSubscriptionJob* job = new RenameSubscriptionJob( this );
@@ -437,57 +426,58 @@
                                           int column,
                                           const QModelIndex& parent )
 {
+    Q_UNUSED( column )
+
     if ( action == Qt::IgnoreAction )
         return true;
 
     //if ( column != TitleColumn )
     //    return false;
 
-    if ( data->hasFormat( AKREGATOR_TREENODE_MIMETYPE ) )
-    {
-        const TreeNode* const droppedOnNode = qobject_cast<const TreeNode*>( nodeForIndex( parent, m_feedList ) );
+    if ( !data->hasFormat( AKREGATOR_TREENODE_MIMETYPE ) )
+        return false;
 
-        if ( !droppedOnNode )
-            return false;
+    const TreeNode* const droppedOnNode = qobject_cast<const TreeNode*>( nodeForIndex( parent, m_feedList.get() ) );
 
-        const Folder* const destFolder = droppedOnNode->isGroup() ? qobject_cast<const Folder*>( droppedOnNode ) : droppedOnNode->parent();
-        if ( !destFolder )
-            return false;
+    if ( !droppedOnNode )
+        return false;
 
-        QByteArray idData = data->data( AKREGATOR_TREENODE_MIMETYPE );
-        QList<int> ids;
-        QDataStream stream( &idData, QIODevice::ReadOnly );
-        while ( !stream.atEnd() )
-        {
-            int id;
-            stream >> id;
-            ids << id;
-        }
+    const Folder* const destFolder = droppedOnNode->isGroup() ? qobject_cast<const Folder*>( droppedOnNode ) : droppedOnNode->parent();
+    if ( !destFolder )
+        return false;
 
-        //don't drop nodes into their own subtree
-        Q_FOREACH ( const int id, ids )
-        {
-            const Folder* const asFolder = qobject_cast<const Folder*>( m_feedList->findByID( id ) );
-            if ( asFolder && ( asFolder == destFolder || asFolder->subtreeContains( destFolder ) ) )
-                return false;
-        }
+    QByteArray idData = data->data( AKREGATOR_TREENODE_MIMETYPE );
+    QList<int> ids;
+    QDataStream stream( &idData, QIODevice::ReadOnly );
+    while ( !stream.atEnd() )
+    {
+        int id;
+        stream >> id;
+        ids << id;
+    }
+
+    //don't drop nodes into their own subtree
+    Q_FOREACH ( const int id, ids )
+    {
+        const Folder* const asFolder = qobject_cast<const Folder*>( m_feedList->findByID( id ) );
+        if ( asFolder && ( asFolder == destFolder || asFolder->subtreeContains( destFolder ) ) )
+            return false;
+    }
 
-        const TreeNode* const after = droppedOnNode->isGroup() ? destFolder->childAt( row ) : droppedOnNode;
+    const TreeNode* const after = droppedOnNode->isGroup() ? destFolder->childAt( row ) : droppedOnNode;
 
-        Q_FOREACH ( const int id, ids )
-        {
-            const TreeNode* const node = m_feedList->findByID( id );
-            if ( !node )
-                continue;
-            MoveSubscriptionJob* job = new MoveSubscriptionJob( this );
-            job->setSubscriptionId( node->id() );
-            job->setDestination( destFolder->id(), after ? after->id() : -1 );
-            job->start();
-        }
-        return true;
+    Q_FOREACH ( const int id, ids )
+    {
+        const TreeNode* const node = m_feedList->findByID( id );
+        if ( !node )
+            continue;
+        MoveSubscriptionJob* job = new MoveSubscriptionJob( this );
+        job->setSubscriptionId( node->id() );
+        job->setDestination( destFolder->id(), after ? after->id() : -1 );
+        job->start();
     }
 
-    return false;
+    return true;
 }
 
 #include "subscriptionlistmodel.moc"
diff -Naur akregator-orig/src/subscriptionlistmodel.h akregator/src/subscriptionlistmodel.h
--- akregator-orig/src/subscriptionlistmodel.h	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/subscriptionlistmodel.h	2009-06-18 11:58:51.907746085 +0300
@@ -28,6 +28,8 @@
 
 #include <QAbstractItemModel>
 
+#include <boost/shared_ptr.hpp>
+
 namespace Akregator {
 
 class Feed;
@@ -47,7 +49,8 @@
         IsAggregationRole,
         LinkRole,
         IdRole,
-        IsOpenRole
+        IsOpenRole,
+        HasUnreadRole
     };
 
     enum Column {
@@ -57,7 +60,7 @@
         ColumnCount=3
     };
 
-    explicit SubscriptionListModel( const Akregator::FeedList* feedList, QObject* parent = 0 );
+    explicit SubscriptionListModel( const boost::shared_ptr<const FeedList>& feedList, QObject* parent = 0 );
 
     //impl
     int columnCount( const QModelIndex& parent = QModelIndex() ) const;
@@ -69,7 +72,7 @@
     QVariant data( const QModelIndex& index, int role = Qt::DisplayRole ) const;
 
     //impl
-    QModelIndex index( int row, int column, const QModelIndex& parent = QModelIndex() ) const; 
+    QModelIndex index( int row, int column, const QModelIndex& parent = QModelIndex() ) const;
 
     //impl
     QModelIndex parent( const QModelIndex& index ) const;
@@ -77,29 +80,27 @@
     //reimpl
     QVariant headerData( int section, Qt::Orientation orientation, int role=Qt::DisplayRole ) const;
 
-    //reimpl 
+    //reimpl
     Qt::ItemFlags flags( const QModelIndex& index ) const;
-    
+
     //reimpl
     QStringList mimeTypes() const;
-    
+
     //reimpl
     QMimeData* mimeData( const QModelIndexList& indexes ) const;
-    
+
     //reimpl
     bool dropMimeData( const QMimeData* data, Qt::DropAction action, int row, int column, const QModelIndex& parent );
-    
+
     //reimpl
     bool setData( const QModelIndex& idx, const QVariant& value, int role = Qt::EditRole );
-    
+
     uint nodeIdForIndex( const QModelIndex& index ) const;
 
 private:
     QModelIndex indexForNode( const TreeNode* node ) const;
-    
-private Q_SLOTS:
 
-    void feedListDestroyed( Akregator::FeedList* feedList );
+private Q_SLOTS:
 
     void subscriptionAdded( Akregator::TreeNode* );
 
@@ -120,7 +121,7 @@
 
 private:
 
-    const FeedList* m_feedList;
+    boost::shared_ptr<const FeedList> m_feedList;
     bool m_beganRemoval;
 };
 
@@ -137,7 +138,7 @@
 public:
     explicit FolderExpansionHandler( QObject* parent = 0 );
 
-    void setFeedList( Akregator::FeedList* feedList );
+    void setFeedList( const boost::shared_ptr<FeedList>& feedList );
     void setModel( Akregator::SubscriptionListModel* model );
 
 public Q_SLOTS:
@@ -148,8 +149,8 @@
     void setExpanded( const QModelIndex& index, bool expanded );
 
 private:
-    Akregator::FeedList* m_feedList;
-    Akregator::SubscriptionListModel* m_model;
+    boost::shared_ptr<FeedList> m_feedList;
+    SubscriptionListModel* m_model;
 };
 
 } // namespace Akregator
diff -Naur akregator-orig/src/subscriptionlistview.cpp akregator/src/subscriptionlistview.cpp
--- akregator-orig/src/subscriptionlistview.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/subscriptionlistview.cpp	2009-06-18 11:58:51.900620759 +0300
@@ -22,8 +22,9 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "subscriptionlistmodel.h"
 #include "subscriptionlistview.h"
+#include "subscriptionlistmodel.h"
+#include "subscriptionlistdelegate.h"
 #include "akregatorconfig.h"
 
 #include <QHeaderView>
@@ -134,6 +135,8 @@
     setDragDropMode( QAbstractItemView::DragDrop );
     setDropIndicatorShown( true );
     setAcceptDrops( true );
+    setUniformRowHeights( true );
+    setItemDelegate( new SubscriptionListDelegate( this ) );
     connect( header(), SIGNAL( customContextMenuRequested( const QPoint & ) ), this, SLOT( showHeaderMenu( const QPoint& ) ) );
 
     loadHeaderSettings();
@@ -216,6 +219,7 @@
 {
     const KConfigGroup conf( Settings::self()->config(), "General" );
     m_headerState = QByteArray::fromBase64( conf.readEntry( "SubscriptionListHeaders" ).toAscii() );
+    header()->restoreState( m_headerState );		// needed, even with Qt 4.5
 }
 
 void Akregator::SubscriptionListView::slotPrevFeed()
@@ -237,7 +241,6 @@
 {
     if ( !model() )
         return;
-    emit userActionTakingPlace();
     const QModelIndex current = currentIndex();
     QModelIndex next = nextFeedIndex( current );
     if ( !next.isValid() )
@@ -250,7 +253,6 @@
 {
     if ( !model() )
         return;
-    emit userActionTakingPlace();
     const QModelIndex current = currentIndex();
     QModelIndex prev = prevUnreadFeedIndex( current );
     if ( !prev.isValid() )
@@ -263,7 +265,6 @@
 {
     if ( !model() )
         return;
-    emit userActionTakingPlace();
     const QModelIndex current = currentIndex();
     QModelIndex next = nextUnreadFeedIndex( current );
     if ( !next.isValid() )
diff -Naur akregator-orig/src/subscriptionlistview.h akregator/src/subscriptionlistview.h
--- akregator-orig/src/subscriptionlistview.h	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/subscriptionlistview.h	2009-06-18 11:58:51.905745944 +0300
@@ -43,9 +43,9 @@
     ~SubscriptionListView();
 // the following is all transitional, for easier porting from the item-based views
 
-    void startNodeRenaming( Akregator::TreeNode* node );
+    void startNodeRenaming( TreeNode* node );
 
-    void ensureNodeVisible( Akregator::TreeNode* node );
+    void ensureNodeVisible( TreeNode* node );
 
     //override
     void setModel( QAbstractItemModel* model );
@@ -58,7 +58,7 @@
         TotalColumn=2
     };
 
-    
+
 public Q_SLOTS:
 
     void slotPrevFeed();
@@ -74,14 +74,11 @@
     void slotItemUp();
     void slotItemDown();
 
-Q_SIGNALS:
-    void userActionTakingPlace();
-    
 private:
     void saveHeaderSettings();
     void loadHeaderSettings();
 
-    
+
 private Q_SLOTS:
     void showHeaderMenu( const QPoint& pos );
     void headerMenuItemTriggered( QAction* action );
diff -Naur akregator-orig/src/tabwidget.cpp akregator/src/tabwidget.cpp
--- akregator-orig/src/tabwidget.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/tabwidget.cpp	2009-06-18 11:58:51.906745945 +0300
@@ -70,7 +70,6 @@
 public:
     explicit Private( TabWidget * qq ) : q( qq ), currentMaxLength( 30 ), currentItem( 0 ) {}
 
-    TabWidget* parent;
     QHash<QWidget*, Frame*> frames;
     QHash<int, Frame*> framesById;
     int currentMaxLength;
@@ -89,13 +88,12 @@
 
 void TabWidget::Private::updateTabBarVisibility()
 {
-    q->setTabBarHidden( q->count() <= 1 );
+    q->setTabBarHidden( ( q->count() <= 1 ) && !Settings::alwaysShowTabBar() );
 }
 
 TabWidget::TabWidget(QWidget * parent)
     :KTabWidget(parent), d(new Private( this ) )
 {
-    d->parent = this;
     setMinimumSize(250,150);
     setTabReorderingEnabled(false);
     connect( this, SIGNAL( currentChanged(int) ),
@@ -103,7 +101,7 @@
     connect(this, SIGNAL(closeRequest(QWidget*)),
             this, SLOT(slotCloseRequest(QWidget*)));
     setCloseButtonEnabled(Settings::closeButtonOnTabs());
-    
+
     d->tabsClose = new QToolButton(this);
     connect( d->tabsClose, SIGNAL( clicked() ), this,
             SLOT( slotRemoveCurrentFrame() ) );
@@ -113,7 +111,7 @@
     d->tabsClose->adjustSize();
     d->tabsClose->setToolTip( i18n("Close the current tab"));
     setCornerWidget( d->tabsClose, Qt::TopRightCorner );
-    setTabBarHidden( true );
+    d->updateTabBarVisibility();
 }
 
 TabWidget::~TabWidget()
@@ -123,8 +121,9 @@
 
 void TabWidget::slotSettingsChanged()
 {
-    if (hoverCloseButton() != Settings::closeButtonOnTabs())
-        setHoverCloseButton(Settings::closeButtonOnTabs());
+    if (tabsClosable() != Settings::closeButtonOnTabs())
+        setTabsClosable(Settings::closeButtonOnTabs());
+    d->updateTabBarVisibility();
 }
 
 void TabWidget::slotNextTab()
@@ -161,7 +160,7 @@
     if (!frame)
         return;
     d->frames.insert(frame, frame);
-    d->framesById[frame->id()] = frame;
+    d->framesById.insert( frame->id(), frame );
     addTab(frame, frame->title());
     connect(frame, SIGNAL(signalTitleChanged(Akregator::Frame*,QString)),
             this, SLOT(slotSetTitle(Akregator::Frame*,QString)));
@@ -176,14 +175,14 @@
 Frame * TabWidget::Private::currentFrame()
 {
     QWidget* w = q->currentWidget();
-    assert( frames[w] );
-    return w ? frames[w] : 0;
+    assert( frames.value( w ) );
+    return w ? frames.value(w) : 0;
 }
 
 void TabWidget::slotTabChanged(int index)
 {
-    
-    Frame* frame = d->frames[widget(index)];
+
+    Frame* frame = d->frames.value(widget(index));
     d->tabsClose->setEnabled(frame && frame->isRemovable());
     emit signalCurrentFrameChanged(frame ? frame->id() : -1);
 }
@@ -225,25 +224,25 @@
 {
     int hframe, overlap;
     QStyleOption o;
-    hframe = parent->tabBar()->style()->pixelMetric( QStyle::PM_TabBarTabHSpace, &o, parent );
-    overlap = parent->tabBar()->style()->pixelMetric( QStyle::PM_TabBarTabOverlap, &o, parent );
+    hframe = q->tabBar()->style()->pixelMetric( QStyle::PM_TabBarTabHSpace, &o, q );
+    overlap = q->tabBar()->style()->pixelMetric( QStyle::PM_TabBarTabOverlap, &o, q );
 
-    QFontMetrics fm = parent->tabBar()->fontMetrics();
+    QFontMetrics fm = q->tabBar()->fontMetrics();
     int x = 0;
-    for (int i = 0; i < parent->count(); ++i)
+    for (int i = 0; i < q->count(); ++i)
     {
-        Frame* f = frames[parent->widget(i)];
+        Frame* f = frames.value(q->widget(i));
         QString newTitle = f->title();
         if ( newTitle.length() > maxLength )
             newTitle = newTitle.left( maxLength-3 ) + "...";
 
         int lw = fm.width( newTitle );
-        int iw = parent->tabBar()->tabIcon( i ).pixmap( parent->tabBar()->style()->pixelMetric(
+        int iw = q->tabBar()->tabIcon( i ).pixmap( q->tabBar()->style()->pixelMetric(
 QStyle::PM_SmallIconSize ), QIcon::Normal
 ).width() + 4;
 
-        x += ( parent->tabBar()->style()->sizeFromContents( QStyle::CT_TabBarTab, &o,
-               QSize( qMax( lw + hframe + iw, QApplication::globalStrut().width() ), 0 ), parent ) ).width();
+        x += ( q->tabBar()->style()->sizeFromContents( QStyle::CT_TabBarTab, &o,
+               QSize( qMax( lw + hframe + iw, QApplication::globalStrut().width() ), 0 ), q ) ).width();
     }
     return x;
 }
@@ -263,23 +262,23 @@
 
 void TabWidget::Private::setTitle( const QString &title, QWidget* sender)
 {
-    int senderIndex = parent->indexOf(sender);
+    int senderIndex = q->indexOf(sender);
 
-    parent->setTabToolTip( senderIndex, QString() );
+    q->setTabToolTip( senderIndex, QString() );
 
     uint lcw=0, rcw=0;
-    int tabBarHeight = parent->tabBar()->sizeHint().height();
+    int tabBarHeight = q->tabBar()->sizeHint().height();
 
-    QWidget* leftCorner = parent->cornerWidget( Qt::TopLeftCorner );
+    QWidget* leftCorner = q->cornerWidget( Qt::TopLeftCorner );
 
     if ( leftCorner  && leftCorner->isVisible() )
         lcw = qMax( leftCorner->width(), tabBarHeight );
 
-    QWidget* rightCorner = parent->cornerWidget( Qt::TopRightCorner );
+    QWidget* rightCorner = q->cornerWidget( Qt::TopRightCorner );
 
     if ( rightCorner && rightCorner->isVisible() )
         rcw = qMax( rightCorner->width(), tabBarHeight );
-    uint maxTabBarWidth = parent->width() - lcw - rcw;
+    uint maxTabBarWidth = q->width() - lcw - rcw;
 
     int newMaxLength = 30;
 
@@ -292,33 +291,33 @@
     QString newTitle = title;
     if ( newTitle.length() > newMaxLength )
     {
-        parent->setTabToolTip( senderIndex, newTitle );
+        q->setTabToolTip( senderIndex, newTitle );
         newTitle = newTitle.left( newMaxLength-3 ) + "...";
     }
 
     newTitle.replace( '&', "&&" );
 
-    if ( parent->tabText(senderIndex) != newTitle )
-        parent->setTabText( senderIndex, newTitle );
+    if ( q->tabText(senderIndex) != newTitle )
+        q->setTabText( senderIndex, newTitle );
 
     if( newMaxLength != currentMaxLength )
     {
-        for( int i = 0; i < parent->count(); ++i)
+        for( int i = 0; i < q->count(); ++i)
         {
-            Frame* f = frames[parent->widget(i)];
+            Frame* f = frames.value(q->widget(i));
             newTitle = f->title();
-            int index = parent->indexOf(parent->widget( i ));
-            parent->setTabToolTip( index, QString() );
+            int index = q->indexOf(q->widget( i ));
+            q->setTabToolTip( index, QString() );
 
             if ( newTitle.length() > newMaxLength )
             {
-                parent->setTabToolTip( index, newTitle );
+                q->setTabToolTip( index, newTitle );
                 newTitle = newTitle.left( newMaxLength-3 ) + "...";
             }
 
             newTitle.replace( '&', "&&" );
-            if ( newTitle != parent->tabText( index ) )
-                parent->setTabText( index, newTitle );
+            if ( newTitle != q->tabText( index ) )
+                q->setTabText( index, newTitle );
         }
         currentMaxLength = newMaxLength;
     }
@@ -327,7 +326,7 @@
 void TabWidget::contextMenu(int i, const QPoint &p)
 {
     QWidget* w = ActionManager::getInstance()->container("tab_popup");
-    TemporaryValue<QWidget*> tmp( d->currentItem, widget(i) );
+    TemporaryValue<QWidget*> tmp( d->currentItem, widget( i ) );
     //kDebug() << indexOf(d->currentItem);
     // FIXME: do not hardcode index of maintab
     if (w && indexOf(d->currentItem) != 0)
@@ -336,9 +335,7 @@
 
 void TabWidget::slotDetachTab()
 {
-    QWidget* widget = d->selectedWidget();
-
-    Frame* frame = d->frames.value(widget);
+    Frame* frame = d->frames.value( d->selectedWidget() );
 
     if (frame && frame->url().isValid() && frame->isRemovable())
     {
@@ -352,8 +349,7 @@
 
 void TabWidget::slotCopyLinkAddress()
 {
-    QWidget* widget = d->selectedWidget();
-    Frame* frame = d->frames.value(widget);
+    Frame* frame = d->frames.value( d->selectedWidget() );
 
     if (frame && frame->url().isValid())
     {
@@ -366,8 +362,8 @@
 
 void TabWidget::slotCloseTab()
 {
-    QWidget* widget = d->selectedWidget();
-    Frame* frame = d->frames.value(widget);
+    QWidget* widget =  d->selectedWidget();
+    Frame* frame = d->frames.value( widget );
 
     if (frame == 0 || !frame->isRemovable() )
         return;
@@ -377,7 +373,7 @@
 
 void TabWidget::initiateDrag(int tab)
 {
-    Frame* frame = d->frames[widget(tab)];
+    Frame* frame = d->frames.value(widget(tab));
 
     if (frame && frame->url().isValid())
     {
@@ -394,8 +390,8 @@
 
 void TabWidget::slotCloseRequest(QWidget* widget)
 {
-    if (d->frames[widget])
-        emit signalRemoveFrameRequest(d->frames[widget]->id());
+    if (d->frames.value(widget))
+        emit signalRemoveFrameRequest(d->frames.value(widget)->id());
 }
 
 } // namespace Akregator
diff -Naur akregator-orig/src/trayicon.cpp akregator/src/trayicon.cpp
--- akregator-orig/src/trayicon.cpp	2009-05-28 22:22:07.000000000 +0300
+++ akregator/src/trayicon.cpp	2009-06-18 11:58:51.899620796 +0300
@@ -37,10 +37,7 @@
 
 #include <QPainter>
 #include <QBitmap>
-
-#ifdef Q_WS_X11
-#include <QX11Info>
-#endif
+#include <QDesktopWidget>
 
 
 namespace Akregator {
@@ -70,14 +67,14 @@
 TrayIcon::~TrayIcon()
 {}
 
-#if 0
 QPixmap TrayIcon::takeScreenshot() const
 {
-    QPoint g = mapToGlobal(pos());
+    const QRect rect = geometry();
+    const QPoint g = rect.topLeft();
     int desktopWidth  = kapp->desktop()->width();
     int desktopHeight = kapp->desktop()->height();
-    int tw = width();
-    int th = height();
+    int tw = rect.width();
+    int th = rect.height();
     int w = desktopWidth / 4;
     int h = desktopHeight / 9;
     int x = g.x() + tw/2 - w/2; // Center the rectange in the systray icon
@@ -92,9 +89,9 @@
         y = desktopHeight - h;
 
         // Grab the desktop and draw a circle around the icon:
-#ifdef Q_WS_X11
-    QPixmap shot = QPixmap::grabWindow(QX11Info::appRootWindow(), x, y, w, h);
+    QPixmap shot = QPixmap::grabWindow(QApplication::desktop()->winId(), x, y, w, h);
     QPainter painter(&shot);
+    painter.setRenderHint( QPainter::Antialiasing );
     const int MARGINS = 6;
     const int WIDTH   = 3;
     int ax = g.x() - x - MARGINS -1;
@@ -111,11 +108,7 @@
     painter.drawPixmap(BORDER, BORDER, shot);
     painter.end();
     return shot; // not finalShot?? -fo
-#else
-    return QPixmap();
-#endif
 }
-#endif
 
 void TrayIcon::slotSetUnread(int unread)
 {
diff -Naur akregator-orig/src/trayicon.h akregator/src/trayicon.h
--- akregator-orig/src/trayicon.h	2009-04-30 12:12:22.000000000 +0300
+++ akregator/src/trayicon.h	2009-06-18 11:58:51.905745944 +0300
@@ -44,7 +44,7 @@
         explicit TrayIcon(QWidget *parent = 0);
         ~TrayIcon();
 
-        //QPixmap takeScreenshot() const;
+        QPixmap takeScreenshot() const;
 
     public slots:
         void settingsChanged();
diff -Naur akregator-orig/src/treenode.cpp akregator/src/treenode.cpp
--- akregator-orig/src/treenode.cpp	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/treenode.cpp	2009-06-18 11:58:51.903746150 +0300
@@ -22,8 +22,9 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "folder.h"
 #include "treenode.h"
+#include "folder.h"
+#include "articlejobs.h"
 
 #include <QPoint>
 #include <QString>
@@ -158,11 +159,13 @@
 
 const TreeNode* TreeNode::childAt( int pos ) const
 {
+    Q_UNUSED( pos )
     return 0;
 }
 
 TreeNode* TreeNode::childAt( int pos )
 {
+    Q_UNUSED( pos )
     return 0;
 }
 
@@ -231,6 +234,10 @@
     d->scrollBarPositions = pos;
 }
 
+ArticleListJob* TreeNode::createListJob() {
+    return new ArticleListJob( this );
+}
+
 } // namespace Akregator
 
 #include "treenode.moc"
diff -Naur akregator-orig/src/treenode.h akregator/src/treenode.h
--- akregator-orig/src/treenode.h	2008-10-30 16:16:13.000000000 +0200
+++ akregator/src/treenode.h	2009-06-18 11:58:51.898620837 +0300
@@ -43,6 +43,7 @@
 {
 
 class ArticleDeleteJob;
+class ArticleListJob;
 class TreeNodeVisitor;
 class Article;
 class Feed;
@@ -57,6 +58,9 @@
 */
 class AKREGATORPART_EXPORT TreeNode : public QObject
 {
+    friend class ::Akregator::ArticleListJob;
+    friend class ::Akregator::Folder;
+
 Q_OBJECT
 
 public:
@@ -137,11 +141,7 @@
 
     virtual QIcon icon() const = 0;
 
-    /** Returns a sequence of the articles this node contains. For feed groups, this returns a concatenated list of all articles in the sub tree.
-    If @c tag is not null, only articles tagged with @c tag are returned
-    @return sequence of articles */
-
-    virtual QList<Article> articles() = 0;
+    ArticleListJob* createListJob();
 
     /** Helps the rest of the app to decide if node should be handled as group or not. Only use where necessary, use polymorphism where possible.
     @return whether the node is a feed group or not */
@@ -231,6 +231,12 @@
     void emitSignalDestroyed();
 
 private:
+    /** Returns a sequence of the articles this node contains. For feed groups, this returns a concatenated list of all articles in the sub tree.
+    @return sequence of articles */
+
+    virtual QList<Article> articles() = 0;
+
+private:
     class TreeNodePrivate;
     TreeNodePrivate* d;
 };
diff -Naur akregator-orig/src/treenodevisitor.cpp akregator/src/treenodevisitor.cpp
--- akregator-orig/src/treenodevisitor.cpp	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/treenodevisitor.cpp	2009-06-18 11:58:51.899620796 +0300
@@ -22,8 +22,8 @@
     without including the source code for Qt in the source distribution.
 */
 
-#include "treenode.h"
 #include "treenodevisitor.h"
+#include "treenode.h"
 
 namespace Akregator {
 
diff -Naur akregator-orig/src/utils/filtercolumnsproxymodel.cpp akregator/src/utils/filtercolumnsproxymodel.cpp
--- akregator-orig/src/utils/filtercolumnsproxymodel.cpp	2008-02-13 17:45:36.000000000 +0200
+++ akregator/src/utils/filtercolumnsproxymodel.cpp	2009-06-18 11:58:51.906745945 +0300
@@ -67,4 +67,3 @@
     m_mode = mode;
 }
 
-#include "filtercolumnsproxymodel.moc"
